{
  "cobol_format": {
    "allow_source_format_directive": false,
    "comment": {
      "column": 7,
      "prefix": "*"
    },
    "indent_spaces": 7,
    "line_format": "fixed",
    "literal_quotes": "single",
    "max_line_length": 72,
    "paragraph_terminator": "."
  },
  "diagramme": {
    "parsed": true,
    "source": "erDiagram\n  ANTENNE {\n    INT ANTENNE_ID PK\n    VARCHAR ANTENNE_NOM\n    VARCHAR ANTENNE_REGION\n  }\n  UTILISATEUR {\n    INT USER_ID PK\n    VARCHAR USER_NOM\n    VARCHAR USER_MAIL\n    VARCHAR USER_PASS\n    VARCHAR USER_ROLE\n    INT USER_ID_ANTENNE FK\n    BIGINT USER_LAST_LOGIN\n  }\n  ACTIVITE {\n    INT ACTIVITE_ID PK\n    VARCHAR ACTIVITE_NOM\n    VARCHAR ACTIVITE_TYPE\n    INT ACTIVITE_IDANTENNE FK\n    INT ACTIVITE_ANIMATEUR FK\n    INT ACTIVITE_NBPARTICIPANTS\n    INT ACTIVITE_MODETRANSPORT\n    VARCHAR ACTIVITE_LIEU\n    INT ACTIVITE_DISTANCE\n    INT ACTIVITE_HEBERGEMENT\n    INT ACTIVITE_REPASPREVU\n    DECIMAL ACTIVITE_EMPREINTETOTALE\n  }\n  REPAS {\n    INT REPAS_ID PK\n    INT REPAS_ID_ACTIVITE FK\n    INT REPAS_TYPE\n    INT REPAS_NBREPAS\n  }\n  HEBERGEMENT {\n    INT HEBERGEMENT_ID PK\n    INT HEBERGEMENT_ID_ACTIVITE FK\n    INT HEBERGEMENT_TYPE\n    INT HEBERGEMENT_NBNUIT\n  }\n  PARTICIPATION {\n    INT PARTICIPATION_ID_ACTIVITE PK\n    INT PARTICIPATION_ID_USER PK\n    INT PARTICIPATION_MODE_TRANSPORT\n  }\n  ANTENNE ||--o{ UTILISATEUR : \"rattache\"\n  ANTENNE ||--o{ ACTIVITE : \"organise\"\n  UTILISATEUR ||--o{ ACTIVITE : \"anime\"\n  ACTIVITE ||--o{ REPAS : \"repas\"\n  ACTIVITE ||--o{ HEBERGEMENT : \"hebergement\"\n  UTILISATEUR ||--o{ PARTICIPATION : \"participe\"\n  ACTIVITE ||--o{ PARTICIPATION : \"participe\"\n",
    "type": "mermaid"
  },
  "dialecte_cobol": "gnucobol",
  "exigences": [
    {
      "id": "R1",
      "normalized": {
        "affects_entities": [],
        "layer": "logic",
        "priority": 5
      },
      "notes": "Aucun doublon d email n est autorise en base.",
      "regle": "Un utilisateur est identifie de maniere unique par son email.",
      "type": "regle_metier"
    },
    {
      "id": "R2",
      "normalized": {
        "affects_entities": [],
        "layer": "logic",
        "priority": 5
      },
      "regle": "Une activite appartient a une seule antenne et possede un animateur.",
      "type": "regle_metier"
    },
    {
      "id": "R3",
      "normalized": {
        "affects_entities": [
          "ID_ACTIVITE",
          "ID_USER"
        ],
        "layer": "logic",
        "priority": 5
      },
      "regle": "Une participation est definie par le couple (ID_ACTIVITE, ID_USER).",
      "type": "regle_metier"
    },
    {
      "id": "R4",
      "normalized": {
        "affects_entities": [
          "SQL",
          "OCESQL",
          "COBOL"
        ],
        "layer": "logic",
        "priority": 5
      },
      "regle": "Toutes les operations BD sont realisees en COBOL embarque SQL PostgreSQL (OCESQL).",
      "type": "technique"
    },
    {
      "id": "R5",
      "normalized": {
        "affects_entities": [
          "SQL"
        ],
        "layer": "logic",
        "priority": 5
      },
      "regle": "Toute erreur SQL doit etre remontee par un code retour negatif.",
      "type": "validation"
    }
  ],
  "fonctionnalites": [
    {
      "id": "F1",
      "normalized": {
        "components": [],
        "scope": "module"
      },
      "resume": "Gerer les utilisateurs de l application CarbonTrack (creation, lecture, mise a jour, suppression)."
    },
    {
      "id": "F2",
      "normalized": {
        "components": [],
        "scope": "module"
      },
      "resume": "Gerer les antennes regionales et leur rattachement aux utilisateurs et activites."
    },
    {
      "id": "F3",
      "normalized": {
        "components": [],
        "scope": "module"
      },
      "resume": "Gerer les activites a impact carbone (transport, hebergement, repas)."
    },
    {
      "id": "F4",
      "normalized": {
        "components": [],
        "scope": "module"
      },
      "resume": "Gerer les participations des utilisateurs aux activites."
    },
    {
      "id": "F5",
      "normalized": {
        "components": [],
        "scope": "module"
      },
      "resume": "Permettre le stockage de l empreinte carbone par activite."
    }
  ],
  "fonctions": [
    {
      "description": "Connexion paresseuse a la base via OCESQL. Initialise les variables d environnement PostgreSQL, puis execute OCESQLStartSQL/OCESQLConnect/OCESQLEndSQL. Initialise les variables d environnement si besoin.",
      "entity": "ACTIVITE",
      "id": "FN-DAL-CONNECT",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-CONNECT",
      "outputs": [
        "SQLCODE",
        "SQLSTATE"
      ],
      "programme": "ACTIVITE-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "connection_calls": [
          "CALL \"OCESQLStartSQL\" END-CALL",
          "CALL \"OCESQLConnect\" USING BY REFERENCE SQLCA BY REFERENCE WS-DB-USER BY VALUE WS-DB-USER-LEN BY REFERENCE WS-DB-PASSWORD BY VALUE WS-DB-PASSWORD-LEN BY REFERENCE WS-DB-NAME BY VALUE WS-DB-NAME-LEN END-CALL",
          "CALL \"OCESQLEndSQL\" END-CALL"
        ],
        "connection_method": "OCESQL (voir sql.connection)"
      },
      "visibility": "internal"
    },
    {
      "description": "Force les variables d environnement PGHOST/PGPORT/PGUSER/PGPASSWORD/PGDATABASE.",
      "entity": "ACTIVITE",
      "id": "FN-DAL-SET-ENV",
      "inputs": [],
      "layer": "dal",
      "modifies": [],
      "name": "DAL-SET-ENV",
      "outputs": [],
      "programme": "ACTIVITE-DAL-DB",
      "related_exigences": [
        "R4"
      ],
      "required": true,
      "steps": [
        "DISPLAY WS-PGHOST-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGHOST-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPORT-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPORT-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGUSER-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGUSER-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPASSWORD-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPASSWORD-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGDATABASE-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGDATABASE-VALUE UPON ENVIRONMENT-VALUE"
      ],
      "visibility": "internal"
    },
    {
      "description": "Ouvre le curseur C_ACT si necessaire, fait un FETCH et remplit la structure ACTIVITE. Met END-OF-FILE a 'Y' en cas de fin de donnees ou d erreur.",
      "entity": "ACTIVITE",
      "eof_logic": {
        "eof_false_value": "N",
        "eof_flag_name": "LK-END-OF-FILE",
        "eof_true_value": "Y",
        "on_sqlcode_100_set_eof": true
      },
      "errors_flags": [
        "SQLCODE = 0 : succes, une ligne lue.",
        "SQLCODE = 100 : fin de curseur.",
        "SQLCODE != 0 et != 100 : erreur SQL, le batch s arrete logiquement."
      ],
      "id": "FN-DAL-READ",
      "inputs": [
        "OPERATION = 'READ'",
        "Connexion deja etablie par MAIN-ENTRY (sauf OPERATION='END ').",
        "Curseur non garanti ouvert (ouverture paresseuse)."
      ],
      "layer": "dal",
      "modifies": [
        "ACTIVITE.*",
        "END-OF-FILE",
        "WS-CONNECTED",
        "WS-CURSOR-OPEN",
        "SQLCODE"
      ],
      "name": "DAL-READ",
      "operation_code": "READ",
      "outputs": [
        "ACTIVITE.ACTIVITE_ID",
        "ACTIVITE.ACTIVITE_NOM",
        "ACTIVITE.ACTIVITE_TYPE",
        "ACTIVITE.ACTIVITE_IDANTENNE",
        "ACTIVITE.ACTIVITE_ANIMATEUR",
        "ACTIVITE.ACTIVITE_NBPARTICIPANTS",
        "ACTIVITE.ACTIVITE_MODETRANSPORT",
        "ACTIVITE.ACTIVITE_LIEU",
        "ACTIVITE.ACTIVITE_DISTANCE",
        "ACTIVITE.ACTIVITE_HEBERGEMENT",
        "ACTIVITE.ACTIVITE_REPASPREVU",
        "ACTIVITE.ACTIVITE_EMPREINTETOTALE",
        "ACTIVITE.ANTENNE_NOM",
        "ACTIVITE.ANTENNE_REGION",
        "ACTIVITE.USER_NOM",
        "ACTIVITE.USER_MAIL",
        "END-OF-FILE",
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : ACTIVITE contient un enregistrement valide et END-OF-FILE = 'N'.",
        "Si SQLCODE = 100 : fin de donnees, END-OF-FILE = 'Y'.",
        "Si SQLCODE != 0 et != 100 : message d erreur affiche et END-OF-FILE = 'Y'."
      ],
      "preconditions": [],
      "programme": "ACTIVITE-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "declare_cursor": "DECLARE C_ACT CURSOR FOR\nSELECT a.ACTIVITE_ID, a.ACTIVITE_NOM, a.ACTIVITE_TYPE,\n       a.ACTIVITE_IDANTENNE, a.ACTIVITE_ANIMATEUR,\n       a.ACTIVITE_NBPARTICIPANTS, a.ACTIVITE_MODETRANSPORT,\n       a.ACTIVITE_LIEU, a.ACTIVITE_DISTANCE, a.ACTIVITE_HEBERGEMENT,\n       a.ACTIVITE_REPASPREVU, a.ACTIVITE_EMPREINTETOTALE,\n       an.ANTENNE_NOM, an.ANTENNE_REGION,\n       u.USER_NOM, u.USER_MAIL\nFROM ACTIVITE a\nINNER JOIN ANTENNE an ON a.ACTIVITE_IDANTENNE = an.ANTENNE_ID\nINNER JOIN UTILISATEUR u ON a.ACTIVITE_ANIMATEUR = u.USER_ID\nORDER BY a.ACTIVITE_ID\n",
        "fetch_into": "FETCH C_ACT INTO :WS-ACTIVITE-ID, :WS-ACTIVITE-NOM, :WS-ACTIVITE-TYPE, :WS-ACTIVITE-IDANTENNE, :WS-ACTIVITE-ANIMATEUR, :WS-ACTIVITE-NBPART, :WS-ACTIVITE-TRANSPORT, :WS-ACTIVITE-LIEU, :WS-ACTIVITE-DISTANCE, :WS-ACTIVITE-HEBERG, :WS-ACTIVITE-REPAS, :WS-ACTIVITE-EMPREINTE, :WS-ANTENNE-NOM, :WS-ANTENNE-REGION, :WS-USER-NOM, :WS-USER-MAIL",
        "open_cursor": "OPEN C_ACT"
      },
      "sql_actions": [
        "declare_cursor",
        "open_cursor",
        "fetch_cursor",
        "check_sqlcode",
        "map_to_linkage",
        "set_eof"
      ],
      "steps": [
        "IF NOT WS-CURSOR-OPEN",
        "EXEC SQL DECLARE C_ACT CURSOR FOR",
        "SELECT a.ACTIVITE_ID, a.ACTIVITE_NOM, a.ACTIVITE_TYPE,",
        "a.ACTIVITE_IDANTENNE, a.ACTIVITE_ANIMATEUR,",
        "a.ACTIVITE_NBPARTICIPANTS, a.ACTIVITE_MODETRANSPORT,",
        "a.ACTIVITE_LIEU, a.ACTIVITE_DISTANCE, a.ACTIVITE_HEBERGEMENT,",
        "a.ACTIVITE_REPASPREVU, a.ACTIVITE_EMPREINTETOTALE,",
        "an.ANTENNE_NOM, an.ANTENNE_REGION,",
        "u.USER_NOM, u.USER_MAIL",
        "FROM ACTIVITE a",
        "INNER JOIN ANTENNE an ON a.ACTIVITE_IDANTENNE = an.ANTENNE_ID",
        "INNER JOIN UTILISATEUR u ON a.ACTIVITE_ANIMATEUR = u.USER_ID",
        "ORDER BY a.ACTIVITE_ID",
        "END-EXEC",
        "IF SQLCODE NOT EQUAL ZERO",
        "DISPLAY 'ERREUR DECLARE: SQLCODE=' SQLCODE",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "GOBACK",
        "END-IF",
        "EXEC SQL OPEN C_ACT END-EXEC",
        "IF SQLCODE NOT EQUAL ZERO",
        "DISPLAY 'ERREUR OPEN: SQLCODE=' SQLCODE",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "GOBACK",
        "END-IF",
        "MOVE 'Y' TO WS-CURSOR-OPEN-FLAG",
        "END-IF",
        "EXEC SQL FETCH C_ACT INTO",
        ":WS-ACTIVITE-ID, :WS-ACTIVITE-NOM, :WS-ACTIVITE-TYPE,",
        ":WS-ACTIVITE-IDANTENNE, :WS-ACTIVITE-ANIMATEUR, :WS-ACTIVITE-NBPART,",
        ":WS-ACTIVITE-TRANSPORT, :WS-ACTIVITE-LIEU, :WS-ACTIVITE-DISTANCE,",
        ":WS-ACTIVITE-HEBERG, :WS-ACTIVITE-REPAS, :WS-ACTIVITE-EMPREINTE,",
        ":WS-ANTENNE-NOM, :WS-ANTENNE-REGION, :WS-USER-NOM, :WS-USER-MAIL",
        "END-EXEC",
        "IF SQLCODE EQUAL 100 OR SQLCODE NOT EQUAL ZERO",
        "IF SQLCODE NOT EQUAL 100",
        "DISPLAY 'ERREUR FETCH: SQLCODE=' SQLCODE",
        "END-IF",
        "EXEC SQL CLOSE C_ACT END-EXEC",
        "MOVE 'N' TO WS-CURSOR-OPEN-FLAG",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "GOBACK",
        "END-IF",
        "MOVE WS-ACTIVITE-ID TO LK-ACTIVITE-ID OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-NOM TO LK-ACTIVITE-NOM OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-TYPE TO LK-ACTIVITE-TYPE OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-IDANTENNE TO LK-ACTIVITE-IDANTENNE OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-ANIMATEUR TO LK-ACTIVITE-ANIMATEUR OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-NBPART TO LK-ACTIVITE-NBPART OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-TRANSPORT TO LK-ACTIVITE-TRANSPORT OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-LIEU TO LK-ACTIVITE-LIEU OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-DISTANCE TO LK-ACTIVITE-DISTANCE OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-HEBERG TO LK-ACTIVITE-HEBERG OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-REPAS TO LK-ACTIVITE-REPAS OF LK-ACTIVITE",
        "MOVE WS-ACTIVITE-EMPREINTE TO LK-ACTIVITE-EMPREINTE OF LK-ACTIVITE",
        "MOVE WS-ANTENNE-NOM TO LK-ANTENNE-NOM OF LK-ACTIVITE",
        "MOVE WS-ANTENNE-REGION TO LK-ANTENNE-REGION OF LK-ACTIVITE",
        "MOVE WS-USER-NOM TO LK-USER-NOM OF LK-ACTIVITE",
        "MOVE WS-USER-MAIL TO LK-USER-MAIL OF LK-ACTIVITE"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Met a jour en base la colonne ACTIVITE_EMPREINTETOTALE pour l activite courante (ACTIVITE_ID) a partir de la structure ACTIVITE.",
      "entity": "ACTIVITE",
      "errors_flags": [
        "SQLCODE = 0 : succes.",
        "SQLCODE != 0 : erreur SQL, message affiche."
      ],
      "id": "FN-DAL-SAVE",
      "inputs": [
        "ACTIVITE.ACTIVITE_ID",
        "ACTIVITE.ACTIVITE_EMPREINTETOTALE"
      ],
      "layer": "dal",
      "modifies": [
        "SQLCODE"
      ],
      "name": "DAL-SAVE",
      "operation_code": "SAVE",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : la ligne ACTIVITE correspondante en base a ete mise a jour."
      ],
      "preconditions": [
        "ACTIVITE.ACTIVITE_ID contient un identifiant existant en base."
      ],
      "programme": "ACTIVITE-DAL-DB",
      "related_exigences": [
        "F5",
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "update_statement": "UPDATE ACTIVITE\nSET ACTIVITE_EMPREINTETOTALE = :WS-ACTIVITE-EMPREINTE\nWHERE ACTIVITE_ID = :WS-ACTIVITE-ID\n"
      },
      "steps": [
        "MOVE LK-ACTIVITE-ID TO WS-ACTIVITE-ID",
        "MOVE LK-ACTIVITE-EMPREINTE OF LK-ACTIVITE TO WS-ACTIVITE-EMPREINTE",
        "IF WS-ACTIVITE-ID IS NOT NUMERIC OR WS-ACTIVITE-ID = ZERO",
        "DISPLAY 'ERREUR: ACTIVITE-ID invalide'",
        "MOVE 16 TO SQLCODE",
        "GOBACK",
        "END-IF",
        "IF WS-ACTIVITE-EMPREINTE IS NOT NUMERIC",
        "DISPLAY 'ERREUR: ACTIVITE-EMPREINTETOTALE invalide'",
        "MOVE 16 TO SQLCODE",
        "GOBACK",
        "END-IF",
        "EXEC SQL",
        "UPDATE ACTIVITE",
        "SET ACTIVITE_EMPREINTETOTALE = :WS-ACTIVITE-EMPREINTE",
        "WHERE ACTIVITE_ID = :WS-ACTIVITE-ID",
        "END-EXEC",
        "EVALUATE SQLCODE",
        "WHEN 0",
        "CONTINUE",
        "WHEN OTHER",
        "DISPLAY 'ERREUR UPDATE: SQLCODE=' SQLCODE",
        "DISPLAY 'SQLSTATE=' SQLSTATE",
        "DISPLAY 'SQLERRMC=' SQLERRMC",
        "EXEC SQL ROLLBACK END-EXEC",
        "END-EVALUATE"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Ferme le curseur s il est ouvert, commit la transaction et ferme la connexion a la base. Appelee une fois en fin de traitement.",
      "entity": "ACTIVITE",
      "errors_flags": [
        "Les erreurs de CLOSE/COMMIT/DISCONNECT sont simplement affichees."
      ],
      "id": "FN-DAL-END",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CURSOR-OPEN",
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-END",
      "operation_code": "END ",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Curseur ferme si besoin.",
        "COMMIT effectue.",
        "Connexion base fermee."
      ],
      "preconditions": [],
      "programme": "ACTIVITE-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "close_cursor": "CLOSE C_ACT",
        "commit": "COMMIT",
        "disconnect": "DISCONNECT ALL"
      },
      "steps": [
        "IF WS-CURSOR-OPEN",
        "EXEC SQL CLOSE C_ACT END-EXEC",
        "MOVE 'N' TO WS-CURSOR-OPEN-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR CLOSE: SQLCODE=' SQLCODE",
        "END-IF",
        "END-IF",
        "EXEC SQL COMMIT END-EXEC",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR COMMIT: SQLCODE=' SQLCODE",
        "END-IF",
        "IF WS-CONNECTED",
        "EXEC SQL DISCONNECT ALL END-EXEC",
        "MOVE 'N' TO WS-CONNECTED-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR DISCONNECT: SQLCODE=' SQLCODE",
        "END-IF",
        "DISPLAY 'Fermeture connexion'",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "calls": [
        "ACTIVITE-DAL-DB avec OPERATION='READ'",
        "CALCULATE-EMPREINTE",
        "ACTIVITE-DAL-DB avec OPERATION='SAVE'",
        "ACTIVITE-BUSINESS.DISPLAY-ACTIVITE",
        "ACTIVITE-DAL-DB avec OPERATION='END '"
      ],
      "description": "Boucle principale du batch: lit les activites via la DAL, conserve l empreinte carbone, sauvegarde le resultat en base et affiche chaque activite.",
      "entity": "ACTIVITE",
      "id": "FN-LOGIC-MAIN",
      "inputs": [],
      "layer": "logic",
      "loop_control": {
        "eof_false_value": "N",
        "eof_flag_name": "END-OF-FILE",
        "eof_true_value": "Y"
      },
      "modifies": [
        "ACTIVITE.*",
        "END-OF-FILE",
        "WS-COUNT-TOTAL",
        "WS-COUNT-ERROR"
      ],
      "name": "MAIN-PROCESS",
      "outputs": [],
      "postconditions": [
        "Toutes les activites de la table ACTIVITE ont une empreinte carbone conservee."
      ],
      "preconditions": [],
      "programme": "ACTIVITE-LOGIC",
      "related_exigences": [
        "F3",
        "F4",
        "F5"
      ],
      "required": true,
      "steps": [
        "DISPLAY '=========================================='",
        "DISPLAY 'DEBUT TRAITEMENT BATCH ACTIVITES CARBONE'",
        "DISPLAY '=========================================='",
        "MOVE 'READ' TO OPERATION",
        "CALL 'ACTIVITE-DAL-DB' USING OPERATION END-OF-FILE ACTIVITE",
        "PERFORM UNTIL EOF-REACHED",
        "ADD 1 TO WS-COUNT-TOTAL",
        "PERFORM CALCULATE-EMPREINTE",
        "MOVE 'SAVE' TO OPERATION",
        "CALL 'ACTIVITE-DAL-DB' USING OPERATION END-OF-FILE ACTIVITE",
        "CALL 'ACTIVITE-BUSINESS' USING ACTIVITE",
        "MOVE 'READ' TO OPERATION",
        "CALL 'ACTIVITE-DAL-DB' USING OPERATION END-OF-FILE ACTIVITE",
        "END-PERFORM",
        "MOVE 'END ' TO OPERATION",
        "CALL 'ACTIVITE-DAL-DB' USING OPERATION END-OF-FILE ACTIVITE",
        "DISPLAY '=========================================='",
        "DISPLAY 'FIN TRAITEMENT BATCH ACTIVITES CARBONE'",
        "DISPLAY 'Nombre activites traitees: ' WS-COUNT-TOTAL",
        "DISPLAY 'Activites en erreur: ' WS-COUNT-ERROR",
        "DISPLAY '=========================================='",
        "STOP RUN"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Controle simple: si l empreinte carbone est negative, la remettre a zero.",
      "entity": "ACTIVITE",
      "errors_flags": [
        "Si ACTIVITE_EMPREINTETOTALE < 0 alors mise a 0 et compteur erreur incremente."
      ],
      "id": "FN-LOGIC-CALC",
      "inputs": [
        "ACTIVITE.ACTIVITE_EMPREINTETOTALE"
      ],
      "layer": "logic",
      "modifies": [
        "ACTIVITE.ACTIVITE_EMPREINTETOTALE",
        "WS-COUNT-ERROR"
      ],
      "name": "CALCULATE-EMPREINTE",
      "outputs": [
        "ACTIVITE.ACTIVITE_EMPREINTETOTALE"
      ],
      "postconditions": [
        "ACTIVITE.ACTIVITE_EMPREINTETOTALE >= 0."
      ],
      "preconditions": [
        "ACTIVITE.ACTIVITE_EMPREINTETOTALE contient une valeur numerique."
      ],
      "programme": "ACTIVITE-LOGIC",
      "related_exigences": [
        "F5"
      ],
      "required": true,
      "steps": [
        "Verifier si ACTIVITE-EMPREINTE (de l activite courante) est inferieure a zero.",
        "Si ACTIVITE-EMPREINTE est negative, la remettre a zero.",
        "Incrementer le compteur d erreurs WS-COUNT-ERROR.",
        {
          "Afficher le message d anomalie \"ANOMALIE": "Empreinte carbone invalide\"."
        },
        "Terminer le bloc de controle."
      ],
      "visibility": "public"
    },
    {
      "description": "Affiche les informations principales de l activite courante sur la console: antenne, animateur, lieu, empreinte.",
      "display": {
        "lines": [
          {
            "cobol_name": "LK-ACTIVITE-NOM",
            "field": "ACTIVITE.ACTIVITE_NOM",
            "label": "ACTIVITE : "
          },
          {
            "cobol_name": "LK-ACTIVITE-ID",
            "field": "ACTIVITE.ACTIVITE_ID",
            "label": "ID       : "
          },
          {
            "cobol_name": "LK-ACTIVITE-TYPE",
            "field": "ACTIVITE.ACTIVITE_TYPE",
            "label": "TYPE     : "
          },
          {
            "cobol_name": "LK-ANTENNE-NOM",
            "field": "ACTIVITE.ANTENNE_NOM",
            "label": "ANTENNE  : "
          },
          {
            "cobol_name": "LK-ANTENNE-REGION",
            "field": "ACTIVITE.ANTENNE_REGION",
            "label": "REGION   : "
          },
          {
            "cobol_name": "LK-USER-NOM",
            "field": "ACTIVITE.USER_NOM",
            "label": "ANIMATEUR: "
          },
          {
            "cobol_name": "LK-USER-MAIL",
            "field": "ACTIVITE.USER_MAIL",
            "label": "EMAIL    : "
          },
          {
            "cobol_name": "LK-ACTIVITE-LIEU",
            "field": "ACTIVITE.ACTIVITE_LIEU",
            "label": "LIEU     : "
          },
          {
            "cobol_name": "LK-ACTIVITE-DISTANCE",
            "field": "ACTIVITE.ACTIVITE_DISTANCE",
            "label": "DISTANCE : "
          },
          {
            "cobol_name": "LK-ACTIVITE-TRANSPORT",
            "field": "ACTIVITE.ACTIVITE_MODETRANSPORT",
            "label": "TRANSPORT: "
          },
          {
            "cobol_name": "LK-ACTIVITE-HEBERG",
            "field": "ACTIVITE.ACTIVITE_HEBERGEMENT",
            "label": "HEBERG.  : "
          },
          {
            "cobol_name": "LK-ACTIVITE-REPAS",
            "field": "ACTIVITE.ACTIVITE_REPASPREVU",
            "label": "REPAS    : "
          },
          {
            "cobol_name": "LK-ACTIVITE-EMPREINTE",
            "field": "ACTIVITE.ACTIVITE_EMPREINTETOTALE",
            "label": "EMPREINTE: "
          }
        ],
        "separator": "----------------------------------------"
      },
      "entity": "ACTIVITE",
      "errors_flags": [],
      "id": "FN-BIZ-DISPLAY",
      "inputs": [
        "ACTIVITE.ACTIVITE_NOM",
        "ACTIVITE.ACTIVITE_ID",
        "ACTIVITE.ACTIVITE_TYPE",
        "ACTIVITE.ANTENNE_NOM",
        "ACTIVITE.ANTENNE_REGION",
        "ACTIVITE.USER_NOM",
        "ACTIVITE.USER_MAIL",
        "ACTIVITE.ACTIVITE_LIEU",
        "ACTIVITE.ACTIVITE_DISTANCE",
        "ACTIVITE.ACTIVITE_MODETRANSPORT",
        "ACTIVITE.ACTIVITE_HEBERGEMENT",
        "ACTIVITE.ACTIVITE_REPASPREVU",
        "ACTIVITE.ACTIVITE_EMPREINTETOTALE"
      ],
      "layer": "business",
      "modifies": [],
      "name": "DISPLAY-ACTIVITE",
      "outputs": [],
      "postconditions": [],
      "preconditions": [
        "ACTIVITE contient des valeurs lues/calculees coherentes."
      ],
      "programme": "ACTIVITE-BUSINESS",
      "related_exigences": [
        "F3",
        "F5"
      ],
      "required": true,
      "steps": [
        "Afficher un separateur '----------------------------------------'.",
        "Afficher 'ACTIVITE : ' avec LK-ACTIVITE-NOM.",
        "Afficher 'ID       : ' avec LK-ACTIVITE-ID.",
        "Afficher 'TYPE     : ' avec LK-ACTIVITE-TYPE.",
        "Afficher 'ANTENNE  : ' avec LK-ANTENNE-NOM.",
        "Afficher 'REGION   : ' avec LK-ANTENNE-REGION.",
        "Afficher 'ANIMATEUR: ' avec LK-USER-NOM.",
        "Afficher 'EMAIL    : ' avec LK-USER-MAIL.",
        "Afficher 'LIEU     : ' avec LK-ACTIVITE-LIEU.",
        "Afficher 'DISTANCE : ' avec LK-ACTIVITE-DISTANCE.",
        "Afficher 'TRANSPORT: ' avec LK-ACTIVITE-TRANSPORT.",
        "Afficher 'HEBERG.  : ' avec LK-ACTIVITE-HEBERG.",
        "Afficher 'REPAS    : ' avec LK-ACTIVITE-REPAS.",
        "Afficher 'EMPREINTE: ' avec LK-ACTIVITE-EMPREINTE.",
        "Afficher le separateur '----------------------------------------'.",
        "Clore le paragraphe DISPLAY-ACTIVITE par GOBACK."
      ],
      "visibility": "public"
    },
    {
      "description": "Connexion paresseuse a la base via OCESQL. Initialise les variables d environnement PostgreSQL, puis execute OCESQLStartSQL/OCESQLConnect/OCESQLEndSQL. Initialise les variables d environnement si besoin.",
      "entity": "UTILISATEUR",
      "id": "FN-USER-DAL-CONNECT",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-CONNECT",
      "outputs": [
        "SQLCODE",
        "SQLSTATE"
      ],
      "programme": "UTILISATEUR-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "connection_calls": [
          "CALL \"OCESQLStartSQL\" END-CALL",
          "CALL \"OCESQLConnect\" USING BY REFERENCE SQLCA BY REFERENCE WS-DB-USER BY VALUE WS-DB-USER-LEN BY REFERENCE WS-DB-PASSWORD BY VALUE WS-DB-PASSWORD-LEN BY REFERENCE WS-DB-NAME BY VALUE WS-DB-NAME-LEN END-CALL",
          "CALL \"OCESQLEndSQL\" END-CALL"
        ],
        "connection_method": "OCESQL (voir sql.connection)"
      },
      "visibility": "internal"
    },
    {
      "description": "Force les variables d environnement PGHOST/PGPORT/PGUSER/PGPASSWORD/PGDATABASE.",
      "entity": "UTILISATEUR",
      "id": "FN-USER-DAL-SET-ENV",
      "inputs": [],
      "layer": "dal",
      "modifies": [],
      "name": "DAL-SET-ENV",
      "outputs": [],
      "programme": "UTILISATEUR-DAL-DB",
      "related_exigences": [
        "R4"
      ],
      "required": true,
      "steps": [
        "DISPLAY WS-PGHOST-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGHOST-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPORT-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPORT-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGUSER-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGUSER-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPASSWORD-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPASSWORD-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGDATABASE-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGDATABASE-VALUE UPON ENVIRONMENT-VALUE"
      ],
      "visibility": "internal"
    },
    {
      "description": "Ouvre le curseur C_USER si necessaire, fait un FETCH et remplit la structure UTILISATEUR. Met END-OF-FILE a 'Y' en cas de fin de donnees ou d erreur.",
      "entity": "UTILISATEUR",
      "eof_logic": {
        "eof_false_value": "N",
        "eof_flag_name": "LK-END-OF-FILE",
        "eof_true_value": "Y",
        "on_sqlcode_100_set_eof": true
      },
      "errors_flags": [
        "SQLCODE = 0 : succes, une ligne lue.",
        "SQLCODE = 100 : fin de curseur.",
        "SQLCODE != 0 et != 100 : erreur SQL, le batch s arrete logiquement."
      ],
      "id": "FN-USER-DAL-READ",
      "inputs": [
        "OPERATION = 'READ'",
        "Connexion deja etablie par MAIN-ENTRY (sauf OPERATION='END ').",
        "Curseur non garanti ouvert (ouverture paresseuse)."
      ],
      "layer": "dal",
      "modifies": [
        "UTILISATEUR.*",
        "END-OF-FILE",
        "WS-CONNECTED",
        "WS-CURSOR-OPEN",
        "SQLCODE"
      ],
      "name": "DAL-READ",
      "operation_code": "READ",
      "outputs": [
        "UTILISATEUR.USER_ID",
        "UTILISATEUR.USER_NOM",
        "UTILISATEUR.USER_MAIL",
        "UTILISATEUR.USER_PASS",
        "UTILISATEUR.USER_ROLE",
        "UTILISATEUR.USER_ID_ANTENNE",
        "UTILISATEUR.USER_LAST_LOGIN",
        "END-OF-FILE",
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : UTILISATEUR contient un enregistrement valide et END-OF-FILE = 'N'.",
        "Si SQLCODE = 100 : fin de donnees, END-OF-FILE = 'Y'.",
        "Si SQLCODE != 0 et != 100 : message d erreur affiche et END-OF-FILE = 'Y'."
      ],
      "preconditions": [],
      "programme": "UTILISATEUR-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "declare_cursor": "DECLARE C_USER CURSOR FOR\nSELECT USER_ID, USER_NOM, USER_MAIL, USER_PASS, USER_ROLE,\n       USER_ID_ANTENNE, USER_LAST_LOGIN\nFROM UTILISATEUR\nORDER BY USER_ID\n",
        "fetch_into": "FETCH C_USER INTO :WS-USER-ID, :WS-USER-NOM, :WS-USER-MAIL, :WS-USER-PASS, :WS-USER-ROLE, :WS-USER-ID-ANTENNE, :WS-USER-LAST-LOGIN",
        "open_cursor": "OPEN C_USER"
      },
      "sql_actions": [
        "declare_cursor",
        "open_cursor",
        "fetch_cursor",
        "check_sqlcode",
        "map_to_linkage",
        "set_eof"
      ],
      "steps": [
        "IF LK-OPERATION NOT EQUAL 'READ' GOBACK",
        "IF NOT WS-CONNECTED PERFORM DAL-CONNECT END-IF",
        "IF SQLCODE NOT EQUAL ZERO MOVE 'Y' TO LK-END-OF-FILE GOBACK END-IF",
        "IF NOT WS-CURSOR-OPEN",
        "EXEC SQL DECLARE C_USER CURSOR FOR",
        "SELECT USER_ID, USER_NOM, USER_MAIL, USER_PASS, USER_ROLE,",
        "USER_ID_ANTENNE, USER_LAST_LOGIN",
        "FROM UTILISATEUR",
        "ORDER BY USER_ID",
        "END-EXEC",
        "EXEC SQL OPEN C_USER END-EXEC",
        "IF SQLCODE NOT EQUAL ZERO",
        "DISPLAY 'ERREUR OPEN: SQLCODE=' SQLCODE",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "GOBACK",
        "END-IF",
        "MOVE 'Y' TO WS-CURSOR-OPEN-FLAG",
        "END-IF",
        "EXEC SQL FETCH C_USER INTO",
        ":WS-USER-ID, :WS-USER-NOM, :WS-USER-MAIL, :WS-USER-PASS,",
        ":WS-USER-ROLE, :WS-USER-ID-ANTENNE, :WS-USER-LAST-LOGIN",
        "END-EXEC",
        "EVALUATE SQLCODE",
        "WHEN ZERO",
        "MOVE WS-USER-ID TO USER-ID OF LK-UTILISATEUR",
        "MOVE WS-USER-NOM TO USER-NOM OF LK-UTILISATEUR",
        "MOVE WS-USER-MAIL TO USER-MAIL OF LK-UTILISATEUR",
        "MOVE WS-USER-PASS TO USER-PASS OF LK-UTILISATEUR",
        "MOVE WS-USER-ROLE TO USER-ROLE OF LK-UTILISATEUR",
        "MOVE WS-USER-ID-ANTENNE TO USER-ID-ANTENNE OF LK-UTILISATEUR",
        "MOVE WS-USER-LAST-LOGIN TO USER-LAST-LOGIN OF LK-UTILISATEUR",
        "MOVE 'N' TO LK-END-OF-FILE",
        "WHEN 100",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "WHEN OTHER",
        "DISPLAY 'ERREUR FETCH: SQLCODE=' SQLCODE",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "END-EVALUATE"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Met a jour en base la colonne USER_LAST_LOGIN pour l utilisateur courant (USER_ID).",
      "entity": "UTILISATEUR",
      "errors_flags": [
        "SQLCODE = 0 : succes.",
        "SQLCODE != 0 : erreur SQL, message affiche."
      ],
      "id": "FN-USER-DAL-SAVE",
      "inputs": [
        "UTILISATEUR.USER_ID",
        "UTILISATEUR.USER_LAST_LOGIN"
      ],
      "layer": "dal",
      "modifies": [
        "SQLCODE"
      ],
      "name": "DAL-SAVE",
      "operation_code": "SAVE",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : la ligne UTILISATEUR correspondante en base a ete mise a jour."
      ],
      "preconditions": [
        "UTILISATEUR.USER_ID contient un identifiant existant en base."
      ],
      "programme": "UTILISATEUR-DAL-DB",
      "related_exigences": [
        "F1",
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "update_statement": "UPDATE UTILISATEUR\nSET USER_LAST_LOGIN = :WS-USER-LAST-LOGIN\nWHERE USER_ID = :WS-USER-ID\n"
      },
      "steps": [
        "MOVE USER-ID OF LK-UTILISATEUR TO WS-USER-ID",
        "MOVE USER-LAST-LOGIN OF LK-UTILISATEUR TO WS-USER-LAST-LOGIN",
        "EXEC SQL",
        "UPDATE UTILISATEUR",
        "SET USER_LAST_LOGIN = :WS-USER-LAST-LOGIN",
        "WHERE USER_ID = :WS-USER-ID",
        "END-EXEC",
        "EVALUATE SQLCODE",
        "WHEN 0",
        "CONTINUE",
        "WHEN OTHER",
        "DISPLAY 'ERREUR UPDATE: SQLCODE=' SQLCODE",
        "DISPLAY 'SQLSTATE=' SQLSTATE",
        "DISPLAY 'SQLERRMC=' SQLERRMC",
        "EXEC SQL ROLLBACK END-EXEC",
        "END-EVALUATE"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Ferme le curseur s il est ouvert, commit la transaction et ferme la connexion a la base.",
      "entity": "UTILISATEUR",
      "errors_flags": [
        "Les erreurs de CLOSE/COMMIT/DISCONNECT sont simplement affichees."
      ],
      "id": "FN-USER-DAL-END",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CURSOR-OPEN",
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-END",
      "operation_code": "END ",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Curseur ferme si besoin.",
        "COMMIT effectue.",
        "Connexion base fermee."
      ],
      "preconditions": [],
      "programme": "UTILISATEUR-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "close_cursor": "CLOSE C_USER",
        "commit": "COMMIT",
        "disconnect": "DISCONNECT ALL"
      },
      "steps": [
        "IF WS-CURSOR-OPEN",
        "EXEC SQL CLOSE C_USER END-EXEC",
        "MOVE 'N' TO WS-CURSOR-OPEN-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR CLOSE: SQLCODE=' SQLCODE",
        "END-IF",
        "END-IF",
        "EXEC SQL COMMIT END-EXEC",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR COMMIT: SQLCODE=' SQLCODE",
        "END-IF",
        "IF WS-CONNECTED",
        "EXEC SQL DISCONNECT ALL END-EXEC",
        "MOVE 'N' TO WS-CONNECTED-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR DISCONNECT: SQLCODE=' SQLCODE",
        "END-IF",
        "DISPLAY 'Fermeture connexion'",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "calls": [
        "UTILISATEUR-DAL-DB avec OPERATION='READ'",
        "CALCULATE-LOGIN",
        "UTILISATEUR-DAL-DB avec OPERATION='SAVE'",
        "UTILISATEUR-BUSINESS.DISPLAY-UTILISATEUR",
        "UTILISATEUR-DAL-DB avec OPERATION='END '"
      ],
      "description": "Boucle principale du batch: lit les utilisateurs via la DAL, controle le dernier login, sauvegarde et affiche chaque utilisateur.",
      "entity": "UTILISATEUR",
      "id": "FN-USER-LOGIC-MAIN",
      "inputs": [],
      "layer": "logic",
      "loop_control": {
        "eof_false_value": "N",
        "eof_flag_name": "END-OF-FILE",
        "eof_true_value": "Y"
      },
      "modifies": [
        "UTILISATEUR.*",
        "END-OF-FILE",
        "WS-COUNT-TOTAL",
        "WS-COUNT-ERROR"
      ],
      "name": "MAIN-PROCESS",
      "outputs": [],
      "postconditions": [
        "Tous les utilisateurs ont un USER_LAST_LOGIN valide (>= 0)."
      ],
      "preconditions": [],
      "programme": "UTILISATEUR-LOGIC",
      "related_exigences": [
        "F1"
      ],
      "required": true,
      "steps": [
        "DISPLAY '=========================================='",
        "DISPLAY 'DEBUT TRAITEMENT BATCH UTILISATEURS'",
        "DISPLAY '=========================================='",
        "MOVE 'READ' TO OPERATION",
        "CALL 'UTILISATEUR-DAL-DB' USING OPERATION END-OF-FILE UTILISATEUR",
        "PERFORM UNTIL EOF-REACHED",
        "ADD 1 TO WS-COUNT-TOTAL",
        "PERFORM CALCULATE-LOGIN",
        "MOVE 'SAVE' TO OPERATION",
        "CALL 'UTILISATEUR-DAL-DB' USING OPERATION END-OF-FILE UTILISATEUR",
        "CALL 'UTILISATEUR-BUSINESS' USING UTILISATEUR",
        "MOVE 'READ' TO OPERATION",
        "CALL 'UTILISATEUR-DAL-DB' USING OPERATION END-OF-FILE UTILISATEUR",
        "END-PERFORM",
        "MOVE 'END ' TO OPERATION",
        "CALL 'UTILISATEUR-DAL-DB' USING OPERATION END-OF-FILE UTILISATEUR",
        "DISPLAY '=========================================='",
        "DISPLAY 'FIN TRAITEMENT BATCH UTILISATEURS'",
        "DISPLAY 'Nombre utilisateurs traites: ' WS-COUNT-TOTAL",
        "DISPLAY 'Utilisateurs en erreur: ' WS-COUNT-ERROR",
        "DISPLAY '=========================================='",
        "STOP RUN"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Controle simple: si USER_LAST_LOGIN est negatif, le remettre a zero et compter une anomalie.",
      "entity": "UTILISATEUR",
      "errors_flags": [
        "Si USER_LAST_LOGIN < 0 alors mise a 0 et compteur erreur incremente."
      ],
      "id": "FN-USER-LOGIC-CALC",
      "inputs": [
        "UTILISATEUR.USER_LAST_LOGIN"
      ],
      "layer": "logic",
      "modifies": [
        "UTILISATEUR.USER_LAST_LOGIN",
        "WS-COUNT-ERROR"
      ],
      "name": "CALCULATE-LOGIN",
      "outputs": [
        "UTILISATEUR.USER_LAST_LOGIN"
      ],
      "postconditions": [
        "UTILISATEUR.USER_LAST_LOGIN >= 0."
      ],
      "preconditions": [
        "UTILISATEUR.USER_LAST_LOGIN contient une valeur numerique."
      ],
      "programme": "UTILISATEUR-LOGIC",
      "related_exigences": [
        "F1"
      ],
      "required": true,
      "steps": [
        "IF USER-LAST-LOGIN OF UTILISATEUR < 0",
        "MOVE 0 TO USER-LAST-LOGIN OF UTILISATEUR",
        "ADD 1 TO WS-COUNT-ERROR",
        {
          "DISPLAY 'ANOMALIE": "Dernier login invalide'"
        },
        "END-IF"
      ],
      "visibility": "public"
    },
    {
      "description": "Affiche les informations principales de l utilisateur courant sur la console.",
      "display": {
        "lines": [
          {
            "cobol_name": "LK-USER-NOM",
            "field": "UTILISATEUR.USER_NOM",
            "label": "UTILISATEUR: "
          },
          {
            "cobol_name": "LK-USER-ID",
            "field": "UTILISATEUR.USER_ID",
            "label": "ID        : "
          },
          {
            "cobol_name": "LK-USER-MAIL",
            "field": "UTILISATEUR.USER_MAIL",
            "label": "EMAIL     : "
          },
          {
            "cobol_name": "LK-USER-ROLE",
            "field": "UTILISATEUR.USER_ROLE",
            "label": "ROLE      : "
          },
          {
            "cobol_name": "LK-USER-ID-ANTENNE",
            "field": "UTILISATEUR.USER_ID_ANTENNE",
            "label": "ANTENNE   : "
          },
          {
            "cobol_name": "LK-USER-LAST-LOGIN",
            "field": "UTILISATEUR.USER_LAST_LOGIN",
            "label": "LASTLOGIN : "
          }
        ],
        "separator": "----------------------------------------"
      },
      "entity": "UTILISATEUR",
      "errors_flags": [],
      "id": "FN-USER-BIZ-DISPLAY",
      "inputs": [
        "UTILISATEUR.USER_ID",
        "UTILISATEUR.USER_NOM",
        "UTILISATEUR.USER_MAIL",
        "UTILISATEUR.USER_ROLE",
        "UTILISATEUR.USER_ID_ANTENNE",
        "UTILISATEUR.USER_LAST_LOGIN"
      ],
      "layer": "business",
      "modifies": [],
      "name": "DISPLAY-UTILISATEUR",
      "outputs": [],
      "postconditions": [],
      "preconditions": [
        "UTILISATEUR contient des valeurs lues/calculees coherentes."
      ],
      "programme": "UTILISATEUR-BUSINESS",
      "related_exigences": [
        "F1"
      ],
      "required": true,
      "steps": [
        "DISPLAY '----------------------------------------'",
        "DISPLAY 'UTILISATEUR: ' USER-NOM OF LK-UTILISATEUR",
        "DISPLAY 'ID        : ' USER-ID OF LK-UTILISATEUR",
        "DISPLAY 'EMAIL     : ' USER-MAIL OF LK-UTILISATEUR",
        "DISPLAY 'ROLE      : ' USER-ROLE OF LK-UTILISATEUR",
        "DISPLAY 'ANTENNE   : ' USER-ID-ANTENNE OF LK-UTILISATEUR",
        "DISPLAY 'LASTLOGIN : ' USER-LAST-LOGIN OF LK-UTILISATEUR",
        "DISPLAY '----------------------------------------'",
        "GOBACK"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Connexion paresseuse a la base via OCESQL. Initialise les variables d environnement PostgreSQL, puis execute OCESQLStartSQL/OCESQLConnect/OCESQLEndSQL.",
      "entity": "ANTENNE",
      "id": "FN-ANT-DAL-CONNECT",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-CONNECT",
      "outputs": [
        "SQLCODE",
        "SQLSTATE"
      ],
      "programme": "ANTENNE-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "connection_calls": [
          "CALL \"OCESQLStartSQL\" END-CALL",
          "CALL \"OCESQLConnect\" USING BY REFERENCE SQLCA BY REFERENCE WS-DB-USER BY VALUE WS-DB-USER-LEN BY REFERENCE WS-DB-PASSWORD BY VALUE WS-DB-PASSWORD-LEN BY REFERENCE WS-DB-NAME BY VALUE WS-DB-NAME-LEN END-CALL",
          "CALL \"OCESQLEndSQL\" END-CALL"
        ],
        "connection_method": "OCESQL (voir sql.connection)"
      },
      "visibility": "internal"
    },
    {
      "description": "Force les variables d environnement PGHOST/PGPORT/PGUSER/PGPASSWORD/PGDATABASE.",
      "entity": "ANTENNE",
      "id": "FN-ANT-DAL-SET-ENV",
      "inputs": [],
      "layer": "dal",
      "modifies": [],
      "name": "DAL-SET-ENV",
      "outputs": [],
      "programme": "ANTENNE-DAL-DB",
      "related_exigences": [
        "R4"
      ],
      "required": true,
      "steps": [
        "DISPLAY WS-PGHOST-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGHOST-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPORT-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPORT-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGUSER-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGUSER-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPASSWORD-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPASSWORD-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGDATABASE-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGDATABASE-VALUE UPON ENVIRONMENT-VALUE"
      ],
      "visibility": "internal"
    },
    {
      "description": "Ouvre le curseur C_ANT si necessaire, fait un FETCH et remplit la structure ANTENNE. Met END-OF-FILE a 'Y' en cas de fin de donnees ou d erreur.",
      "entity": "ANTENNE",
      "eof_logic": {
        "eof_false_value": "N",
        "eof_flag_name": "LK-END-OF-FILE",
        "eof_true_value": "Y",
        "on_sqlcode_100_set_eof": true
      },
      "errors_flags": [
        "SQLCODE = 0 : succes, une ligne lue.",
        "SQLCODE = 100 : fin de curseur.",
        "SQLCODE != 0 et != 100 : erreur SQL, le batch s arrete logiquement."
      ],
      "id": "FN-ANT-DAL-READ",
      "inputs": [
        "OPERATION = 'READ'",
        "Connexion deja etablie par MAIN-ENTRY (sauf OPERATION='END ').",
        "Curseur non garanti ouvert (ouverture paresseuse)."
      ],
      "layer": "dal",
      "modifies": [
        "ANTENNE.*",
        "END-OF-FILE",
        "WS-CONNECTED",
        "WS-CURSOR-OPEN",
        "SQLCODE"
      ],
      "name": "DAL-READ",
      "operation_code": "READ",
      "outputs": [
        "ANTENNE.ANTENNE_ID",
        "ANTENNE.ANTENNE_NOM",
        "ANTENNE.ANTENNE_REGION",
        "END-OF-FILE",
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : ANTENNE contient un enregistrement valide et END-OF-FILE = 'N'.",
        "Si SQLCODE = 100 : fin de donnees, END-OF-FILE = 'Y'.",
        "Si SQLCODE != 0 et != 100 : message d erreur affiche et END-OF-FILE = 'Y'."
      ],
      "preconditions": [],
      "programme": "ANTENNE-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "declare_cursor": "DECLARE C_ANT CURSOR FOR\nSELECT ANTENNE_ID, ANTENNE_NOM, ANTENNE_REGION\nFROM ANTENNE\nORDER BY ANTENNE_ID\n",
        "fetch_into": "FETCH C_ANT INTO :WS-ANTENNE-ID, :WS-ANTENNE-NOM, :WS-ANTENNE-REGION",
        "open_cursor": "OPEN C_ANT"
      },
      "sql_actions": [
        "declare_cursor",
        "open_cursor",
        "fetch_cursor",
        "check_sqlcode",
        "map_to_linkage",
        "set_eof"
      ],
      "steps": [
        "EXEC SQL DECLARE C_ANT CURSOR FOR",
        "SELECT ANTENNE_ID, ANTENNE_NOM, ANTENNE_REGION",
        "FROM ANTENNE",
        "ORDER BY ANTENNE_ID",
        "END-EXEC",
        "IF NOT WS-CURSOR-OPEN",
        "EXEC SQL OPEN C_ANT END-EXEC",
        "IF SQLCODE NOT EQUAL ZERO",
        "DISPLAY 'ERREUR OPEN: SQLCODE=' SQLCODE",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "GOBACK",
        "END-IF",
        "SET WS-CURSOR-OPEN TO TRUE",
        "DISPLAY 'Curseur C_ANT ouvert'",
        "END-IF",
        "EXEC SQL FETCH C_ANT INTO",
        ":WS-ANTENNE-ID,",
        ":WS-ANTENNE-NOM,",
        ":WS-ANTENNE-REGION",
        "END-EXEC",
        "IF SQLCODE EQUAL 100 OR SQLCODE NOT EQUAL ZERO",
        "IF SQLCODE NOT EQUAL 100",
        "DISPLAY 'ERREUR FETCH: SQLCODE=' SQLCODE",
        "END-IF",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "GOBACK",
        "END-IF",
        "MOVE WS-ANTENNE-ID TO ANTENNE-ID OF LK-ANTENNE",
        "MOVE WS-ANTENNE-NOM TO ANTENNE-NOM OF LK-ANTENNE",
        "MOVE WS-ANTENNE-REGION TO ANTENNE-REGION OF LK-ANTENNE"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Met a jour en base la colonne ANTENNE_REGION pour l antenne courante (ANTENNE_ID).",
      "entity": "ANTENNE",
      "errors_flags": [
        "SQLCODE = 0 : succes.",
        "SQLCODE != 0 : erreur SQL, message affiche."
      ],
      "id": "FN-ANT-DAL-SAVE",
      "inputs": [
        "ANTENNE.ANTENNE_ID",
        "ANTENNE.ANTENNE_REGION"
      ],
      "layer": "dal",
      "modifies": [
        "SQLCODE"
      ],
      "name": "DAL-SAVE",
      "operation_code": "SAVE",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : la ligne ANTENNE correspondante en base a ete mise a jour."
      ],
      "preconditions": [
        "ANTENNE.ANTENNE_ID contient un identifiant existant en base."
      ],
      "programme": "ANTENNE-DAL-DB",
      "related_exigences": [
        "F2",
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "update_statement": "UPDATE ANTENNE\nSET ANTENNE_REGION = :WS-ANTENNE-REGION\nWHERE ANTENNE_ID = :WS-ANTENNE-ID\n"
      },
      "steps": [
        "MOVE ANTENNE-ID OF LK-ANTENNE TO WS-ANTENNE-ID",
        "MOVE ANTENNE-REGION OF LK-ANTENNE TO WS-ANTENNE-REGION",
        "EXEC SQL UPDATE ANTENNE",
        "SET ANTENNE_REGION = :WS-ANTENNE-REGION",
        "WHERE ANTENNE_ID = :WS-ANTENNE-ID",
        "END-EXEC",
        "EVALUATE SQLCODE",
        "WHEN 0",
        "CONTINUE",
        "WHEN OTHER",
        "DISPLAY 'ERREUR UPDATE: SQLCODE=' SQLCODE",
        "DISPLAY 'SQLSTATE=' SQLSTATE",
        "DISPLAY 'SQLERRMC=' SQLERRMC",
        "EXEC SQL ROLLBACK END-EXEC",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "END-EVALUATE"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Ferme le curseur s il est ouvert, commit la transaction et ferme la connexion a la base.",
      "entity": "ANTENNE",
      "errors_flags": [
        "Les erreurs de CLOSE/COMMIT/DISCONNECT sont simplement affichees."
      ],
      "id": "FN-ANT-DAL-END",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CURSOR-OPEN",
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-END",
      "operation_code": "END ",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Curseur ferme si besoin.",
        "COMMIT effectue.",
        "Connexion base fermee."
      ],
      "preconditions": [],
      "programme": "ANTENNE-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "close_cursor": "CLOSE C_ANT",
        "commit": "COMMIT",
        "disconnect": "DISCONNECT ALL"
      },
      "steps": [
        "IF WS-CURSOR-OPEN",
        "EXEC SQL CLOSE C_ANT END-EXEC",
        "MOVE 'N' TO WS-CURSOR-OPEN-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR CLOSE: SQLCODE=' SQLCODE",
        "END-IF",
        "END-IF",
        "EXEC SQL COMMIT END-EXEC",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR COMMIT: SQLCODE=' SQLCODE",
        "ELSE",
        "DISPLAY 'carbontrackdb'",
        "END-IF",
        "IF WS-CONNECTED",
        "EXEC SQL DISCONNECT ALL END-EXEC",
        "MOVE 'N' TO WS-CONNECTED-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR DISCONNECT: SQLCODE=' SQLCODE",
        "ELSE",
        "DISPLAY 'Fermeture connexion'",
        "END-IF",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "calls": [
        "ANTENNE-DAL-DB avec OPERATION='READ'",
        "NORMALIZE-REGION",
        "ANTENNE-DAL-DB avec OPERATION='SAVE'",
        "ANTENNE-BUSINESS.DISPLAY-ANTENNE",
        "ANTENNE-DAL-DB avec OPERATION='END '"
      ],
      "description": "Boucle principale du batch: lit les antennes via la DAL, normalise la region, sauvegarde et affiche chaque antenne.",
      "entity": "ANTENNE",
      "id": "FN-ANT-LOGIC-MAIN",
      "inputs": [],
      "layer": "logic",
      "loop_control": {
        "eof_false_value": "N",
        "eof_flag_name": "END-OF-FILE",
        "eof_true_value": "Y"
      },
      "modifies": [
        "ANTENNE.*",
        "END-OF-FILE",
        "WS-COUNT-TOTAL",
        "WS-COUNT-ERROR"
      ],
      "name": "MAIN-PROCESS",
      "outputs": [],
      "postconditions": [
        "Toutes les antennes ont une region non vide."
      ],
      "preconditions": [],
      "programme": "ANTENNE-LOGIC",
      "related_exigences": [
        "F2"
      ],
      "required": true,
      "steps": [
        "DISPLAY '=========================================='",
        "DISPLAY 'DEBUT TRAITEMENT BATCH ANTENNES'",
        "DISPLAY '=========================================='",
        "MOVE 'READ' TO OPERATION",
        "CALL 'ANTENNE-DAL-DB' USING OPERATION END-OF-FILE ANTENNE",
        "PERFORM UNTIL EOF-REACHED",
        "ADD 1 TO WS-COUNT-TOTAL",
        "PERFORM NORMALIZE-REGION",
        "MOVE 'SAVE' TO OPERATION",
        "CALL 'ANTENNE-DAL-DB' USING OPERATION END-OF-FILE ANTENNE",
        "CALL 'ANTENNE-BUSINESS' USING ANTENNE",
        "MOVE 'READ' TO OPERATION",
        "CALL 'ANTENNE-DAL-DB' USING OPERATION END-OF-FILE ANTENNE",
        "END-PERFORM",
        "MOVE 'END ' TO OPERATION",
        "CALL 'ANTENNE-DAL-DB' USING OPERATION END-OF-FILE ANTENNE",
        "DISPLAY '=========================================='",
        "DISPLAY 'FIN TRAITEMENT BATCH ANTENNES'",
        "DISPLAY 'Nombre antennes traitees: ' WS-COUNT-TOTAL",
        "DISPLAY 'Antennes en erreur: ' WS-COUNT-ERROR",
        "DISPLAY '=========================================='",
        "STOP RUN"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Controle simple: si ANTENNE_REGION est vide, la mettre a 'INCONNUE' et compter une anomalie.",
      "entity": "ANTENNE",
      "errors_flags": [
        "Si ANTENNE_REGION est vide alors mise a 'INCONNUE' et compteur erreur incremente."
      ],
      "id": "FN-ANT-LOGIC-CALC",
      "inputs": [
        "ANTENNE.ANTENNE_REGION"
      ],
      "layer": "logic",
      "modifies": [
        "ANTENNE.ANTENNE_REGION",
        "WS-COUNT-ERROR"
      ],
      "name": "NORMALIZE-REGION",
      "outputs": [
        "ANTENNE.ANTENNE_REGION"
      ],
      "postconditions": [
        "ANTENNE.ANTENNE_REGION n est pas vide."
      ],
      "preconditions": [
        "ANTENNE.ANTENNE_REGION contient une valeur texte."
      ],
      "programme": "ANTENNE-LOGIC",
      "related_exigences": [
        "F2"
      ],
      "required": true,
      "steps": [
        "IF ANTENNE-REGION OF ANTENNE = SPACES",
        "MOVE 'INCONNUE' TO ANTENNE-REGION OF ANTENNE",
        "ADD 1 TO WS-COUNT-ERROR",
        {
          "DISPLAY 'ANOMALIE": "Region antenne invalide'"
        },
        "END-IF"
      ],
      "visibility": "public"
    },
    {
      "description": "Affiche les informations principales de l antenne courante sur la console.",
      "display": {
        "lines": [
          {
            "cobol_name": "LK-ANTENNE-NOM",
            "field": "ANTENNE.ANTENNE_NOM",
            "label": "ANTENNE   : "
          },
          {
            "cobol_name": "LK-ANTENNE-ID",
            "field": "ANTENNE.ANTENNE_ID",
            "label": "ID        : "
          },
          {
            "cobol_name": "LK-ANTENNE-REGION",
            "field": "ANTENNE.ANTENNE_REGION",
            "label": "REGION    : "
          }
        ],
        "separator": "----------------------------------------"
      },
      "entity": "ANTENNE",
      "errors_flags": [],
      "id": "FN-ANT-BIZ-DISPLAY",
      "inputs": [
        "ANTENNE.ANTENNE_ID",
        "ANTENNE.ANTENNE_NOM",
        "ANTENNE.ANTENNE_REGION"
      ],
      "layer": "business",
      "modifies": [],
      "name": "DISPLAY-ANTENNE",
      "outputs": [],
      "postconditions": [],
      "preconditions": [
        "ANTENNE contient des valeurs lues/calculees coherentes."
      ],
      "programme": "ANTENNE-BUSINESS",
      "related_exigences": [
        "F2"
      ],
      "required": true,
      "steps": [
        "DISPLAY '----------------------------------------'",
        "DISPLAY 'ANTENNE   : ' ANTENNE-NOM OF LK-ANTENNE",
        "DISPLAY 'ID        : ' ANTENNE-ID OF LK-ANTENNE",
        "DISPLAY 'REGION    : ' ANTENNE-REGION OF LK-ANTENNE",
        "DISPLAY '----------------------------------------'",
        "GOBACK"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Connexion paresseuse a la base via OCESQL. Initialise les variables d environnement PostgreSQL, puis execute OCESQLStartSQL/OCESQLConnect/OCESQLEndSQL.",
      "entity": "REPAS",
      "id": "FN-REP-DAL-CONNECT",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-CONNECT",
      "outputs": [
        "SQLCODE",
        "SQLSTATE"
      ],
      "programme": "REPAS-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "connection_calls": [
          "CALL \"OCESQLStartSQL\" END-CALL",
          "CALL \"OCESQLConnect\" USING BY REFERENCE SQLCA BY REFERENCE WS-DB-USER BY VALUE WS-DB-USER-LEN BY REFERENCE WS-DB-PASSWORD BY VALUE WS-DB-PASSWORD-LEN BY REFERENCE WS-DB-NAME BY VALUE WS-DB-NAME-LEN END-CALL",
          "CALL \"OCESQLEndSQL\" END-CALL"
        ],
        "connection_method": "OCESQL (voir sql.connection)"
      },
      "visibility": "internal"
    },
    {
      "description": "Force les variables d environnement PGHOST/PGPORT/PGUSER/PGPASSWORD/PGDATABASE.",
      "entity": "REPAS",
      "id": "FN-REP-DAL-SET-ENV",
      "inputs": [],
      "layer": "dal",
      "modifies": [],
      "name": "DAL-SET-ENV",
      "outputs": [],
      "programme": "REPAS-DAL-DB",
      "related_exigences": [
        "R4"
      ],
      "required": true,
      "steps": [
        "DISPLAY WS-PGHOST-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGHOST-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPORT-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPORT-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGUSER-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGUSER-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPASSWORD-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPASSWORD-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGDATABASE-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGDATABASE-VALUE UPON ENVIRONMENT-VALUE"
      ],
      "visibility": "internal"
    },
    {
      "description": "Ouvre le curseur C_REP si necessaire, fait un FETCH et remplit la structure REPAS. Met END-OF-FILE a 'Y' en cas de fin de donnees ou d erreur.",
      "entity": "REPAS",
      "eof_logic": {
        "eof_false_value": "N",
        "eof_flag_name": "LK-END-OF-FILE",
        "eof_true_value": "Y",
        "on_sqlcode_100_set_eof": true
      },
      "errors_flags": [
        "SQLCODE = 0 : succes, une ligne lue.",
        "SQLCODE = 100 : fin de curseur.",
        "SQLCODE != 0 et != 100 : erreur SQL, le batch s arrete logiquement."
      ],
      "id": "FN-REP-DAL-READ",
      "inputs": [
        "OPERATION = 'READ'",
        "Connexion deja etablie par MAIN-ENTRY (sauf OPERATION='END ').",
        "Curseur non garanti ouvert (ouverture paresseuse)."
      ],
      "layer": "dal",
      "modifies": [
        "REPAS.*",
        "END-OF-FILE",
        "WS-CONNECTED",
        "WS-CURSOR-OPEN",
        "SQLCODE"
      ],
      "name": "DAL-READ",
      "operation_code": "READ",
      "outputs": [
        "REPAS.REPAS_ID",
        "REPAS.REPAS_ID_ACTIVITE",
        "REPAS.REPAS_TYPE",
        "REPAS.REPAS_NBREPAS",
        "END-OF-FILE",
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : REPAS contient un enregistrement valide et END-OF-FILE = 'N'.",
        "Si SQLCODE = 100 : fin de donnees, END-OF-FILE = 'Y'.",
        "Si SQLCODE != 0 et != 100 : message d erreur affiche et END-OF-FILE = 'Y'."
      ],
      "preconditions": [],
      "programme": "REPAS-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "declare_cursor": "DECLARE C_REP CURSOR FOR\nSELECT REPAS_ID, REPAS_ID_ACTIVITE, REPAS_TYPE, REPAS_NBREPAS\nFROM REPAS\nORDER BY REPAS_ID\n",
        "fetch_into": "FETCH C_REP INTO :WS-REPAS-ID, :WS-REPAS-ID-ACTIVITE, :WS-REPAS-TYPE, :WS-REPAS-NBREPAS",
        "open_cursor": "OPEN C_REP"
      },
      "sql_actions": [
        "declare_cursor",
        "open_cursor",
        "fetch_cursor",
        "check_sqlcode",
        "map_to_linkage",
        "set_eof"
      ],
      "steps": [
        "EXEC SQL DECLARE C_REP CURSOR FOR",
        "SELECT REPAS_ID, REPAS_ID_ACTIVITE, REPAS_TYPE, REPAS_NBREPAS",
        "FROM REPAS",
        "ORDER BY REPAS_ID",
        "END-EXEC",
        "IF NOT WS-CURSOR-OPEN",
        "EXEC SQL OPEN C_REP END-EXEC",
        "IF SQLCODE NOT EQUAL ZERO",
        "DISPLAY 'ERREUR OPEN: SQLCODE=' SQLCODE",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "EXEC SQL ROLLBACK END-EXEC",
        "GOBACK",
        "END-IF",
        "MOVE 'Y' TO WS-CURSOR-OPEN-FLAG",
        "DISPLAY 'Curseur C_REP ouvert'",
        "END-IF",
        "EXEC SQL FETCH C_REP INTO",
        ":WS-REPAS-ID,",
        ":WS-REPAS-ID-ACTIVITE,",
        ":WS-REPAS-TYPE,",
        ":WS-REPAS-NBREPAS",
        "END-EXEC",
        "IF SQLCODE NOT EQUAL ZERO AND SQLCODE NOT EQUAL 100",
        "DISPLAY 'ERREUR FETCH: SQLCODE=' SQLCODE",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "EXEC SQL ROLLBACK END-EXEC",
        "GOBACK",
        "END-IF",
        "IF SQLCODE EQUAL 100",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "GOBACK",
        "END-IF",
        "MOVE WS-REPAS-ID TO REPAS-ID OF LK-REPAS",
        "MOVE WS-REPAS-ID-ACTIVITE TO REPAS-ID-ACTIVITE OF LK-REPAS",
        "MOVE WS-REPAS-TYPE TO REPAS-TYPE OF LK-REPAS",
        "MOVE WS-REPAS-NBREPAS TO REPAS-NBREPAS OF LK-REPAS"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Met a jour en base la colonne REPAS_NBREPAS pour le repas courant (REPAS_ID).",
      "entity": "REPAS",
      "errors_flags": [
        "SQLCODE = 0 : succes.",
        "SQLCODE != 0 : erreur SQL, message affiche."
      ],
      "id": "FN-REP-DAL-SAVE",
      "inputs": [
        "REPAS.REPAS_ID",
        "REPAS.REPAS_NBREPAS"
      ],
      "layer": "dal",
      "modifies": [
        "SQLCODE"
      ],
      "name": "DAL-SAVE",
      "operation_code": "SAVE",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : la ligne REPAS correspondante en base a ete mise a jour."
      ],
      "preconditions": [
        "REPAS.REPAS_ID contient un identifiant existant en base."
      ],
      "programme": "REPAS-DAL-DB",
      "related_exigences": [
        "F3",
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "update_statement": "UPDATE REPAS\nSET REPAS_NBREPAS = :WS-REPAS-NBREPAS\nWHERE REPAS_ID = :WS-REPAS-ID\n"
      },
      "steps": [
        "MOVE REPAS-ID OF LK-REPAS TO WS-REPAS-ID",
        "MOVE REPAS-NBREPAS OF LK-REPAS TO WS-REPAS-NBREPAS",
        "EXEC SQL UPDATE REPAS",
        "SET REPAS_NBREPAS = :WS-REPAS-NBREPAS",
        "WHERE REPAS_ID = :WS-REPAS-ID",
        "END-EXEC",
        "EVALUATE SQLCODE",
        "WHEN 0",
        "CONTINUE",
        "WHEN OTHER",
        "DISPLAY 'ERREUR UPDATE: SQLCODE=' SQLCODE",
        "DISPLAY 'SQLSTATE=' SQLSTATE",
        "DISPLAY 'SQLERRMC=' SQLERRMC",
        "EXEC SQL ROLLBACK END-EXEC",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "END-EVALUATE"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Ferme le curseur s il est ouvert, commit la transaction et ferme la connexion a la base.",
      "entity": "REPAS",
      "errors_flags": [
        "Les erreurs de CLOSE/COMMIT/DISCONNECT sont simplement affichees."
      ],
      "id": "FN-REP-DAL-END",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CURSOR-OPEN",
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-END",
      "operation_code": "END ",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Curseur ferme si besoin.",
        "COMMIT effectue.",
        "Connexion base fermee."
      ],
      "preconditions": [],
      "programme": "REPAS-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "close_cursor": "CLOSE C_REP",
        "commit": "COMMIT",
        "disconnect": "DISCONNECT ALL"
      },
      "steps": [
        "IF WS-CURSOR-OPEN",
        "EXEC SQL CLOSE C_REP END-EXEC",
        "MOVE 'N' TO WS-CURSOR-OPEN-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR CLOSE: SQLCODE=' SQLCODE",
        "END-IF",
        "END-IF",
        "EXEC SQL COMMIT END-EXEC",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR COMMIT: SQLCODE=' SQLCODE",
        "END-IF",
        "IF WS-CONNECTED",
        "EXEC SQL DISCONNECT ALL END-EXEC",
        "MOVE 'N' TO WS-CONNECTED-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR DISCONNECT: SQLCODE=' SQLCODE",
        "END-IF",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "calls": [
        "REPAS-DAL-DB avec OPERATION='READ'",
        "CALCULATE-REPAS",
        "REPAS-DAL-DB avec OPERATION='SAVE'",
        "REPAS-BUSINESS.DISPLAY-REPAS",
        "REPAS-DAL-DB avec OPERATION='END '"
      ],
      "description": "Boucle principale du batch: lit les repas via la DAL, controle le nombre de repas, sauvegarde et affiche chaque repas.",
      "entity": "REPAS",
      "id": "FN-REP-LOGIC-MAIN",
      "inputs": [],
      "layer": "logic",
      "loop_control": {
        "eof_false_value": "N",
        "eof_flag_name": "END-OF-FILE",
        "eof_true_value": "Y"
      },
      "modifies": [
        "REPAS.*",
        "END-OF-FILE",
        "WS-COUNT-TOTAL",
        "WS-COUNT-ERROR"
      ],
      "name": "MAIN-PROCESS",
      "outputs": [],
      "postconditions": [
        "Tous les repas ont un nombre valide (>= 0)."
      ],
      "preconditions": [],
      "programme": "REPAS-LOGIC",
      "related_exigences": [
        "F3"
      ],
      "required": true,
      "steps": [
        "DISPLAY '=========================================='",
        "DISPLAY 'DEBUT TRAITEMENT BATCH REPAS'",
        "DISPLAY '=========================================='",
        "MOVE 'READ' TO OPERATION",
        "CALL 'REPAS-DAL-DB' USING OPERATION END-OF-FILE REPAS",
        "PERFORM UNTIL EOF-REACHED",
        "ADD 1 TO WS-COUNT-TOTAL",
        "PERFORM CALCULATE-REPAS",
        "MOVE 'SAVE' TO OPERATION",
        "CALL 'REPAS-DAL-DB' USING OPERATION END-OF-FILE REPAS",
        "CALL 'REPAS-BUSINESS' USING REPAS",
        "MOVE 'READ' TO OPERATION",
        "CALL 'REPAS-DAL-DB' USING OPERATION END-OF-FILE REPAS",
        "END-PERFORM",
        "MOVE 'END ' TO OPERATION",
        "CALL 'REPAS-DAL-DB' USING OPERATION END-OF-FILE REPAS",
        "DISPLAY '=========================================='",
        "DISPLAY 'FIN TRAITEMENT BATCH REPAS'",
        "DISPLAY 'Nombre repas traites: ' WS-COUNT-TOTAL",
        "DISPLAY 'Repas en erreur: ' WS-COUNT-ERROR",
        "DISPLAY '=========================================='",
        "STOP RUN"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Controle simple: si REPAS_NBREPAS est negatif, le remettre a zero et compter une anomalie.",
      "entity": "REPAS",
      "errors_flags": [
        "Si REPAS_NBREPAS < 0 alors mise a 0 et compteur erreur incremente."
      ],
      "id": "FN-REP-LOGIC-CALC",
      "inputs": [
        "REPAS.REPAS_NBREPAS"
      ],
      "layer": "logic",
      "modifies": [
        "REPAS.REPAS_NBREPAS",
        "WS-COUNT-ERROR"
      ],
      "name": "CALCULATE-REPAS",
      "outputs": [
        "REPAS.REPAS_NBREPAS"
      ],
      "postconditions": [
        "REPAS.REPAS_NBREPAS >= 0."
      ],
      "preconditions": [
        "REPAS.REPAS_NBREPAS contient une valeur numerique."
      ],
      "programme": "REPAS-LOGIC",
      "related_exigences": [
        "F3"
      ],
      "required": true,
      "steps": [
        "IF REPAS-NBREPAS OF REPAS < 0",
        "MOVE 0 TO REPAS-NBREPAS OF REPAS",
        "ADD 1 TO WS-COUNT-ERROR",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Affiche les informations principales du repas courant sur la console.",
      "display": {
        "lines": [
          {
            "cobol_name": "LK-REPAS-ID",
            "field": "REPAS.REPAS_ID",
            "label": "REPAS    : "
          },
          {
            "cobol_name": "LK-REPAS-ID-ACTIVITE",
            "field": "REPAS.REPAS_ID_ACTIVITE",
            "label": "ACTIVITE : "
          },
          {
            "cobol_name": "LK-REPAS-TYPE",
            "field": "REPAS.REPAS_TYPE",
            "label": "TYPE     : "
          },
          {
            "cobol_name": "LK-REPAS-NBREPAS",
            "field": "REPAS.REPAS_NBREPAS",
            "label": "NBREPAS  : "
          }
        ],
        "separator": "----------------------------------------"
      },
      "entity": "REPAS",
      "errors_flags": [],
      "id": "FN-REP-BIZ-DISPLAY",
      "inputs": [
        "REPAS.REPAS_ID",
        "REPAS.REPAS_ID_ACTIVITE",
        "REPAS.REPAS_TYPE",
        "REPAS.REPAS_NBREPAS"
      ],
      "layer": "business",
      "modifies": [],
      "name": "DISPLAY-REPAS",
      "outputs": [],
      "postconditions": [],
      "preconditions": [
        "REPAS contient des valeurs lues/calculees coherentes."
      ],
      "programme": "REPAS-BUSINESS",
      "related_exigences": [
        "F3"
      ],
      "required": true,
      "steps": [
        "DISPLAY '----------------------------------------'",
        "DISPLAY 'REPAS    : ' REPAS-ID OF LK-REPAS",
        "DISPLAY 'ACTIVITE : ' REPAS-ID-ACTIVITE OF LK-REPAS",
        "DISPLAY 'TYPE     : ' REPAS-TYPE OF LK-REPAS",
        "DISPLAY 'NBREPAS  : ' REPAS-NBREPAS OF LK-REPAS",
        "DISPLAY '----------------------------------------'",
        "GOBACK"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Connexion paresseuse a la base via OCESQL. Initialise les variables d environnement PostgreSQL, puis execute OCESQLStartSQL/OCESQLConnect/OCESQLEndSQL.",
      "entity": "HEBERGEMENT",
      "id": "FN-HEB-DAL-CONNECT",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-CONNECT",
      "outputs": [
        "SQLCODE",
        "SQLSTATE"
      ],
      "programme": "HEBERGEMENT-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "connection_calls": [
          "CALL \"OCESQLStartSQL\" END-CALL",
          "CALL \"OCESQLConnect\" USING BY REFERENCE SQLCA BY REFERENCE WS-DB-USER BY VALUE WS-DB-USER-LEN BY REFERENCE WS-DB-PASSWORD BY VALUE WS-DB-PASSWORD-LEN BY REFERENCE WS-DB-NAME BY VALUE WS-DB-NAME-LEN END-CALL",
          "CALL \"OCESQLEndSQL\" END-CALL"
        ],
        "connection_method": "OCESQL (voir sql.connection)"
      },
      "visibility": "internal"
    },
    {
      "description": "Force les variables d environnement PGHOST/PGPORT/PGUSER/PGPASSWORD/PGDATABASE.",
      "entity": "HEBERGEMENT",
      "id": "FN-HEB-DAL-SET-ENV",
      "inputs": [],
      "layer": "dal",
      "modifies": [],
      "name": "DAL-SET-ENV",
      "outputs": [],
      "programme": "HEBERGEMENT-DAL-DB",
      "related_exigences": [
        "R4"
      ],
      "required": true,
      "steps": [
        "DISPLAY WS-PGHOST-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGHOST-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPORT-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPORT-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGUSER-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGUSER-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPASSWORD-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPASSWORD-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGDATABASE-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGDATABASE-VALUE UPON ENVIRONMENT-VALUE"
      ],
      "visibility": "internal"
    },
    {
      "description": "Ouvre le curseur C_HEB si necessaire, fait un FETCH et remplit la structure HEBERGEMENT. Met END-OF-FILE a 'Y' en cas de fin de donnees ou d erreur.",
      "entity": "HEBERGEMENT",
      "eof_logic": {
        "eof_false_value": "N",
        "eof_flag_name": "LK-END-OF-FILE",
        "eof_true_value": "Y",
        "on_sqlcode_100_set_eof": true
      },
      "errors_flags": [
        "SQLCODE = 0 : succes, une ligne lue.",
        "SQLCODE = 100 : fin de curseur.",
        "SQLCODE != 0 et != 100 : erreur SQL, le batch s arrete logiquement."
      ],
      "id": "FN-HEB-DAL-READ",
      "inputs": [
        "OPERATION = 'READ'",
        "Connexion deja etablie par MAIN-ENTRY (sauf OPERATION='END ').",
        "Curseur non garanti ouvert (ouverture paresseuse)."
      ],
      "layer": "dal",
      "modifies": [
        "HEBERGEMENT.*",
        "END-OF-FILE",
        "WS-CONNECTED",
        "WS-CURSOR-OPEN",
        "SQLCODE"
      ],
      "name": "DAL-READ",
      "operation_code": "READ",
      "outputs": [
        "HEBERGEMENT.HEBERGEMENT_ID",
        "HEBERGEMENT.HEBERGEMENT_ID_ACTIVITE",
        "HEBERGEMENT.HEBERGEMENT_TYPE",
        "HEBERGEMENT.HEBERGEMENT_NBNUIT",
        "END-OF-FILE",
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : HEBERGEMENT contient un enregistrement valide et END-OF-FILE = 'N'.",
        "Si SQLCODE = 100 : fin de donnees, END-OF-FILE = 'Y'.",
        "Si SQLCODE != 0 et != 100 : message d erreur affiche et END-OF-FILE = 'Y'."
      ],
      "preconditions": [],
      "programme": "HEBERGEMENT-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "declare_cursor": "DECLARE C_HEB CURSOR FOR\nSELECT HEBERGEMENT_ID, HEBERGEMENT_ID_ACTIVITE,\n       HEBERGEMENT_TYPE, HEBERGEMENT_NBNUIT\nFROM HEBERGEMENT\nORDER BY HEBERGEMENT_ID\n",
        "fetch_into": "FETCH C_HEB INTO :WS-HEBERGEMENT-ID, :WS-HEBERG-ID-ACTIVITE, :WS-HEBERGEMENT-TYPE, :WS-HEBERGEMENT-NBNUIT",
        "open_cursor": "OPEN C_HEB"
      },
      "sql_actions": [
        "declare_cursor",
        "open_cursor",
        "fetch_cursor",
        "check_sqlcode",
        "map_to_linkage",
        "set_eof"
      ],
      "steps": [
        "PERFORM DAL-CONNECT",
        "IF NOT WS-CONNECTED",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "GOBACK",
        "END-IF",
        "IF NOT WS-CURSOR-OPEN",
        "EXEC SQL DECLARE C_HEB CURSOR FOR",
        "SELECT HEBERGEMENT_ID, HEBERGEMENT_ID_ACTIVITE,",
        "HEBERGEMENT_TYPE, HEBERGEMENT_NBNUIT",
        "FROM HEBERGEMENT",
        "ORDER BY HEBERGEMENT_ID",
        "END-EXEC",
        "EXEC SQL OPEN C_HEB END-EXEC",
        "IF SQLCODE NOT EQUAL ZERO",
        "DISPLAY 'ERREUR OPEN: SQLCODE=' SQLCODE",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "EXEC SQL ROLLBACK END-EXEC",
        "GOBACK",
        "END-IF",
        "SET WS-CURSOR-OPEN TO TRUE",
        "DISPLAY 'Curseur C_HEB ouvert'",
        "END-IF",
        "EXEC SQL FETCH C_HEB INTO",
        ":WS-HEBERGEMENT-ID,",
        ":WS-HEBERG-ID-ACTIVITE,",
        ":WS-HEBERGEMENT-TYPE,",
        ":WS-HEBERGEMENT-NBNUIT",
        "END-EXEC",
        "EVALUATE SQLCODE",
        "WHEN 0",
        "MOVE WS-HEBERGEMENT-ID TO HEBERGEMENT-ID OF LK-HEBERGEMENT",
        "MOVE WS-HEBERG-ID-ACTIVITE TO HEBERGEMENT-ID-ACTIVITE OF LK-HEBERGEMENT",
        "MOVE WS-HEBERGEMENT-TYPE TO HEBERGEMENT-TYPE OF LK-HEBERGEMENT",
        "MOVE WS-HEBERGEMENT-NBNUIT TO HEBERGEMENT-NBNUIT OF LK-HEBERGEMENT",
        "WHEN 100",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "EXEC SQL CLOSE C_HEB END-EXEC",
        "MOVE 'N' TO WS-CURSOR-OPEN-FLAG",
        "WHEN OTHER",
        "DISPLAY 'ERREUR FETCH: SQLCODE=' SQLCODE",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "EXEC SQL ROLLBACK END-EXEC",
        "END-EVALUATE"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Met a jour en base la colonne HEBERGEMENT_NBNUIT pour l hebergement courant (HEBERGEMENT_ID).",
      "entity": "HEBERGEMENT",
      "errors_flags": [
        "SQLCODE = 0 : succes.",
        "SQLCODE != 0 : erreur SQL, message affiche."
      ],
      "id": "FN-HEB-DAL-SAVE",
      "inputs": [
        "HEBERGEMENT.HEBERGEMENT_ID",
        "HEBERGEMENT.HEBERGEMENT_NBNUIT"
      ],
      "layer": "dal",
      "modifies": [
        "SQLCODE"
      ],
      "name": "DAL-SAVE",
      "operation_code": "SAVE",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : la ligne HEBERGEMENT correspondante en base a ete mise a jour."
      ],
      "preconditions": [
        "HEBERGEMENT.HEBERGEMENT_ID contient un identifiant existant en base."
      ],
      "programme": "HEBERGEMENT-DAL-DB",
      "related_exigences": [
        "F3",
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "update_statement": "UPDATE HEBERGEMENT\nSET HEBERGEMENT_NBNUIT = :WS-HEBERGEMENT-NBNUIT\nWHERE HEBERGEMENT_ID = :WS-HEBERGEMENT-ID\n"
      },
      "steps": [
        "MOVE HEBERGEMENT-ID OF LK-HEBERGEMENT TO WS-HEBERGEMENT-ID",
        "MOVE HEBERGEMENT-NBNUIT OF LK-HEBERGEMENT TO WS-HEBERGEMENT-NBNUIT",
        "EXEC SQL UPDATE HEBERGEMENT",
        "SET HEBERGEMENT_NBNUIT = :WS-HEBERGEMENT-NBNUIT",
        "WHERE HEBERGEMENT_ID = :WS-HEBERGEMENT-ID",
        "END-EXEC",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR UPDATE: SQLCODE=' SQLCODE",
        "EXEC SQL ROLLBACK END-EXEC",
        "MOVE 'Y' TO LK-END-OF-FILE",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Ferme le curseur s il est ouvert, commit la transaction et ferme la connexion a la base.",
      "entity": "HEBERGEMENT",
      "errors_flags": [
        "Les erreurs de CLOSE/COMMIT/DISCONNECT sont simplement affichees."
      ],
      "id": "FN-HEB-DAL-END",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CURSOR-OPEN",
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-END",
      "operation_code": "END ",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Curseur ferme si besoin.",
        "COMMIT effectue.",
        "Connexion base fermee."
      ],
      "preconditions": [],
      "programme": "HEBERGEMENT-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "close_cursor": "CLOSE C_HEB",
        "commit": "COMMIT",
        "disconnect": "DISCONNECT ALL"
      },
      "steps": [
        "IF WS-CURSOR-OPEN",
        "EXEC SQL CLOSE C_HEB END-EXEC",
        "MOVE 'N' TO WS-CURSOR-OPEN-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR CLOSE: SQLCODE=' SQLCODE",
        "END-IF",
        "END-IF",
        "EXEC SQL COMMIT END-EXEC",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR COMMIT: SQLCODE=' SQLCODE",
        "END-IF",
        "IF WS-CONNECTED",
        "EXEC SQL DISCONNECT ALL END-EXEC",
        "MOVE 'N' TO WS-CONNECTED-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR DISCONNECT: SQLCODE=' SQLCODE",
        "END-IF",
        "DISPLAY 'Fermeture connexion'",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "calls": [
        "HEBERGEMENT-DAL-DB avec OPERATION='READ'",
        "CALCULATE-HEBERGEMENT",
        "HEBERGEMENT-DAL-DB avec OPERATION='SAVE'",
        "HEBERGEMENT-BUSINESS.DISPLAY-HEBERGEMENT",
        "HEBERGEMENT-DAL-DB avec OPERATION='END '"
      ],
      "description": "Boucle principale du batch: lit les hebergements via la DAL, controle le nombre de nuits, sauvegarde et affiche chaque hebergement.",
      "entity": "HEBERGEMENT",
      "id": "FN-HEB-LOGIC-MAIN",
      "inputs": [],
      "layer": "logic",
      "loop_control": {
        "eof_false_value": "N",
        "eof_flag_name": "END-OF-FILE",
        "eof_true_value": "Y"
      },
      "modifies": [
        "HEBERGEMENT.*",
        "END-OF-FILE",
        "WS-COUNT-TOTAL",
        "WS-COUNT-ERROR"
      ],
      "name": "MAIN-PROCESS",
      "outputs": [],
      "postconditions": [
        "Tous les hebergements ont un nombre de nuits valide (>= 0)."
      ],
      "preconditions": [],
      "programme": "HEBERGEMENT-LOGIC",
      "related_exigences": [
        "F3"
      ],
      "required": true,
      "steps": [
        "DISPLAY '=========================================='",
        "DISPLAY 'DEBUT TRAITEMENT BATCH HEBERGEMENTS'",
        "DISPLAY '=========================================='",
        "MOVE 'READ' TO OPERATION",
        "CALL 'HEBERGEMENT-DAL-DB' USING OPERATION END-OF-FILE HEBERGEMENT",
        "PERFORM UNTIL EOF-REACHED",
        "ADD 1 TO WS-COUNT-TOTAL",
        "PERFORM CALCULATE-HEBERGEMENT",
        "MOVE 'SAVE' TO OPERATION",
        "CALL 'HEBERGEMENT-DAL-DB' USING OPERATION END-OF-FILE HEBERGEMENT",
        "CALL 'HEBERGEMENT-BUSINESS' USING HEBERGEMENT",
        "MOVE 'READ' TO OPERATION",
        "CALL 'HEBERGEMENT-DAL-DB' USING OPERATION END-OF-FILE HEBERGEMENT",
        "END-PERFORM",
        "MOVE 'END ' TO OPERATION",
        "CALL 'HEBERGEMENT-DAL-DB' USING OPERATION END-OF-FILE HEBERGEMENT",
        "DISPLAY '=========================================='",
        "DISPLAY 'FIN TRAITEMENT BATCH HEBERGEMENTS'",
        "DISPLAY 'Nombre hebergements traites: ' WS-COUNT-TOTAL",
        "DISPLAY 'Hebergements en erreur: ' WS-COUNT-ERROR",
        "DISPLAY '=========================================='",
        "STOP RUN"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Controle simple: si HEBERGEMENT_NBNUIT est negatif, le remettre a zero et compter une anomalie.",
      "entity": "HEBERGEMENT",
      "errors_flags": [
        "Si HEBERGEMENT_NBNUIT < 0 alors mise a 0 et compteur erreur incremente."
      ],
      "id": "FN-HEB-LOGIC-CALC",
      "inputs": [
        "HEBERGEMENT.HEBERGEMENT_NBNUIT"
      ],
      "layer": "logic",
      "modifies": [
        "HEBERGEMENT.HEBERGEMENT_NBNUIT",
        "WS-COUNT-ERROR"
      ],
      "name": "CALCULATE-HEBERGEMENT",
      "outputs": [
        "HEBERGEMENT.HEBERGEMENT_NBNUIT"
      ],
      "postconditions": [
        "HEBERGEMENT.HEBERGEMENT_NBNUIT >= 0."
      ],
      "preconditions": [
        "HEBERGEMENT.HEBERGEMENT_NBNUIT contient une valeur numerique."
      ],
      "programme": "HEBERGEMENT-LOGIC",
      "related_exigences": [
        "F3"
      ],
      "required": true,
      "steps": [
        "IF HEBERGEMENT-NBNUIT OF HEBERGEMENT < 0",
        "MOVE 0 TO HEBERGEMENT-NBNUIT OF HEBERGEMENT",
        "ADD 1 TO WS-COUNT-ERROR",
        "DISPLAY 'ANOMALIE: Nombre nuits invalide'",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Affiche les informations principales de l hebergement courant sur la console.",
      "display": {
        "lines": [
          {
            "cobol_name": "LK-HEBERGEMENT-ID",
            "field": "HEBERGEMENT.HEBERGEMENT_ID",
            "label": "HEBERG. : "
          },
          {
            "cobol_name": "LK-HEBERG-ID-ACTIVITE",
            "field": "HEBERGEMENT.HEBERGEMENT_ID_ACTIVITE",
            "label": "ACTIVITE: "
          },
          {
            "cobol_name": "LK-HEBERGEMENT-TYPE",
            "field": "HEBERGEMENT.HEBERGEMENT_TYPE",
            "label": "TYPE    : "
          },
          {
            "cobol_name": "LK-HEBERGEMENT-NBNUIT",
            "field": "HEBERGEMENT.HEBERGEMENT_NBNUIT",
            "label": "NBNUIT  : "
          }
        ],
        "separator": "----------------------------------------"
      },
      "entity": "HEBERGEMENT",
      "errors_flags": [],
      "id": "FN-HEB-BIZ-DISPLAY",
      "inputs": [
        "HEBERGEMENT.HEBERGEMENT_ID",
        "HEBERGEMENT.HEBERGEMENT_ID_ACTIVITE",
        "HEBERGEMENT.HEBERGEMENT_TYPE",
        "HEBERGEMENT.HEBERGEMENT_NBNUIT"
      ],
      "layer": "business",
      "modifies": [],
      "name": "DISPLAY-HEBERGEMENT",
      "outputs": [],
      "postconditions": [],
      "preconditions": [
        "HEBERGEMENT contient des valeurs lues/calculees coherentes."
      ],
      "programme": "HEBERGEMENT-BUSINESS",
      "related_exigences": [
        "F3"
      ],
      "required": true,
      "visibility": "public"
    },
    {
      "description": "Connexion paresseuse a la base via OCESQL. Initialise les variables d environnement PostgreSQL, puis execute OCESQLStartSQL/OCESQLConnect/OCESQLEndSQL.",
      "entity": "PARTICIPATION",
      "id": "FN-PAR-DAL-CONNECT",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-CONNECT",
      "outputs": [
        "SQLCODE",
        "SQLSTATE"
      ],
      "programme": "PARTICIPATION-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "connection_calls": [
          "CALL \"OCESQLStartSQL\" END-CALL",
          "CALL \"OCESQLConnect\" USING BY REFERENCE SQLCA BY REFERENCE WS-DB-USER BY VALUE WS-DB-USER-LEN BY REFERENCE WS-DB-PASSWORD BY VALUE WS-DB-PASSWORD-LEN BY REFERENCE WS-DB-NAME BY VALUE WS-DB-NAME-LEN END-CALL",
          "CALL \"OCESQLEndSQL\" END-CALL"
        ],
        "connection_method": "OCESQL (voir sql.connection)"
      },
      "visibility": "internal"
    },
    {
      "description": "Force les variables d environnement PGHOST/PGPORT/PGUSER/PGPASSWORD/PGDATABASE.",
      "entity": "PARTICIPATION",
      "id": "FN-PAR-DAL-SET-ENV",
      "inputs": [],
      "layer": "dal",
      "modifies": [],
      "name": "DAL-SET-ENV",
      "outputs": [],
      "programme": "PARTICIPATION-DAL-DB",
      "related_exigences": [
        "R4"
      ],
      "required": true,
      "steps": [
        "DISPLAY WS-PGHOST-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGHOST-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPORT-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPORT-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGUSER-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGUSER-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGPASSWORD-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGPASSWORD-VALUE UPON ENVIRONMENT-VALUE",
        "DISPLAY WS-PGDATABASE-NAME UPON ENVIRONMENT-NAME",
        "DISPLAY WS-PGDATABASE-VALUE UPON ENVIRONMENT-VALUE"
      ],
      "visibility": "internal"
    },
    {
      "description": "Ouvre le curseur C_PAR si necessaire, fait un FETCH et remplit la structure PARTICIPATION. Met END-OF-FILE a 'Y' en cas de fin de donnees ou d erreur.",
      "entity": "PARTICIPATION",
      "eof_logic": {
        "eof_false_value": "N",
        "eof_flag_name": "LK-END-OF-FILE",
        "eof_true_value": "Y",
        "on_sqlcode_100_set_eof": true
      },
      "errors_flags": [
        "SQLCODE = 0 : succes, une ligne lue.",
        "SQLCODE = 100 : fin de curseur.",
        "SQLCODE != 0 et != 100 : erreur SQL, le batch s arrete logiquement."
      ],
      "id": "FN-PAR-DAL-READ",
      "inputs": [
        "OPERATION = 'READ'",
        "Connexion deja etablie par MAIN-ENTRY (sauf OPERATION='END ').",
        "Curseur non garanti ouvert (ouverture paresseuse)."
      ],
      "layer": "dal",
      "modifies": [
        "PARTICIPATION.*",
        "END-OF-FILE",
        "WS-CONNECTED",
        "WS-CURSOR-OPEN",
        "SQLCODE"
      ],
      "name": "DAL-READ",
      "operation_code": "READ",
      "outputs": [
        "PARTICIPATION.PARTICIPATION_ID_ACTIVITE",
        "PARTICIPATION.PARTICIPATION_ID_USER",
        "PARTICIPATION.PARTICIPATION_MODE_TRANSPORT",
        "END-OF-FILE",
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : PARTICIPATION contient un enregistrement valide et END-OF-FILE = 'N'.",
        "Si SQLCODE = 100 : fin de donnees, END-OF-FILE = 'Y'.",
        "Si SQLCODE != 0 et != 100 : message d erreur affiche et END-OF-FILE = 'Y'."
      ],
      "preconditions": [],
      "programme": "PARTICIPATION-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "declare_cursor": "DECLARE C_PAR CURSOR FOR\nSELECT PARTICIPATION_ID_ACTIVITE, PARTICIPATION_ID_USER, PARTICIPATION_MODE_TRANSPORT\nFROM PARTICIPATION\nORDER BY PARTICIPATION_ID_ACTIVITE, PARTICIPATION_ID_USER\n",
        "fetch_into": "FETCH C_PAR INTO :WS-PART-ID-ACTIVITE, :WS-PART-ID-USER, :WS-PART-MODE-TRANSPORT",
        "open_cursor": "OPEN C_PAR"
      },
      "sql_actions": [
        "declare_cursor",
        "open_cursor",
        "fetch_cursor",
        "check_sqlcode",
        "map_to_linkage",
        "set_eof"
      ],
      "visibility": "public"
    },
    {
      "description": "Met a jour en base la colonne PARTICIPATION_MODE_TRANSPORT pour la participation courante.",
      "entity": "PARTICIPATION",
      "errors_flags": [
        "SQLCODE = 0 : succes.",
        "SQLCODE != 0 : erreur SQL, message affiche."
      ],
      "id": "FN-PAR-DAL-SAVE",
      "inputs": [
        "PARTICIPATION.PARTICIPATION_ID_ACTIVITE",
        "PARTICIPATION.PARTICIPATION_ID_USER",
        "PARTICIPATION.PARTICIPATION_MODE_TRANSPORT"
      ],
      "layer": "dal",
      "modifies": [
        "SQLCODE"
      ],
      "name": "DAL-SAVE",
      "operation_code": "SAVE",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : la ligne PARTICIPATION correspondante en base a ete mise a jour."
      ],
      "preconditions": [
        "Participation existante en base pour le couple (ID_ACTIVITE, ID_USER)."
      ],
      "programme": "PARTICIPATION-DAL-DB",
      "related_exigences": [
        "F4",
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "update_statement": "UPDATE PARTICIPATION\nSET PARTICIPATION_MODE_TRANSPORT = :WS-PART-MODE-TRANSPORT\nWHERE PARTICIPATION_ID_ACTIVITE = :WS-PART-ID-ACTIVITE\n  AND PARTICIPATION_ID_USER = :WS-PART-ID-USER\n"
      },
      "visibility": "public"
    },
    {
      "description": "Ferme le curseur s il est ouvert, commit la transaction et ferme la connexion a la base.",
      "entity": "PARTICIPATION",
      "errors_flags": [
        "Les erreurs de CLOSE/COMMIT/DISCONNECT sont simplement affichees."
      ],
      "id": "FN-PAR-DAL-END",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CURSOR-OPEN",
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-END",
      "operation_code": "END ",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Curseur ferme si besoin.",
        "COMMIT effectue.",
        "Connexion base fermee."
      ],
      "preconditions": [],
      "programme": "PARTICIPATION-DAL-DB",
      "related_exigences": [
        "R4",
        "R5"
      ],
      "required": true,
      "sql": {
        "close_cursor": "CLOSE C_PAR",
        "commit": "COMMIT",
        "disconnect": "DISCONNECT ALL"
      },
      "steps": [
        "IF WS-CURSOR-OPEN",
        "EXEC SQL CLOSE C_PAR END-EXEC",
        "MOVE 'N' TO WS-CURSOR-OPEN-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR CLOSE: SQLCODE=' SQLCODE",
        "END-IF",
        "END-IF",
        "EXEC SQL COMMIT END-EXEC",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR COMMIT: SQLCODE=' SQLCODE",
        "END-IF",
        "IF WS-CONNECTED",
        "EXEC SQL DISCONNECT ALL END-EXEC",
        "MOVE 'N' TO WS-CONNECTED-FLAG",
        "IF SQLCODE NOT = 0",
        "DISPLAY 'ERREUR DISCONNECT: SQLCODE=' SQLCODE",
        "END-IF",
        "DISPLAY 'Fermeture connexion'",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "calls": [
        "PARTICIPATION-DAL-DB avec OPERATION='READ'",
        "CALCULATE-TRANSPORT",
        "PARTICIPATION-DAL-DB avec OPERATION='SAVE'",
        "PARTICIPATION-BUSINESS.DISPLAY-PARTICIPATION",
        "PARTICIPATION-DAL-DB avec OPERATION='END '"
      ],
      "description": "Boucle principale du batch: lit les participations via la DAL, controle le mode transport, sauvegarde et affiche chaque participation.",
      "entity": "PARTICIPATION",
      "id": "FN-PAR-LOGIC-MAIN",
      "inputs": [],
      "layer": "logic",
      "loop_control": {
        "eof_false_value": "N",
        "eof_flag_name": "END-OF-FILE",
        "eof_true_value": "Y"
      },
      "modifies": [
        "PARTICIPATION.*",
        "END-OF-FILE",
        "WS-COUNT-TOTAL",
        "WS-COUNT-ERROR"
      ],
      "name": "MAIN-PROCESS",
      "outputs": [],
      "postconditions": [
        "Toutes les participations ont un mode transport valide (>= 0)."
      ],
      "preconditions": [],
      "programme": "PARTICIPATION-LOGIC",
      "related_exigences": [
        "F4"
      ],
      "required": true,
      "steps": [
        "DISPLAY '=========================================='",
        "DISPLAY 'DEBUT TRAITEMENT BATCH PARTICIPATIONS'",
        "DISPLAY '=========================================='",
        "MOVE 'READ' TO OPERATION",
        "CALL 'PARTICIPATION-DAL-DB' USING OPERATION END-OF-FILE PARTICIPATION",
        "PERFORM UNTIL EOF-REACHED",
        "ADD 1 TO WS-COUNT-TOTAL",
        "PERFORM CALCULATE-TRANSPORT",
        "MOVE 'SAVE' TO OPERATION",
        "CALL 'PARTICIPATION-DAL-DB' USING OPERATION END-OF-FILE PARTICIPATION",
        "CALL 'PARTICIPATION-BUSINESS' USING PARTICIPATION",
        "MOVE 'READ' TO OPERATION",
        "CALL 'PARTICIPATION-DAL-DB' USING OPERATION END-OF-FILE PARTICIPATION",
        "END-PERFORM",
        "MOVE 'END ' TO OPERATION",
        "CALL 'PARTICIPATION-DAL-DB' USING OPERATION END-OF-FILE PARTICIPATION",
        "DISPLAY '=========================================='",
        "DISPLAY 'FIN TRAITEMENT BATCH PARTICIPATIONS'",
        "DISPLAY 'Nombre participations traitees: ' WS-COUNT-TOTAL",
        "DISPLAY 'Participations en erreur: ' WS-COUNT-ERROR",
        "DISPLAY '=========================================='",
        "STOP RUN"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Controle simple: si PARTICIPATION_MODE_TRANSPORT est negatif, le remettre a zero et compter une anomalie.",
      "entity": "PARTICIPATION",
      "errors_flags": [
        "Si PARTICIPATION_MODE_TRANSPORT < 0 alors mise a 0 et compteur erreur incremente."
      ],
      "id": "FN-PAR-LOGIC-CALC",
      "inputs": [
        "PARTICIPATION.PARTICIPATION_MODE_TRANSPORT"
      ],
      "layer": "logic",
      "modifies": [
        "PARTICIPATION.PARTICIPATION_MODE_TRANSPORT",
        "WS-COUNT-ERROR"
      ],
      "name": "CALCULATE-TRANSPORT",
      "outputs": [
        "PARTICIPATION.PARTICIPATION_MODE_TRANSPORT"
      ],
      "postconditions": [
        "PARTICIPATION.PARTICIPATION_MODE_TRANSPORT >= 0."
      ],
      "preconditions": [
        "PARTICIPATION.PARTICIPATION_MODE_TRANSPORT contient une valeur numerique."
      ],
      "programme": "PARTICIPATION-LOGIC",
      "related_exigences": [
        "F4"
      ],
      "required": true,
      "steps": [
        "IF PARTICIPATION-MODE-TRANSPORT OF PARTICIPATION < 0",
        "MOVE 0 TO PARTICIPATION-MODE-TRANSPORT OF PARTICIPATION",
        "ADD 1 TO WS-COUNT-ERROR",
        "CALL 'PARTICIPATION-BUSINESS' USING PARTICIPATION",
        "END-IF"
      ],
      "steps_generated": true,
      "visibility": "public"
    },
    {
      "description": "Affiche les informations principales de la participation courante sur la console.",
      "display": {
        "lines": [
          {
            "cobol_name": "LK-PARTICIPATION-ID-ACTIVITE",
            "field": "PARTICIPATION.PARTICIPATION_ID_ACTIVITE",
            "label": "ACTIVITE   : "
          },
          {
            "cobol_name": "LK-PARTICIPATION-ID-USER",
            "field": "PARTICIPATION.PARTICIPATION_ID_USER",
            "label": "UTILISATEUR: "
          },
          {
            "cobol_name": "LK-PARTICIPATION-MODE-TRANSPORT",
            "field": "PARTICIPATION.PARTICIPATION_MODE_TRANSPORT",
            "label": "TRANSPORT  : "
          }
        ],
        "separator": "----------------------------------------"
      },
      "entity": "PARTICIPATION",
      "errors_flags": [],
      "id": "FN-PAR-BIZ-DISPLAY",
      "inputs": [
        "PARTICIPATION.PARTICIPATION_ID_ACTIVITE",
        "PARTICIPATION.PARTICIPATION_ID_USER",
        "PARTICIPATION.PARTICIPATION_MODE_TRANSPORT"
      ],
      "layer": "business",
      "modifies": [],
      "name": "DISPLAY-PARTICIPATION",
      "outputs": [],
      "postconditions": [],
      "preconditions": [
        "PARTICIPATION contient des valeurs lues/calculees coherentes."
      ],
      "programme": "PARTICIPATION-BUSINESS",
      "related_exigences": [
        "F4"
      ],
      "required": true,
      "visibility": "public"
    }
  ],
  "mcd": {
    "entites": [
      {
        "attrs": [
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "name": "USER_ID",
            "normalized_name": "USER_ID",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "pk": true,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "X(50)",
            "default": null,
            "name": "USER_NOM",
            "normalized_name": "USER_NOM",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 50
            },
            "nullable": false,
            "sql_type": "VARCHAR(50)",
            "type": "VARCHAR(50)"
          },
          {
            "auto_generated": false,
            "cobol_pic": "X(80)",
            "default": null,
            "name": "USER_MAIL",
            "normalized_name": "USER_MAIL",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 80
            },
            "nullable": false,
            "sql_type": "VARCHAR(80)",
            "type": "VARCHAR(80)",
            "unique": true
          },
          {
            "auto_generated": false,
            "cobol_pic": "X(256)",
            "default": null,
            "name": "USER_PASS",
            "normalized_name": "USER_PASS",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 256
            },
            "nullable": false,
            "sql_type": "VARCHAR(256)",
            "type": "VARCHAR(256)"
          },
          {
            "auto_generated": false,
            "cobol_pic": "X(15)",
            "default": null,
            "name": "USER_ROLE",
            "normalized_name": "USER_ROLE",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 15
            },
            "nullable": false,
            "sql_type": "VARCHAR(15)",
            "type": "VARCHAR(15)"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "fk": true,
            "fk_target": "ANTENNE.ANTENNE_ID",
            "name": "USER_ID_ANTENNE",
            "normalized_name": "USER_ID_ANTENNE",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "S9(11)",
            "default": null,
            "name": "USER_LAST_LOGIN",
            "normalized_name": "USER_LAST_LOGIN",
            "normalized_type": {
              "base": "BIGINT"
            },
            "nullable": true,
            "sql_type": "BIGINT",
            "type": "BIGINT"
          }
        ],
        "name": "UTILISATEUR",
        "normalized_name": "UTILISATEUR"
      },
      {
        "attrs": [
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "name": "ANTENNE_ID",
            "normalized_name": "ANTENNE_ID",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "pk": true,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "X(50)",
            "default": null,
            "name": "ANTENNE_NOM",
            "normalized_name": "ANTENNE_NOM",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 50
            },
            "nullable": false,
            "sql_type": "VARCHAR(50)",
            "type": "VARCHAR(50)"
          },
          {
            "auto_generated": false,
            "cobol_pic": "X(50)",
            "default": null,
            "name": "ANTENNE_REGION",
            "normalized_name": "ANTENNE_REGION",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 50
            },
            "nullable": false,
            "sql_type": "VARCHAR(50)",
            "type": "VARCHAR(50)"
          }
        ],
        "name": "ANTENNE",
        "normalized_name": "ANTENNE"
      },
      {
        "attrs": [
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "name": "ACTIVITE_ID",
            "normalized_name": "ACTIVITE_ID",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "pk": true,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "X(50)",
            "default": null,
            "name": "ACTIVITE_NOM",
            "normalized_name": "ACTIVITE_NOM",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 50
            },
            "nullable": false,
            "sql_type": "VARCHAR(50)",
            "type": "VARCHAR(50)"
          },
          {
            "auto_generated": false,
            "cobol_pic": "X(20)",
            "default": null,
            "name": "ACTIVITE_TYPE",
            "normalized_name": "ACTIVITE_TYPE",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 20
            },
            "nullable": false,
            "sql_type": "VARCHAR(20)",
            "type": "VARCHAR(20)"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "fk": true,
            "fk_target": "ANTENNE.ANTENNE_ID",
            "name": "ACTIVITE_IDANTENNE",
            "normalized_name": "ACTIVITE_IDANTENNE",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "fk": true,
            "fk_target": "UTILISATEUR.USER_ID",
            "name": "ACTIVITE_ANIMATEUR",
            "normalized_name": "ACTIVITE_ANIMATEUR",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "name": "ACTIVITE_NBPARTICIPANTS",
            "normalized_name": "ACTIVITE_NBPARTICIPANTS",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(2)",
            "default": null,
            "name": "ACTIVITE_MODETRANSPORT",
            "normalized_name": "ACTIVITE_MODETRANSPORT",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "X(100)",
            "default": null,
            "name": "ACTIVITE_LIEU",
            "normalized_name": "ACTIVITE_LIEU",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 100
            },
            "nullable": false,
            "sql_type": "VARCHAR(100)",
            "type": "VARCHAR(100)"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(10)",
            "default": null,
            "name": "ACTIVITE_DISTANCE",
            "normalized_name": "ACTIVITE_DISTANCE",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(1)",
            "default": null,
            "name": "ACTIVITE_HEBERGEMENT",
            "normalized_name": "ACTIVITE_HEBERGEMENT",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(1)",
            "default": null,
            "name": "ACTIVITE_REPASPREVU",
            "normalized_name": "ACTIVITE_REPASPREVU",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "S9(9)V9(4)",
            "default": null,
            "name": "ACTIVITE_EMPREINTETOTALE",
            "normalized_name": "ACTIVITE_EMPREINTETOTALE",
            "normalized_type": {
              "base": "DECIMAL",
              "precision": 13,
              "scale": 4
            },
            "nullable": true,
            "sql_type": "DECIMAL(13,4)",
            "type": "DECIMAL(13,4)"
          }
        ],
        "name": "ACTIVITE",
        "normalized_name": "ACTIVITE"
      },
      {
        "attrs": [
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "name": "REPAS_ID",
            "normalized_name": "REPAS_ID",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "pk": true,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "fk": true,
            "fk_target": "ACTIVITE.ACTIVITE_ID",
            "name": "REPAS_ID_ACTIVITE",
            "normalized_name": "REPAS_ID_ACTIVITE",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(2)",
            "default": null,
            "name": "REPAS_TYPE",
            "normalized_name": "REPAS_TYPE",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "S9(5)",
            "default": null,
            "name": "REPAS_NBREPAS",
            "normalized_name": "REPAS_NBREPAS",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          }
        ],
        "name": "REPAS",
        "normalized_name": "REPAS"
      },
      {
        "attrs": [
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "name": "HEBERGEMENT_ID",
            "normalized_name": "HEBERGEMENT_ID",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "pk": true,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "fk": true,
            "fk_target": "ACTIVITE.ACTIVITE_ID",
            "name": "HEBERGEMENT_ID_ACTIVITE",
            "normalized_name": "HEBERGEMENT_ID_ACTIVITE",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(2)",
            "default": null,
            "name": "HEBERGEMENT_TYPE",
            "normalized_name": "HEBERGEMENT_TYPE",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "S9(3)",
            "default": null,
            "name": "HEBERGEMENT_NBNUIT",
            "normalized_name": "HEBERGEMENT_NBNUIT",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          }
        ],
        "name": "HEBERGEMENT",
        "normalized_name": "HEBERGEMENT"
      },
      {
        "attrs": [
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "fk": true,
            "fk_target": "ACTIVITE.ACTIVITE_ID",
            "name": "PARTICIPATION_ID_ACTIVITE",
            "normalized_name": "PARTICIPATION_ID_ACTIVITE",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "pk": true,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(9)",
            "default": null,
            "fk": true,
            "fk_target": "UTILISATEUR.USER_ID",
            "name": "PARTICIPATION_ID_USER",
            "normalized_name": "PARTICIPATION_ID_USER",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "pk": true,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "S9(2)",
            "default": null,
            "name": "PARTICIPATION_MODE_TRANSPORT",
            "normalized_name": "PARTICIPATION_MODE_TRANSPORT",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "sql_type": "INT",
            "type": "INT"
          }
        ],
        "name": "PARTICIPATION",
        "normalized_name": "PARTICIPATION"
      }
    ],
    "relations": [
      {
        "fk_field": "USER_ID_ANTENNE",
        "from": "UTILISATEUR",
        "normalized": {
          "cardinality": "N:1",
          "foreign_keys": []
        },
        "to": "ANTENNE",
        "type": "N:1"
      },
      {
        "fk_field": "ACTIVITE_IDANTENNE",
        "from": "ACTIVITE",
        "normalized": {
          "cardinality": "N:1",
          "foreign_keys": []
        },
        "to": "ANTENNE",
        "type": "N:1"
      },
      {
        "fk_field": "ACTIVITE_ANIMATEUR",
        "from": "ACTIVITE",
        "normalized": {
          "cardinality": "N:1",
          "foreign_keys": []
        },
        "to": "UTILISATEUR",
        "type": "N:1"
      },
      {
        "fk_field": "PARTICIPATION_ID_USER",
        "from": "PARTICIPATION",
        "normalized": {
          "cardinality": "N:1",
          "foreign_keys": []
        },
        "to": "UTILISATEUR",
        "type": "N:1"
      },
      {
        "fk_field": "PARTICIPATION_ID_ACTIVITE",
        "from": "PARTICIPATION",
        "normalized": {
          "cardinality": "N:1",
          "foreign_keys": []
        },
        "to": "ACTIVITE",
        "type": "N:1"
      },
      {
        "fk_field": "REPAS_ID_ACTIVITE",
        "from": "REPAS",
        "normalized": {
          "cardinality": "N:1",
          "foreign_keys": []
        },
        "to": "ACTIVITE",
        "type": "N:1"
      },
      {
        "fk_field": "HEBERGEMENT_ID_ACTIVITE",
        "from": "HEBERGEMENT",
        "normalized": {
          "cardinality": "N:1",
          "foreign_keys": []
        },
        "to": "ACTIVITE",
        "type": "N:1"
      }
    ]
  },
  "metadata": {
    "hash": "0b518daf1dbe8939a4425243275de417e7fa79518312866658b9925873d7ed16",
    "normalized_at": "2026-01-14T00:56:43.954932Z",
    "source_file": "/home/mfabre/pi/cobol_generator/try/carbontrack_minimal.yaml",
    "steps_generated": {
      "count": 28,
      "functions": [
        {
          "count": 59,
          "fonction": "DAL-READ",
          "programme": "ACTIVITE-DAL-DB",
          "validated": true
        },
        {
          "count": 26,
          "fonction": "DAL-SAVE",
          "programme": "ACTIVITE-DAL-DB",
          "validated": true
        },
        {
          "count": 19,
          "fonction": "DAL-END",
          "programme": "ACTIVITE-DAL-DB",
          "validated": true
        },
        {
          "count": 22,
          "fonction": "MAIN-PROCESS",
          "programme": "ACTIVITE-LOGIC",
          "validated": true
        },
        {
          "count": 38,
          "fonction": "DAL-READ",
          "programme": "UTILISATEUR-DAL-DB",
          "validated": true
        },
        {
          "count": 16,
          "fonction": "DAL-SAVE",
          "programme": "UTILISATEUR-DAL-DB",
          "validated": true
        },
        {
          "count": 19,
          "fonction": "DAL-END",
          "programme": "UTILISATEUR-DAL-DB",
          "validated": true
        },
        {
          "count": 22,
          "fonction": "MAIN-PROCESS",
          "programme": "UTILISATEUR-LOGIC",
          "validated": true
        },
        {
          "count": 9,
          "fonction": "DISPLAY-UTILISATEUR",
          "programme": "UTILISATEUR-BUSINESS",
          "validated": true
        },
        {
          "count": 30,
          "fonction": "DAL-READ",
          "programme": "ANTENNE-DAL-DB",
          "validated": true
        },
        {
          "count": 16,
          "fonction": "DAL-SAVE",
          "programme": "ANTENNE-DAL-DB",
          "validated": true
        },
        {
          "count": 22,
          "fonction": "DAL-END",
          "programme": "ANTENNE-DAL-DB",
          "validated": true
        },
        {
          "count": 22,
          "fonction": "MAIN-PROCESS",
          "programme": "ANTENNE-LOGIC",
          "validated": true
        },
        {
          "count": 6,
          "fonction": "DISPLAY-ANTENNE",
          "programme": "ANTENNE-BUSINESS",
          "validated": true
        },
        {
          "count": 36,
          "fonction": "DAL-READ",
          "programme": "REPAS-DAL-DB",
          "validated": true
        },
        {
          "count": 16,
          "fonction": "DAL-SAVE",
          "programme": "REPAS-DAL-DB",
          "validated": true
        },
        {
          "count": 18,
          "fonction": "DAL-END",
          "programme": "REPAS-DAL-DB",
          "validated": true
        },
        {
          "count": 22,
          "fonction": "MAIN-PROCESS",
          "programme": "REPAS-LOGIC",
          "validated": true
        },
        {
          "count": 4,
          "fonction": "CALCULATE-REPAS",
          "programme": "REPAS-LOGIC",
          "validated": true
        },
        {
          "count": 7,
          "fonction": "DISPLAY-REPAS",
          "programme": "REPAS-BUSINESS",
          "validated": true
        },
        {
          "count": 43,
          "fonction": "DAL-READ",
          "programme": "HEBERGEMENT-DAL-DB",
          "validated": true
        },
        {
          "count": 11,
          "fonction": "DAL-SAVE",
          "programme": "HEBERGEMENT-DAL-DB",
          "validated": true
        },
        {
          "count": 19,
          "fonction": "DAL-END",
          "programme": "HEBERGEMENT-DAL-DB",
          "validated": true
        },
        {
          "count": 22,
          "fonction": "MAIN-PROCESS",
          "programme": "HEBERGEMENT-LOGIC",
          "validated": true
        },
        {
          "count": 5,
          "fonction": "CALCULATE-HEBERGEMENT",
          "programme": "HEBERGEMENT-LOGIC",
          "validated": true
        },
        {
          "count": 19,
          "fonction": "DAL-END",
          "programme": "PARTICIPATION-DAL-DB",
          "validated": true
        },
        {
          "count": 22,
          "fonction": "MAIN-PROCESS",
          "programme": "PARTICIPATION-LOGIC",
          "validated": true
        },
        {
          "count": 5,
          "fonction": "CALCULATE-TRANSPORT",
          "programme": "PARTICIPATION-LOGIC",
          "validated": true
        }
      ]
    },
    "version": "1.0.0"
  },
  "naming_rules": {
    "paragraph_style": "VERB-NOUN",
    "prefixes": {
      "flags": "WS-",
      "linkage": "LK-",
      "working_storage": "WS-"
    }
  },
  "nommage": {
    "copybooks_case": "UPPER_SNAKE",
    "programmes_case": "UPPER-KEBAB",
    "tables_case": "UPPER_SNAKE",
    "variables_case": "UPPER_SNAKE"
  },
  "programmes": [
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": false,
      "allowed_sql": true,
      "call_interface": {
        "description": "CALL 'ACTIVITE-DAL-DB' USING OPERATION, END-OF-FILE, ACTIVITE.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-OPERATION",
            "pic": "X(4)"
          },
          {
            "direction": "inout",
            "name": "LK-END-OF-FILE",
            "pic": "X"
          },
          {
            "direction": "inout",
            "name": "LK-ACTIVITE",
            "pic": "groupe ACTIVITE"
          }
        ],
        "operations": {
          "end": "END ",
          "read": "READ",
          "save": "SAVE"
        },
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-ENTRY",
          "using_clause": [
            "LK-OPERATION",
            "LK-END-OF-FILE",
            "LK-ACTIVITE"
          ]
        }
      },
      "entities": [
        "ACTIVITE",
        "ANTENNE",
        "UTILISATEUR"
      ],
      "entry_block_rules": [
        {
          "condition_regex": "^\\s*IF\\s+LK-OPERATION\\s+NOT\\s+(=|EQUAL)\\s+'END '\\s*$",
          "must_contain": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED",
            "MOVE 'Y' TO LK-END-OF-FILE",
            "GOBACK"
          ]
        }
      ],
      "entry_exit_sequence": {
        "must_follow_order": [
          "END-EVALUATE",
          "GOBACK",
          "."
        ],
        "paragraph": "MAIN-ENTRY"
      },
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "MAIN-ENTRY: IF LK-OPERATION NOT = 'END ' THEN PERFORM DAL-CONNECT; IF NOT WS-CONNECTED THEN MOVE 'Y' TO LK-END-OF-FILE, GOBACK; END-IF; END-IF",
        "EVALUATE LK-OPERATION: READ->DAL-READ, SAVE->DAL-SAVE, END->DAL-END, OTHER->DISPLAY erreur",
        "GOBACK apres EVALUATE",
        "DAL-READ: ouverture curseur paresseuse, FETCH, mise a jour EOF",
        "DAL-SAVE: UPDATE ACTIVITE_EMPREINTETOTALE",
        "DAL-END: CLOSE cursor, COMMIT, DISCONNECT, reset flags"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: ACTIVITE-DAL-DB                                    *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour ACTIVITE                       *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "internal_paragraphs": [
        "DAL-CONNECT",
        "DAL-SET-ENV"
      ],
      "layer": "dal",
      "linkage_structure": "01 LK-ACTIVITE.\n    05 LK-ACTIVITE-ID PIC 9(9).\n    05 LK-ACTIVITE-NOM PIC X(50).\n    05 LK-ACTIVITE-TYPE PIC X(20).\n    05 LK-ACTIVITE-IDANTENNE PIC 9(9).\n    05 LK-ACTIVITE-ANIMATEUR PIC 9(9).\n    05 LK-ACTIVITE-NBPART PIC 9(9).\n    05 LK-ACTIVITE-TRANSPORT PIC 9(2).\n    05 LK-ACTIVITE-LIEU PIC X(100).\n    05 LK-ACTIVITE-DISTANCE PIC 9(10).\n    05 LK-ACTIVITE-HEBERG PIC 9(1).\n    05 LK-ACTIVITE-REPAS PIC 9(1).\n    05 LK-ACTIVITE-EMPREINTE PIC S9(9)V9(4).\n    05 LK-ANTENNE-NOM PIC X(50).\n    05 LK-ANTENNE-REGION PIC X(50).\n    05 LK-USER-NOM PIC X(50).\n    05 LK-USER-MAIL PIC X(80).\n",
      "logging_lines": [
        "Connexion DB reussie: carbontrackdb",
        "ERREUR CONNECT: SQLCODE=",
        "SQLSTATE=",
        "SQLERRMC=",
        "Curseur C_ACT ouvert",
        "ERREUR OPEN: SQLCODE=",
        "ERREUR FETCH: SQLCODE=",
        "ERREUR UPDATE: SQLCODE=",
        "ERREUR CLOSE: SQLCODE=",
        "ERREUR COMMIT: SQLCODE=",
        "ERREUR DISCONNECT: SQLCODE=",
        "ERREUR: Operation inconnue: ",
        "Fermeture connexion"
      ],
      "main_cursor": "C_ACT",
      "name": "ACTIVITE-DAL-DB",
      "paragraph_constraints": [
        {
          "forbid_contains": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED"
          ],
          "paragraph": "DAL-READ"
        }
      ],
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: ACTIVITE-DAL-DB                                    *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour ACTIVITE                       *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK",
        "END-CALL",
        "BY REFERENCE",
        "BY VALUE",
        "EXIT PARAGRAPH",
        "EVALUATE SQLCODE"
      ],
      "role": "Couche d acces a la base PostgreSQL pour ACTIVITE (lecture via curseur avec jointure ANTENNE/UTILISATEUR, mise a jour de l empreinte).",
      "style_lines": [
        "CALL OCESQL avec guillemets doubles et END-CALL.",
        "OCESQLConnect avec BY REFERENCE/ BY VALUE (ordre exact).",
        "EXIT PARAGRAPH sur erreur OPEN du curseur.",
        "EVALUATE SQLCODE apres FETCH.",
        "Apres DAL-CONNECT, si NOT WS-CONNECTED: MOVE 'Y' TO LK-END-OF-FILE puis GOBACK.",
        "MAIN-ENTRY se termine strictement par END-EVALUATE, puis GOBACK, puis '.'."
      ],
      "working_storage_lines": [
        "EXEC SQL INCLUDE SQLCA END-EXEC.",
        "01  WS-CONNECTED-FLAG      PIC X VALUE 'N'.",
        "88  WS-CONNECTED           VALUE 'Y'.",
        "01  WS-CURSOR-OPEN-FLAG    PIC X VALUE 'N'.",
        "88  WS-CURSOR-OPEN         VALUE 'Y'.",
        "01  WS-ACTIVITE-ID         PIC 9(9).",
        "01  WS-ACTIVITE-NOM        PIC X(50).",
        "01  WS-ACTIVITE-TYPE       PIC X(20).",
        "01  WS-ACTIVITE-IDANTENNE  PIC 9(9).",
        "01  WS-ACTIVITE-ANIMATEUR  PIC 9(9).",
        "01  WS-ACTIVITE-NBPART     PIC 9(9).",
        "01  WS-ACTIVITE-TRANSPORT  PIC 9(2).",
        "01  WS-ACTIVITE-LIEU       PIC X(100).",
        "01  WS-ACTIVITE-DISTANCE   PIC 9(10).",
        "01  WS-ACTIVITE-HEBERG     PIC 9(1).",
        "01  WS-ACTIVITE-REPAS      PIC 9(1).",
        "01  WS-ACTIVITE-EMPREINTE  PIC S9(9)V9(4).",
        "01  WS-ANTENNE-NOM         PIC X(50).",
        "01  WS-ANTENNE-REGION      PIC X(50).",
        "01  WS-USER-NOM            PIC X(50).",
        "01  WS-USER-MAIL           PIC X(80).",
        "01  WS-DB-NAME.",
        "05  WS-DB-NAME-TEXT     PIC X(13) VALUE 'carbontrackdb'.",
        "05  WS-DB-NAME-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-USER.",
        "05  WS-DB-USER-TEXT     PIC X(10) VALUE 'carbonuser'.",
        "05  WS-DB-USER-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-PASSWORD.",
        "05  WS-DB-PASSWORD-TEXT PIC X(9) VALUE 'CARBONPWD'.",
        "05  WS-DB-PASSWORD-TERM PIC X VALUE X'00'.",
        "01  WS-DB-NAME-LEN         PIC S9(4) COMP-5 VALUE 13.",
        "01  WS-DB-USER-LEN         PIC S9(4) COMP-5 VALUE 10.",
        "01  WS-DB-PASSWORD-LEN     PIC S9(4) COMP-5 VALUE 9.",
        "01  WS-PGHOST-NAME         PIC X(6) VALUE 'PGHOST'.",
        "01  WS-PGHOST-VALUE        PIC X(64) VALUE 'localhost'.",
        "01  WS-PGPORT-NAME         PIC X(6) VALUE 'PGPORT'.",
        "01  WS-PGPORT-VALUE        PIC X(5) VALUE '5432'.",
        "01  WS-PGUSER-NAME         PIC X(6) VALUE 'PGUSER'.",
        "01  WS-PGUSER-VALUE        PIC X(64) VALUE 'carbonuser'.",
        "01  WS-PGPASSWORD-NAME     PIC X(10) VALUE 'PGPASSWORD'.",
        "01  WS-PGPASSWORD-VALUE    PIC X(64) VALUE 'CARBONPWD'.",
        "01  WS-PGDATABASE-NAME     PIC X(10) VALUE 'PGDATABASE'.",
        "01  WS-PGDATABASE-VALUE    PIC X(64) VALUE 'carbontrackdb'."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": true,
      "allowed_sql": false,
      "cobol_sections": {
        "data_division": {
          "linkage": "none",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-PROCESS"
        }
      },
      "entities": [
        "ACTIVITE",
        "ANTENNE",
        "UTILISATEUR"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "Afficher le bandeau de debut",
        "READ initial via DAL (OPERATION='READ')",
        "Boucle jusqu'a EOF: incrementer WS-COUNT-TOTAL, CALCULATE-EMPREINTE, SAVE, BUSINESS display, READ suivant",
        "Appeler DAL avec OPERATION='END '",
        "Afficher le bandeau de fin avec les compteurs",
        "STOP RUN"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: ACTIVITE-LOGIC                                     *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les activites                              *",
        "      *       - Conservation empreinte carbone                        *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************"
      ],
      "layer": "logic",
      "logging_lines": [
        "==========================================",
        "DEBUT TRAITEMENT BATCH ACTIVITES CARBONE",
        "==========================================",
        "==========================================",
        "FIN TRAITEMENT BATCH ACTIVITES CARBONE",
        "Nombre activites traitees: ",
        "Activites en erreur: ",
        "==========================================",
        "ANOMALIE: Empreinte carbone invalide"
      ],
      "name": "ACTIVITE-LOGIC",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: ACTIVITE-LOGIC                                     *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les activites                              *",
        "      *       - Conservation empreinte carbone                        *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************",
        "      *****************************************************************",
        "      * Regle metier F5: conservation empreinte carbone par activite *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "STOP RUN",
        "CALL 'ACTIVITE-DAL-DB' USING OPERATION, END-OF-FILE, ACTIVITE",
        "CALL 'ACTIVITE-BUSINESS' USING ACTIVITE"
      ],
      "role": "Traitement batch principal : boucle sur les activites, sauvegarde de l empreinte, affichage.",
      "style_lines": [
        "Utiliser commentaires de bloc pour les sections majeures.",
        "Afficher les bandeaux debut et fin.",
        "Bloc commentaire CALCULATE-EMPREINTE (verbatim):",
        "      *****************************************************************",
        "      * Regle metier F5: conservation empreinte carbone par activite *",
        "      *****************************************************************"
      ],
      "working_storage_lines": [
        "01  END-OF-FILE            PIC X VALUE 'N'.",
        "88  EOF-REACHED        VALUE 'Y'.",
        "88  NOT-EOF            VALUE 'N'.",
        "77  OPERATION              PIC X(4).",
        "77  WS-COUNT-TOTAL         PIC 9(6) VALUE 0.",
        "77  WS-COUNT-ERROR         PIC 9(6) VALUE 0.",
        "01  ACTIVITE.",
        "    05 ACTIVITE-ID         PIC 9(9).",
        "    05 ACTIVITE-NOM        PIC X(50).",
        "    05 ACTIVITE-TYPE       PIC X(20).",
        "    05 ACTIVITE-IDANTENNE  PIC 9(9).",
        "    05 ACTIVITE-ANIMATEUR  PIC 9(9).",
        "    05 ACTIVITE-NBPART     PIC 9(9).",
        "    05 ACTIVITE-TRANSPORT  PIC 9(2).",
        "    05 ACTIVITE-LIEU       PIC X(100).",
        "    05 ACTIVITE-DISTANCE   PIC 9(10).",
        "    05 ACTIVITE-HEBERG     PIC 9(1).",
        "    05 ACTIVITE-REPAS      PIC 9(1).",
        "    05 ACTIVITE-EMPREINTE  PIC S9(9)V9(4).",
        "    05 ANTENNE-NOM         PIC X(50).",
        "    05 ANTENNE-REGION      PIC X(50).",
        "    05 USER-NOM            PIC X(50).",
        "    05 USER-MAIL           PIC X(80)."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": "lecture_seule",
      "allowed_sql": false,
      "call_interface": {
        "description": "CALL 'ACTIVITE-BUSINESS' USING LK-ACTIVITE.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-ACTIVITE",
            "pic": "groupe ACTIVITE"
          }
        ],
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "DISPLAY-ACTIVITE",
          "using_clause": [
            "LK-ACTIVITE"
          ]
        }
      },
      "entities": [
        "ACTIVITE",
        "ANTENNE",
        "UTILISATEUR"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION."
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: ACTIVITE-BUSINESS                                  *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations activite              *",
        "      *       - Antenne, animateur, lieu, empreinte                   *",
        "      *****************************************************************"
      ],
      "layer": "business",
      "linkage_structure": "01 LK-ACTIVITE.\n    05 LK-ACTIVITE-ID PIC 9(9).\n    05 LK-ACTIVITE-NOM PIC X(50).\n    05 LK-ACTIVITE-TYPE PIC X(20).\n    05 LK-ACTIVITE-IDANTENNE PIC 9(9).\n    05 LK-ACTIVITE-ANIMATEUR PIC 9(9).\n    05 LK-ACTIVITE-NBPART PIC 9(9).\n    05 LK-ACTIVITE-TRANSPORT PIC 9(2).\n    05 LK-ACTIVITE-LIEU PIC X(100).\n    05 LK-ACTIVITE-DISTANCE PIC 9(10).\n    05 LK-ACTIVITE-HEBERG PIC 9(1).\n    05 LK-ACTIVITE-REPAS PIC 9(1).\n    05 LK-ACTIVITE-EMPREINTE PIC S9(9)V9(4).\n    05 LK-ANTENNE-NOM PIC X(50).\n    05 LK-ANTENNE-REGION PIC X(50).\n    05 LK-USER-NOM PIC X(50).\n    05 LK-USER-MAIL PIC X(80).\n",
      "logging_lines": [
        "----------------------------------------",
        "ACTIVITE : ",
        "ID       : ",
        "TYPE     : ",
        "ANTENNE  : ",
        "REGION   : ",
        "ANIMATEUR: ",
        "EMAIL    : ",
        "LIEU     : ",
        "DISTANCE : ",
        "TRANSPORT: ",
        "HEBERG.  : ",
        "REPAS    : ",
        "EMPREINTE: "
      ],
      "name": "ACTIVITE-BUSINESS",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: ACTIVITE-BUSINESS                                  *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations activite              *",
        "      *       - Antenne, animateur, lieu, empreinte                   *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK"
      ],
      "role": "Affichage simple des informations d une activite (antenne, animateur, lieu, empreinte).",
      "style_lines": [
        "GOBACK en fin de paragraphe DISPLAY-ACTIVITE."
      ],
      "working_storage_lines": [
        "WORKING-STORAGE SECTION."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": false,
      "allowed_sql": true,
      "call_interface": {
        "description": "CALL 'UTILISATEUR-DAL-DB' USING OPERATION, END-OF-FILE, UTILISATEUR.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-OPERATION",
            "pic": "X(4)"
          },
          {
            "direction": "inout",
            "name": "LK-END-OF-FILE",
            "pic": "X"
          },
          {
            "direction": "inout",
            "name": "LK-UTILISATEUR",
            "pic": "groupe UTILISATEUR"
          }
        ],
        "operations": {
          "end": "END ",
          "read": "READ",
          "save": "SAVE"
        },
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-ENTRY",
          "using_clause": [
            "LK-OPERATION",
            "LK-END-OF-FILE",
            "LK-UTILISATEUR"
          ]
        }
      },
      "entities": [
        "UTILISATEUR"
      ],
      "entry_block_rules": [
        {
          "condition_regex": "^\\s*IF\\s+LK-OPERATION\\s+NOT\\s+(=|EQUAL)\\s+'END '\\s*$",
          "must_contain": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED",
            "MOVE 'Y' TO LK-END-OF-FILE",
            "GOBACK"
          ]
        }
      ],
      "entry_exit_sequence": {
        "must_follow_order": [
          "END-EVALUATE",
          "GOBACK",
          "."
        ],
        "paragraph": "MAIN-ENTRY"
      },
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "MAIN-ENTRY: IF LK-OPERATION NOT = 'END ' THEN PERFORM DAL-CONNECT; IF NOT WS-CONNECTED THEN MOVE 'Y' TO LK-END-OF-FILE, GOBACK; END-IF; END-IF",
        "EVALUATE LK-OPERATION: READ->DAL-READ, SAVE->DAL-SAVE, END->DAL-END, OTHER->DISPLAY erreur",
        "GOBACK apres EVALUATE",
        "DAL-READ: ouverture curseur paresseuse, FETCH, mise a jour EOF",
        "DAL-SAVE: UPDATE USER_LAST_LOGIN",
        "DAL-END: CLOSE cursor, COMMIT, DISCONNECT, reset flags"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: UTILISATEUR-DAL-DB                                 *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour UTILISATEUR                    *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "internal_paragraphs": [
        "DAL-CONNECT",
        "DAL-SET-ENV"
      ],
      "layer": "dal",
      "logging_lines": [
        "Connexion DB reussie: carbontrackdb",
        "ERREUR CONNECT: SQLCODE=",
        "SQLSTATE=",
        "SQLERRMC=",
        "Curseur C_USER ouvert",
        "ERREUR OPEN: SQLCODE=",
        "ERREUR FETCH: SQLCODE=",
        "ERREUR UPDATE: SQLCODE=",
        "ERREUR CLOSE: SQLCODE=",
        "ERREUR COMMIT: SQLCODE=",
        "ERREUR DISCONNECT: SQLCODE=",
        "ERREUR: Operation inconnue: ",
        "Fermeture connexion"
      ],
      "main_cursor": "C_USER",
      "name": "UTILISATEUR-DAL-DB",
      "paragraph_constraints": [
        {
          "forbid_contains": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED"
          ],
          "paragraph": "DAL-READ"
        }
      ],
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: UTILISATEUR-DAL-DB                                 *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour UTILISATEUR                    *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK",
        "END-CALL",
        "BY REFERENCE",
        "BY VALUE",
        "EXIT PARAGRAPH",
        "EVALUATE SQLCODE"
      ],
      "role": "Couche d acces a la base PostgreSQL pour UTILISATEUR (lecture via curseur et mise a jour du dernier login).",
      "style_lines": [
        "CALL OCESQL avec guillemets doubles et END-CALL.",
        "OCESQLConnect avec BY REFERENCE/ BY VALUE (ordre exact).",
        "EXIT PARAGRAPH sur erreur OPEN du curseur.",
        "EVALUATE SQLCODE apres FETCH.",
        "Apres DAL-CONNECT, si NOT WS-CONNECTED: MOVE 'Y' TO LK-END-OF-FILE puis GOBACK.",
        "MAIN-ENTRY se termine strictement par END-EVALUATE, puis GOBACK, puis '.'."
      ],
      "working_storage_lines": [
        "EXEC SQL INCLUDE SQLCA END-EXEC.",
        "01  WS-CONNECTED-FLAG      PIC X VALUE 'N'.",
        "88  WS-CONNECTED           VALUE 'Y'.",
        "01  WS-CURSOR-OPEN-FLAG    PIC X VALUE 'N'.",
        "88  WS-CURSOR-OPEN         VALUE 'Y'.",
        "01  WS-USER-ID             PIC 9(9).",
        "01  WS-USER-NOM            PIC X(50).",
        "01  WS-USER-MAIL           PIC X(80).",
        "01  WS-USER-PASS           PIC X(256).",
        "01  WS-USER-ROLE           PIC X(15).",
        "01  WS-USER-ID-ANTENNE     PIC 9(9).",
        "01  WS-USER-LAST-LOGIN     PIC S9(11).",
        "01  WS-DB-NAME.",
        "05  WS-DB-NAME-TEXT     PIC X(13) VALUE 'carbontrackdb'.",
        "05  WS-DB-NAME-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-USER.",
        "05  WS-DB-USER-TEXT     PIC X(10) VALUE 'carbonuser'.",
        "05  WS-DB-USER-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-PASSWORD.",
        "05  WS-DB-PASSWORD-TEXT PIC X(9) VALUE 'CARBONPWD'.",
        "05  WS-DB-PASSWORD-TERM PIC X VALUE X'00'.",
        "01  WS-DB-NAME-LEN         PIC S9(4) COMP-5 VALUE 13.",
        "01  WS-DB-USER-LEN         PIC S9(4) COMP-5 VALUE 10.",
        "01  WS-DB-PASSWORD-LEN     PIC S9(4) COMP-5 VALUE 9.",
        "01  WS-PGHOST-NAME         PIC X(6) VALUE 'PGHOST'.",
        "01  WS-PGHOST-VALUE        PIC X(64) VALUE 'localhost'.",
        "01  WS-PGPORT-NAME         PIC X(6) VALUE 'PGPORT'.",
        "01  WS-PGPORT-VALUE        PIC X(5) VALUE '5432'.",
        "01  WS-PGUSER-NAME         PIC X(6) VALUE 'PGUSER'.",
        "01  WS-PGUSER-VALUE        PIC X(64) VALUE 'carbonuser'.",
        "01  WS-PGPASSWORD-NAME     PIC X(10) VALUE 'PGPASSWORD'.",
        "01  WS-PGPASSWORD-VALUE    PIC X(64) VALUE 'CARBONPWD'.",
        "01  WS-PGDATABASE-NAME     PIC X(10) VALUE 'PGDATABASE'.",
        "01  WS-PGDATABASE-VALUE    PIC X(64) VALUE 'carbontrackdb'."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": true,
      "allowed_sql": false,
      "cobol_sections": {
        "data_division": {
          "linkage": "none",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-PROCESS"
        }
      },
      "entities": [
        "UTILISATEUR"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "Afficher le bandeau de debut",
        "READ initial via DAL (OPERATION='READ')",
        "Boucle jusqu'a EOF: incrementer WS-COUNT-TOTAL, CALCULATE-LOGIN, SAVE, BUSINESS display, READ suivant",
        "Appeler DAL avec OPERATION='END '",
        "Afficher le bandeau de fin avec les compteurs",
        "STOP RUN"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: UTILISATEUR-LOGIC                                  *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les utilisateurs                           *",
        "      *       - Mise a jour dernier login                             *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************"
      ],
      "layer": "logic",
      "logging_lines": [
        "==========================================",
        "DEBUT TRAITEMENT BATCH UTILISATEURS",
        "==========================================",
        "==========================================",
        "FIN TRAITEMENT BATCH UTILISATEURS",
        "Nombre utilisateurs traites: ",
        "Utilisateurs en erreur: ",
        "==========================================",
        "ANOMALIE: Dernier login invalide"
      ],
      "name": "UTILISATEUR-LOGIC",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: UTILISATEUR-LOGIC                                  *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les utilisateurs                           *",
        "      *       - Mise a jour dernier login                             *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************",
        "      *****************************************************************",
        "      * Regle metier F1: controle dernier login                      *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "STOP RUN",
        "CALL 'UTILISATEUR-DAL-DB' USING OPERATION, END-OF-FILE, UTILISATEUR",
        "CALL 'UTILISATEUR-BUSINESS' USING UTILISATEUR"
      ],
      "role": "Traitement batch principal : boucle sur les utilisateurs, mise a jour du dernier login, sauvegarde, affichage.",
      "style_lines": [
        "Utiliser commentaires de bloc pour les sections majeures.",
        "Afficher les bandeaux debut et fin.",
        "Bloc commentaire CALCULATE-LOGIN (verbatim):",
        "      *****************************************************************",
        "      * Regle metier F1: controle dernier login                      *",
        "      *****************************************************************"
      ],
      "working_storage_lines": [
        "01  END-OF-FILE            PIC X VALUE 'N'.",
        "88  EOF-REACHED        VALUE 'Y'.",
        "88  NOT-EOF            VALUE 'N'.",
        "77  OPERATION              PIC X(4).",
        "77  WS-COUNT-TOTAL         PIC 9(6) VALUE 0.",
        "77  WS-COUNT-ERROR         PIC 9(6) VALUE 0.",
        "01  UTILISATEUR.",
        "    05 USER-ID             PIC 9(9).",
        "    05 USER-NOM            PIC X(50).",
        "    05 USER-MAIL           PIC X(80).",
        "    05 USER-PASS           PIC X(256).",
        "    05 USER-ROLE           PIC X(15).",
        "    05 USER-ID-ANTENNE     PIC 9(9).",
        "    05 USER-LAST-LOGIN     PIC S9(11)."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": "lecture_seule",
      "allowed_sql": false,
      "call_interface": {
        "description": "CALL 'UTILISATEUR-BUSINESS' USING LK-UTILISATEUR.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-UTILISATEUR",
            "pic": "groupe UTILISATEUR"
          }
        ],
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "DISPLAY-UTILISATEUR",
          "using_clause": [
            "LK-UTILISATEUR"
          ]
        }
      },
      "entities": [
        "UTILISATEUR"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION."
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: UTILISATEUR-BUSINESS                               *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations utilisateur           *",
        "      *       - Nom, email, role, antenne, dernier login              *",
        "      *****************************************************************"
      ],
      "layer": "business",
      "logging_lines": [
        "----------------------------------------",
        "UTILISATEUR: ",
        "ID        : ",
        "NOM       : ",
        "EMAIL     : ",
        "ROLE      : ",
        "ANTENNE   : ",
        "LASTLOGIN : "
      ],
      "name": "UTILISATEUR-BUSINESS",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: UTILISATEUR-BUSINESS                               *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations utilisateur           *",
        "      *       - Nom, email, role, antenne, dernier login              *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK"
      ],
      "role": "Affichage simple des informations d un utilisateur (nom, email, role, antenne, dernier login).",
      "style_lines": [
        "GOBACK en fin de paragraphe DISPLAY-UTILISATEUR."
      ],
      "working_storage_lines": [
        "WORKING-STORAGE SECTION."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": false,
      "allowed_sql": true,
      "call_interface": {
        "description": "CALL 'ANTENNE-DAL-DB' USING OPERATION, END-OF-FILE, ANTENNE.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-OPERATION",
            "pic": "X(4)"
          },
          {
            "direction": "inout",
            "name": "LK-END-OF-FILE",
            "pic": "X"
          },
          {
            "direction": "inout",
            "name": "LK-ANTENNE",
            "pic": "groupe ANTENNE"
          }
        ],
        "operations": {
          "end": "END ",
          "read": "READ",
          "save": "SAVE"
        },
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-ENTRY",
          "using_clause": [
            "LK-OPERATION",
            "LK-END-OF-FILE",
            "LK-ANTENNE"
          ]
        }
      },
      "entities": [
        "ANTENNE"
      ],
      "entry_block_rules": [
        {
          "condition_regex": "^\\s*IF\\s+LK-OPERATION\\s+NOT\\s+(=|EQUAL)\\s+'END '\\s*$",
          "must_contain": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED",
            "MOVE 'Y' TO LK-END-OF-FILE",
            "GOBACK"
          ]
        }
      ],
      "entry_exit_sequence": {
        "must_follow_order": [
          "END-EVALUATE",
          "GOBACK",
          "."
        ],
        "paragraph": "MAIN-ENTRY"
      },
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "MAIN-ENTRY: IF LK-OPERATION NOT = 'END ' THEN PERFORM DAL-CONNECT; IF NOT WS-CONNECTED THEN MOVE 'Y' TO LK-END-OF-FILE, GOBACK; END-IF; END-IF",
        "EVALUATE LK-OPERATION: READ->DAL-READ, SAVE->DAL-SAVE, END->DAL-END, OTHER->DISPLAY erreur",
        "GOBACK apres EVALUATE",
        "DAL-READ: ouverture curseur paresseuse, FETCH, mise a jour EOF",
        "DAL-SAVE: UPDATE ANTENNE_REGION",
        "DAL-END: CLOSE cursor, COMMIT, DISCONNECT, reset flags"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: ANTENNE-DAL-DB                                     *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour ANTENNE                        *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "internal_paragraphs": [
        "DAL-CONNECT",
        "DAL-SET-ENV"
      ],
      "layer": "dal",
      "logging_lines": [
        "Connexion DB reussie: carbontrackdb",
        "ERREUR CONNECT: SQLCODE=",
        "SQLSTATE=",
        "SQLERRMC=",
        "Curseur C_ANT ouvert",
        "ERREUR OPEN: SQLCODE=",
        "ERREUR FETCH: SQLCODE=",
        "ERREUR UPDATE: SQLCODE=",
        "ERREUR CLOSE: SQLCODE=",
        "ERREUR COMMIT: SQLCODE=",
        "ERREUR DISCONNECT: SQLCODE=",
        "ERREUR: Operation inconnue: ",
        "Fermeture connexion"
      ],
      "main_cursor": "C_ANT",
      "name": "ANTENNE-DAL-DB",
      "paragraph_constraints": [
        {
          "forbid_contains": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED"
          ],
          "paragraph": "DAL-READ"
        }
      ],
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: ANTENNE-DAL-DB                                     *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour ANTENNE                        *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK",
        "END-CALL",
        "BY REFERENCE",
        "BY VALUE",
        "EXIT PARAGRAPH",
        "EVALUATE SQLCODE"
      ],
      "role": "Couche d acces a la base PostgreSQL pour ANTENNE (lecture via curseur et mise a jour de la region).",
      "style_lines": [
        "CALL OCESQL avec guillemets doubles et END-CALL.",
        "OCESQLConnect avec BY REFERENCE/ BY VALUE (ordre exact).",
        "EXIT PARAGRAPH sur erreur OPEN du curseur.",
        "EVALUATE SQLCODE apres FETCH.",
        "Apres DAL-CONNECT, si NOT WS-CONNECTED: MOVE 'Y' TO LK-END-OF-FILE puis GOBACK.",
        "MAIN-ENTRY se termine strictement par END-EVALUATE, puis GOBACK, puis '.'."
      ],
      "working_storage_lines": [
        "EXEC SQL INCLUDE SQLCA END-EXEC.",
        "01  WS-CONNECTED-FLAG      PIC X VALUE 'N'.",
        "88  WS-CONNECTED           VALUE 'Y'.",
        "01  WS-CURSOR-OPEN-FLAG    PIC X VALUE 'N'.",
        "88  WS-CURSOR-OPEN         VALUE 'Y'.",
        "01  WS-ANTENNE-ID          PIC 9(9).",
        "01  WS-ANTENNE-NOM         PIC X(50).",
        "01  WS-ANTENNE-REGION      PIC X(50).",
        "01  WS-DB-NAME.",
        "05  WS-DB-NAME-TEXT     PIC X(13) VALUE 'carbontrackdb'.",
        "05  WS-DB-NAME-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-USER.",
        "05  WS-DB-USER-TEXT     PIC X(10) VALUE 'carbonuser'.",
        "05  WS-DB-USER-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-PASSWORD.",
        "05  WS-DB-PASSWORD-TEXT PIC X(9) VALUE 'CARBONPWD'.",
        "05  WS-DB-PASSWORD-TERM PIC X VALUE X'00'.",
        "01  WS-DB-NAME-LEN         PIC S9(4) COMP-5 VALUE 13.",
        "01  WS-DB-USER-LEN         PIC S9(4) COMP-5 VALUE 10.",
        "01  WS-DB-PASSWORD-LEN     PIC S9(4) COMP-5 VALUE 9.",
        "01  WS-PGHOST-NAME         PIC X(6) VALUE 'PGHOST'.",
        "01  WS-PGHOST-VALUE        PIC X(64) VALUE 'localhost'.",
        "01  WS-PGPORT-NAME         PIC X(6) VALUE 'PGPORT'.",
        "01  WS-PGPORT-VALUE        PIC X(5) VALUE '5432'.",
        "01  WS-PGUSER-NAME         PIC X(6) VALUE 'PGUSER'.",
        "01  WS-PGUSER-VALUE        PIC X(64) VALUE 'carbonuser'.",
        "01  WS-PGPASSWORD-NAME     PIC X(10) VALUE 'PGPASSWORD'.",
        "01  WS-PGPASSWORD-VALUE    PIC X(64) VALUE 'CARBONPWD'.",
        "01  WS-PGDATABASE-NAME     PIC X(10) VALUE 'PGDATABASE'.",
        "01  WS-PGDATABASE-VALUE    PIC X(64) VALUE 'carbontrackdb'."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": true,
      "allowed_sql": false,
      "cobol_sections": {
        "data_division": {
          "linkage": "none",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-PROCESS"
        }
      },
      "entities": [
        "ANTENNE"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "Afficher le bandeau de debut",
        "READ initial via DAL (OPERATION='READ')",
        "Boucle jusqu'a EOF: incrementer WS-COUNT-TOTAL, NORMALIZE-REGION, SAVE, BUSINESS display, READ suivant",
        "Appeler DAL avec OPERATION='END '",
        "Afficher le bandeau de fin avec les compteurs",
        "STOP RUN"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: ANTENNE-LOGIC                                      *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les antennes                               *",
        "      *       - Normalisation region                                 *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************"
      ],
      "layer": "logic",
      "logging_lines": [
        "==========================================",
        "DEBUT TRAITEMENT BATCH ANTENNES",
        "==========================================",
        "==========================================",
        "FIN TRAITEMENT BATCH ANTENNES",
        "Nombre antennes traitees: ",
        "Antennes en erreur: ",
        "==========================================",
        "ANOMALIE: Region antenne invalide"
      ],
      "name": "ANTENNE-LOGIC",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: ANTENNE-LOGIC                                      *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les antennes                               *",
        "      *       - Normalisation region                                 *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************",
        "      *****************************************************************",
        "      * Regle metier F2: controle region                              *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "STOP RUN",
        "CALL 'ANTENNE-DAL-DB' USING OPERATION, END-OF-FILE, ANTENNE",
        "CALL 'ANTENNE-BUSINESS' USING ANTENNE"
      ],
      "role": "Traitement batch principal : boucle sur les antennes, normalisation de la region, sauvegarde, affichage.",
      "style_lines": [
        "Utiliser commentaires de bloc pour les sections majeures.",
        "Afficher les bandeaux debut et fin.",
        "Bloc commentaire NORMALIZE-REGION (verbatim):",
        "      *****************************************************************",
        "      * Regle metier F2: controle region                              *",
        "      *****************************************************************"
      ],
      "working_storage_lines": [
        "01  END-OF-FILE            PIC X VALUE 'N'.",
        "88  EOF-REACHED        VALUE 'Y'.",
        "88  NOT-EOF            VALUE 'N'.",
        "77  OPERATION              PIC X(4).",
        "77  WS-COUNT-TOTAL         PIC 9(6) VALUE 0.",
        "77  WS-COUNT-ERROR         PIC 9(6) VALUE 0.",
        "01  ANTENNE.",
        "    05 ANTENNE-ID          PIC 9(9).",
        "    05 ANTENNE-NOM         PIC X(50).",
        "    05 ANTENNE-REGION      PIC X(50)."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": "lecture_seule",
      "allowed_sql": false,
      "call_interface": {
        "description": "CALL 'ANTENNE-BUSINESS' USING LK-ANTENNE.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-ANTENNE",
            "pic": "groupe ANTENNE"
          }
        ],
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "DISPLAY-ANTENNE",
          "using_clause": [
            "LK-ANTENNE"
          ]
        }
      },
      "entities": [
        "ANTENNE"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION."
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: ANTENNE-BUSINESS                                   *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations antenne               *",
        "      *       - Nom, region                                           *",
        "      *****************************************************************"
      ],
      "layer": "business",
      "logging_lines": [
        "----------------------------------------",
        "ANTENNE   : ",
        "ID        : ",
        "NOM       : ",
        "REGION    : "
      ],
      "name": "ANTENNE-BUSINESS",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: ANTENNE-BUSINESS                                   *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations antenne               *",
        "      *       - Nom, region                                           *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK"
      ],
      "role": "Affichage simple des informations d une antenne (nom, region).",
      "style_lines": [
        "GOBACK en fin de paragraphe DISPLAY-ANTENNE."
      ],
      "working_storage_lines": [
        "WORKING-STORAGE SECTION."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": false,
      "allowed_sql": true,
      "call_interface": {
        "description": "CALL 'REPAS-DAL-DB' USING OPERATION, END-OF-FILE, REPAS.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-OPERATION",
            "pic": "X(4)"
          },
          {
            "direction": "inout",
            "name": "LK-END-OF-FILE",
            "pic": "X"
          },
          {
            "direction": "inout",
            "name": "LK-REPAS",
            "pic": "groupe REPAS"
          }
        ],
        "operations": {
          "end": "END ",
          "read": "READ",
          "save": "SAVE"
        },
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-ENTRY",
          "using_clause": [
            "LK-OPERATION",
            "LK-END-OF-FILE",
            "LK-REPAS"
          ]
        }
      },
      "entities": [
        "REPAS"
      ],
      "entry_block_rules": [
        {
          "condition_regex": "^\\s*IF\\s+LK-OPERATION\\s+NOT\\s+(=|EQUAL)\\s+'END '\\s*$",
          "must_contain": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED",
            "MOVE 'Y' TO LK-END-OF-FILE",
            "GOBACK"
          ]
        }
      ],
      "entry_exit_sequence": {
        "must_follow_order": [
          "END-EVALUATE",
          "GOBACK",
          "."
        ],
        "paragraph": "MAIN-ENTRY"
      },
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "MAIN-ENTRY: IF LK-OPERATION NOT = 'END ' THEN PERFORM DAL-CONNECT; IF NOT WS-CONNECTED THEN MOVE 'Y' TO LK-END-OF-FILE, GOBACK; END-IF; END-IF",
        "EVALUATE LK-OPERATION: READ->DAL-READ, SAVE->DAL-SAVE, END->DAL-END, OTHER->DISPLAY erreur",
        "GOBACK apres EVALUATE",
        "DAL-READ: ouverture curseur paresseuse, FETCH, mise a jour EOF",
        "DAL-SAVE: UPDATE REPAS_NBREPAS",
        "DAL-END: CLOSE cursor, COMMIT, DISCONNECT, reset flags"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: REPAS-DAL-DB                                       *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour REPAS                          *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "internal_paragraphs": [
        "DAL-CONNECT",
        "DAL-SET-ENV"
      ],
      "layer": "dal",
      "logging_lines": [
        "Connexion DB reussie: carbontrackdb",
        "ERREUR CONNECT: SQLCODE=",
        "SQLSTATE=",
        "SQLERRMC=",
        "Curseur C_REP ouvert",
        "ERREUR OPEN: SQLCODE=",
        "ERREUR FETCH: SQLCODE=",
        "ERREUR UPDATE: SQLCODE=",
        "ERREUR CLOSE: SQLCODE=",
        "ERREUR COMMIT: SQLCODE=",
        "ERREUR DISCONNECT: SQLCODE=",
        "ERREUR: Operation inconnue: ",
        "Fermeture connexion"
      ],
      "main_cursor": "C_REP",
      "name": "REPAS-DAL-DB",
      "paragraph_constraints": [
        {
          "forbid_contains": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED"
          ],
          "paragraph": "DAL-READ"
        }
      ],
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: REPAS-DAL-DB                                       *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour REPAS                          *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK",
        "END-CALL",
        "BY REFERENCE",
        "BY VALUE",
        "EXIT PARAGRAPH",
        "EVALUATE SQLCODE"
      ],
      "role": "Couche d acces a la base PostgreSQL pour REPAS (lecture via curseur et mise a jour du nombre de repas).",
      "style_lines": [
        "CALL OCESQL avec guillemets doubles et END-CALL.",
        "OCESQLConnect avec BY REFERENCE/ BY VALUE (ordre exact).",
        "EXIT PARAGRAPH sur erreur OPEN du curseur.",
        "EVALUATE SQLCODE apres FETCH.",
        "Apres DAL-CONNECT, si NOT WS-CONNECTED: MOVE 'Y' TO LK-END-OF-FILE puis GOBACK.",
        "MAIN-ENTRY se termine strictement par END-EVALUATE, puis GOBACK, puis '.'."
      ],
      "working_storage_lines": [
        "EXEC SQL INCLUDE SQLCA END-EXEC.",
        "01  WS-CONNECTED-FLAG      PIC X VALUE 'N'.",
        "88  WS-CONNECTED           VALUE 'Y'.",
        "01  WS-CURSOR-OPEN-FLAG    PIC X VALUE 'N'.",
        "88  WS-CURSOR-OPEN         VALUE 'Y'.",
        "01  WS-REPAS-ID            PIC 9(9).",
        "01  WS-REPAS-ID-ACTIVITE   PIC 9(9).",
        "01  WS-REPAS-TYPE          PIC 9(2).",
        "01  WS-REPAS-NBREPAS       PIC S9(5).",
        "01  WS-DB-NAME.",
        "05  WS-DB-NAME-TEXT     PIC X(13) VALUE 'carbontrackdb'.",
        "05  WS-DB-NAME-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-USER.",
        "05  WS-DB-USER-TEXT     PIC X(10) VALUE 'carbonuser'.",
        "05  WS-DB-USER-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-PASSWORD.",
        "05  WS-DB-PASSWORD-TEXT PIC X(9) VALUE 'CARBONPWD'.",
        "05  WS-DB-PASSWORD-TERM PIC X VALUE X'00'.",
        "01  WS-DB-NAME-LEN         PIC S9(4) COMP-5 VALUE 13.",
        "01  WS-DB-USER-LEN         PIC S9(4) COMP-5 VALUE 10.",
        "01  WS-DB-PASSWORD-LEN     PIC S9(4) COMP-5 VALUE 9.",
        "01  WS-PGHOST-NAME         PIC X(6) VALUE 'PGHOST'.",
        "01  WS-PGHOST-VALUE        PIC X(64) VALUE 'localhost'.",
        "01  WS-PGPORT-NAME         PIC X(6) VALUE 'PGPORT'.",
        "01  WS-PGPORT-VALUE        PIC X(5) VALUE '5432'.",
        "01  WS-PGUSER-NAME         PIC X(6) VALUE 'PGUSER'.",
        "01  WS-PGUSER-VALUE        PIC X(64) VALUE 'carbonuser'.",
        "01  WS-PGPASSWORD-NAME     PIC X(10) VALUE 'PGPASSWORD'.",
        "01  WS-PGPASSWORD-VALUE    PIC X(64) VALUE 'CARBONPWD'.",
        "01  WS-PGDATABASE-NAME     PIC X(10) VALUE 'PGDATABASE'.",
        "01  WS-PGDATABASE-VALUE    PIC X(64) VALUE 'carbontrackdb'."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": true,
      "allowed_sql": false,
      "cobol_sections": {
        "data_division": {
          "linkage": "none",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-PROCESS"
        }
      },
      "entities": [
        "REPAS"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "Afficher le bandeau de debut",
        "READ initial via DAL (OPERATION='READ')",
        "Boucle jusqu'a EOF: incrementer WS-COUNT-TOTAL, CALCULATE-REPAS, SAVE, BUSINESS display, READ suivant",
        "Appeler DAL avec OPERATION='END '",
        "Afficher le bandeau de fin avec les compteurs",
        "STOP RUN"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: REPAS-LOGIC                                        *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les repas                                  *",
        "      *       - Controle du nombre de repas                           *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************"
      ],
      "layer": "logic",
      "logging_lines": [
        "==========================================",
        "DEBUT TRAITEMENT BATCH REPAS",
        "==========================================",
        "==========================================",
        "FIN TRAITEMENT BATCH REPAS",
        "Nombre repas traites: ",
        "Repas en erreur: ",
        "==========================================",
        "ANOMALIE: Nombre repas invalide"
      ],
      "name": "REPAS-LOGIC",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: REPAS-LOGIC                                        *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les repas                                  *",
        "      *       - Controle du nombre de repas                           *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************",
        "      *****************************************************************",
        "      * Regle metier F3: controle repas                               *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "STOP RUN",
        "CALL 'REPAS-DAL-DB' USING OPERATION, END-OF-FILE, REPAS",
        "CALL 'REPAS-BUSINESS' USING REPAS"
      ],
      "role": "Traitement batch principal : boucle sur les repas, controle du nombre de repas, sauvegarde, affichage.",
      "style_lines": [
        "Utiliser commentaires de bloc pour les sections majeures.",
        "Afficher les bandeaux debut et fin.",
        "Bloc commentaire CALCULATE-REPAS (verbatim):",
        "      *****************************************************************",
        "      * Regle metier F3: controle repas                               *",
        "      *****************************************************************"
      ],
      "working_storage_lines": [
        "01  END-OF-FILE            PIC X VALUE 'N'.",
        "88  EOF-REACHED        VALUE 'Y'.",
        "88  NOT-EOF            VALUE 'N'.",
        "77  OPERATION              PIC X(4).",
        "77  WS-COUNT-TOTAL         PIC 9(6) VALUE 0.",
        "77  WS-COUNT-ERROR         PIC 9(6) VALUE 0.",
        "01  REPAS.",
        "    05 REPAS-ID            PIC 9(9).",
        "    05 REPAS-ID-ACTIVITE   PIC 9(9).",
        "    05 REPAS-TYPE          PIC 9(2).",
        "    05 REPAS-NBREPAS       PIC S9(5)."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": "lecture_seule",
      "allowed_sql": false,
      "call_interface": {
        "description": "CALL 'REPAS-BUSINESS' USING LK-REPAS.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-REPAS",
            "pic": "groupe REPAS"
          }
        ],
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "DISPLAY-REPAS",
          "using_clause": [
            "LK-REPAS"
          ]
        }
      },
      "entities": [
        "REPAS"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION."
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: REPAS-BUSINESS                                     *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations repas                 *",
        "      *       - Type, nombre                                          *",
        "      *****************************************************************"
      ],
      "layer": "business",
      "logging_lines": [
        "----------------------------------------",
        "REPAS    : ",
        "ID       : ",
        "ACTIVITE : ",
        "TYPE     : ",
        "NBREPAS  : "
      ],
      "name": "REPAS-BUSINESS",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: REPAS-BUSINESS                                     *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations repas                 *",
        "      *       - Type, nombre                                          *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK"
      ],
      "role": "Affichage simple des informations d un repas (type, nombre).",
      "style_lines": [
        "GOBACK en fin de paragraphe DISPLAY-REPAS."
      ],
      "working_storage_lines": [
        "WORKING-STORAGE SECTION."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": false,
      "allowed_sql": true,
      "call_interface": {
        "description": "CALL 'HEBERGEMENT-DAL-DB' USING OPERATION, END-OF-FILE, HEBERGEMENT.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-OPERATION",
            "pic": "X(4)"
          },
          {
            "direction": "inout",
            "name": "LK-END-OF-FILE",
            "pic": "X"
          },
          {
            "direction": "inout",
            "name": "LK-HEBERGEMENT",
            "pic": "groupe HEBERGEMENT"
          }
        ],
        "operations": {
          "end": "END ",
          "read": "READ",
          "save": "SAVE"
        },
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-ENTRY",
          "using_clause": [
            "LK-OPERATION",
            "LK-END-OF-FILE",
            "LK-HEBERGEMENT"
          ]
        }
      },
      "entities": [
        "HEBERGEMENT"
      ],
      "entry_block_rules": [
        {
          "condition_regex": "^\\s*IF\\s+LK-OPERATION\\s+NOT\\s+(=|EQUAL)\\s+'END '\\s*$",
          "must_contain": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED",
            "MOVE 'Y' TO LK-END-OF-FILE",
            "GOBACK"
          ]
        }
      ],
      "entry_exit_sequence": {
        "must_follow_order": [
          "END-EVALUATE",
          "GOBACK",
          "."
        ],
        "paragraph": "MAIN-ENTRY"
      },
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "MAIN-ENTRY: IF LK-OPERATION NOT = 'END ' THEN PERFORM DAL-CONNECT; IF NOT WS-CONNECTED THEN MOVE 'Y' TO LK-END-OF-FILE, GOBACK; END-IF; END-IF",
        "EVALUATE LK-OPERATION: READ->DAL-READ, SAVE->DAL-SAVE, END->DAL-END, OTHER->DISPLAY erreur",
        "GOBACK apres EVALUATE",
        "DAL-READ: ouverture curseur paresseuse, FETCH, mise a jour EOF",
        "DAL-SAVE: UPDATE HEBERGEMENT_NBNUIT",
        "DAL-END: CLOSE cursor, COMMIT, DISCONNECT, reset flags"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: HEBERGEMENT-DAL-DB                                 *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour HEBERGEMENT                    *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "internal_paragraphs": [
        "DAL-CONNECT",
        "DAL-SET-ENV"
      ],
      "layer": "dal",
      "logging_lines": [
        "Connexion DB reussie: carbontrackdb",
        "ERREUR CONNECT: SQLCODE=",
        "SQLSTATE=",
        "SQLERRMC=",
        "Curseur C_HEB ouvert",
        "ERREUR OPEN: SQLCODE=",
        "ERREUR FETCH: SQLCODE=",
        "ERREUR UPDATE: SQLCODE=",
        "ERREUR CLOSE: SQLCODE=",
        "ERREUR COMMIT: SQLCODE=",
        "ERREUR DISCONNECT: SQLCODE=",
        "ERREUR: Operation inconnue: ",
        "Fermeture connexion"
      ],
      "main_cursor": "C_HEB",
      "name": "HEBERGEMENT-DAL-DB",
      "paragraph_constraints": [
        {
          "forbid_contains": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED"
          ],
          "paragraph": "DAL-READ"
        }
      ],
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: HEBERGEMENT-DAL-DB                                 *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour HEBERGEMENT                    *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK",
        "END-CALL",
        "BY REFERENCE",
        "BY VALUE",
        "EXIT PARAGRAPH",
        "EVALUATE SQLCODE"
      ],
      "role": "Couche d acces a la base PostgreSQL pour HEBERGEMENT (lecture via curseur et mise a jour du nombre de nuits).",
      "style_lines": [
        "CALL OCESQL avec guillemets doubles et END-CALL.",
        "OCESQLConnect avec BY REFERENCE/ BY VALUE (ordre exact).",
        "EXIT PARAGRAPH sur erreur OPEN du curseur.",
        "EVALUATE SQLCODE apres FETCH.",
        "Apres DAL-CONNECT, si NOT WS-CONNECTED: MOVE 'Y' TO LK-END-OF-FILE puis GOBACK.",
        "MAIN-ENTRY se termine strictement par END-EVALUATE, puis GOBACK, puis '.'."
      ],
      "working_storage_lines": [
        "EXEC SQL INCLUDE SQLCA END-EXEC.",
        "01  WS-CONNECTED-FLAG      PIC X VALUE 'N'.",
        "88  WS-CONNECTED           VALUE 'Y'.",
        "01  WS-CURSOR-OPEN-FLAG    PIC X VALUE 'N'.",
        "88  WS-CURSOR-OPEN         VALUE 'Y'.",
        "01  WS-HEBERGEMENT-ID      PIC 9(9).",
        "01  WS-HEBERG-ID-ACTIVITE  PIC 9(9).",
        "01  WS-HEBERGEMENT-TYPE    PIC 9(2).",
        "01  WS-HEBERGEMENT-NBNUIT  PIC S9(3).",
        "01  WS-DB-NAME.",
        "05  WS-DB-NAME-TEXT     PIC X(13) VALUE 'carbontrackdb'.",
        "05  WS-DB-NAME-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-USER.",
        "05  WS-DB-USER-TEXT     PIC X(10) VALUE 'carbonuser'.",
        "05  WS-DB-USER-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-PASSWORD.",
        "05  WS-DB-PASSWORD-TEXT PIC X(9) VALUE 'CARBONPWD'.",
        "05  WS-DB-PASSWORD-TERM PIC X VALUE X'00'.",
        "01  WS-DB-NAME-LEN         PIC S9(4) COMP-5 VALUE 13.",
        "01  WS-DB-USER-LEN         PIC S9(4) COMP-5 VALUE 10.",
        "01  WS-DB-PASSWORD-LEN     PIC S9(4) COMP-5 VALUE 9.",
        "01  WS-PGHOST-NAME         PIC X(6) VALUE 'PGHOST'.",
        "01  WS-PGHOST-VALUE        PIC X(64) VALUE 'localhost'.",
        "01  WS-PGPORT-NAME         PIC X(6) VALUE 'PGPORT'.",
        "01  WS-PGPORT-VALUE        PIC X(5) VALUE '5432'.",
        "01  WS-PGUSER-NAME         PIC X(6) VALUE 'PGUSER'.",
        "01  WS-PGUSER-VALUE        PIC X(64) VALUE 'carbonuser'.",
        "01  WS-PGPASSWORD-NAME     PIC X(10) VALUE 'PGPASSWORD'.",
        "01  WS-PGPASSWORD-VALUE    PIC X(64) VALUE 'CARBONPWD'.",
        "01  WS-PGDATABASE-NAME     PIC X(10) VALUE 'PGDATABASE'.",
        "01  WS-PGDATABASE-VALUE    PIC X(64) VALUE 'carbontrackdb'."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": true,
      "allowed_sql": false,
      "cobol_sections": {
        "data_division": {
          "linkage": "none",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-PROCESS"
        }
      },
      "entities": [
        "HEBERGEMENT"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "Afficher le bandeau de debut",
        "READ initial via DAL (OPERATION='READ')",
        "Boucle jusqu'a EOF: incrementer WS-COUNT-TOTAL, CALCULATE-HEBERGEMENT, SAVE, BUSINESS display, READ suivant",
        "Appeler DAL avec OPERATION='END '",
        "Afficher le bandeau de fin avec les compteurs",
        "STOP RUN"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: HEBERGEMENT-LOGIC                                  *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les hebergements                           *",
        "      *       - Controle du nombre de nuits                           *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************"
      ],
      "layer": "logic",
      "logging_lines": [
        "==========================================",
        "DEBUT TRAITEMENT BATCH HEBERGEMENTS",
        "==========================================",
        "==========================================",
        "FIN TRAITEMENT BATCH HEBERGEMENTS",
        "Nombre hebergements traites: ",
        "Hebergements en erreur: ",
        "==========================================",
        "ANOMALIE: Nombre nuits invalide"
      ],
      "name": "HEBERGEMENT-LOGIC",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: HEBERGEMENT-LOGIC                                  *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les hebergements                           *",
        "      *       - Controle du nombre de nuits                           *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************",
        "      *****************************************************************",
        "      * Regle metier F3: controle hebergement                         *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "STOP RUN",
        "CALL 'HEBERGEMENT-DAL-DB' USING OPERATION, END-OF-FILE, HEBERGEMENT",
        "CALL 'HEBERGEMENT-BUSINESS' USING HEBERGEMENT"
      ],
      "role": "Traitement batch principal : boucle sur les hebergements, controle du nombre de nuits, sauvegarde, affichage.",
      "style_lines": [
        "Utiliser commentaires de bloc pour les sections majeures.",
        "Afficher les bandeaux debut et fin.",
        "Bloc commentaire CALCULATE-HEBERGEMENT (verbatim):",
        "      *****************************************************************",
        "      * Regle metier F3: controle hebergement                         *",
        "      *****************************************************************"
      ],
      "working_storage_lines": [
        "01  END-OF-FILE            PIC X VALUE 'N'.",
        "88  EOF-REACHED        VALUE 'Y'.",
        "88  NOT-EOF            VALUE 'N'.",
        "77  OPERATION              PIC X(4).",
        "77  WS-COUNT-TOTAL         PIC 9(6) VALUE 0.",
        "77  WS-COUNT-ERROR         PIC 9(6) VALUE 0.",
        "01  HEBERGEMENT.",
        "    05 HEBERGEMENT-ID      PIC 9(9).",
        "    05 HEBERG-ID-ACTIVITE  PIC 9(9).",
        "    05 HEBERGEMENT-TYPE    PIC 9(2).",
        "    05 HEBERGEMENT-NBNUIT  PIC S9(3)."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": "lecture_seule",
      "allowed_sql": false,
      "call_interface": {
        "description": "CALL 'HEBERGEMENT-BUSINESS' USING LK-HEBERGEMENT.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-HEBERGEMENT",
            "pic": "groupe HEBERGEMENT"
          }
        ],
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "DISPLAY-HEBERGEMENT",
          "using_clause": [
            "LK-HEBERGEMENT"
          ]
        }
      },
      "entities": [
        "HEBERGEMENT"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION."
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: HEBERGEMENT-BUSINESS                               *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations hebergement           *",
        "      *       - Type, nombre de nuits                                 *",
        "      *****************************************************************"
      ],
      "layer": "business",
      "logging_lines": [
        "----------------------------------------",
        "HEBERG. : ",
        "ID      : ",
        "ACTIVITE: ",
        "TYPE    : ",
        "NBNUIT  : "
      ],
      "name": "HEBERGEMENT-BUSINESS",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: HEBERGEMENT-BUSINESS                               *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations hebergement           *",
        "      *       - Type, nombre de nuits                                 *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK"
      ],
      "role": "Affichage simple des informations d un hebergement (type, nombre de nuits).",
      "style_lines": [
        "GOBACK en fin de paragraphe DISPLAY-HEBERGEMENT."
      ],
      "working_storage_lines": [
        "WORKING-STORAGE SECTION."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": false,
      "allowed_sql": true,
      "call_interface": {
        "description": "CALL 'PARTICIPATION-DAL-DB' USING OPERATION, END-OF-FILE, PARTICIPATION.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-OPERATION",
            "pic": "X(4)"
          },
          {
            "direction": "inout",
            "name": "LK-END-OF-FILE",
            "pic": "X"
          },
          {
            "direction": "inout",
            "name": "LK-PARTICIPATION",
            "pic": "groupe PARTICIPATION"
          }
        ],
        "operations": {
          "end": "END ",
          "read": "READ",
          "save": "SAVE"
        },
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-ENTRY",
          "using_clause": [
            "LK-OPERATION",
            "LK-END-OF-FILE",
            "LK-PARTICIPATION"
          ]
        }
      },
      "entities": [
        "PARTICIPATION"
      ],
      "entry_block_rules": [
        {
          "condition_regex": "^\\s*IF\\s+LK-OPERATION\\s+NOT\\s+(=|EQUAL)\\s+'END '\\s*$",
          "must_contain": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED",
            "MOVE 'Y' TO LK-END-OF-FILE",
            "GOBACK"
          ]
        }
      ],
      "entry_exit_sequence": {
        "must_follow_order": [
          "END-EVALUATE",
          "GOBACK",
          "."
        ],
        "paragraph": "MAIN-ENTRY"
      },
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "MAIN-ENTRY: IF LK-OPERATION NOT = 'END ' THEN PERFORM DAL-CONNECT; IF NOT WS-CONNECTED THEN MOVE 'Y' TO LK-END-OF-FILE, GOBACK; END-IF; END-IF",
        "EVALUATE LK-OPERATION: READ->DAL-READ, SAVE->DAL-SAVE, END->DAL-END, OTHER->DISPLAY erreur",
        "GOBACK apres EVALUATE",
        "DAL-READ: ouverture curseur paresseuse, FETCH, mise a jour EOF",
        "DAL-SAVE: UPDATE PARTICIPATION_MODE_TRANSPORT",
        "DAL-END: CLOSE cursor, COMMIT, DISCONNECT, reset flags"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: PARTICIPATION-DAL-DB                               *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour PARTICIPATION                  *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "internal_paragraphs": [
        "DAL-CONNECT",
        "DAL-SET-ENV"
      ],
      "layer": "dal",
      "logging_lines": [
        "Connexion DB reussie: carbontrackdb",
        "ERREUR CONNECT: SQLCODE=",
        "SQLSTATE=",
        "SQLERRMC=",
        "Curseur C_PAR ouvert",
        "ERREUR OPEN: SQLCODE=",
        "ERREUR FETCH: SQLCODE=",
        "ERREUR UPDATE: SQLCODE=",
        "ERREUR CLOSE: SQLCODE=",
        "ERREUR COMMIT: SQLCODE=",
        "ERREUR DISCONNECT: SQLCODE=",
        "ERREUR: Operation inconnue: ",
        "Fermeture connexion"
      ],
      "main_cursor": "C_PAR",
      "name": "PARTICIPATION-DAL-DB",
      "paragraph_constraints": [
        {
          "forbid_contains": [
            "PERFORM DAL-CONNECT",
            "IF NOT WS-CONNECTED"
          ],
          "paragraph": "DAL-READ"
        }
      ],
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: PARTICIPATION-DAL-DB                               *",
        "      * Couche: DAL (Data Access Layer)                               *",
        "      * Role: Acces a la base PostgreSQL pour PARTICIPATION                  *",
        "      *       Operations: READ, SAVE, END                             *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK",
        "END-CALL",
        "BY REFERENCE",
        "BY VALUE",
        "EXIT PARAGRAPH",
        "EVALUATE SQLCODE"
      ],
      "role": "Couche d acces a la base PostgreSQL pour PARTICIPATION (lecture via curseur et mise a jour du mode transport).",
      "style_lines": [
        "CALL OCESQL avec guillemets doubles et END-CALL.",
        "OCESQLConnect avec BY REFERENCE/ BY VALUE (ordre exact).",
        "EXIT PARAGRAPH sur erreur OPEN du curseur.",
        "EVALUATE SQLCODE apres FETCH.",
        "Apres DAL-CONNECT, si NOT WS-CONNECTED: MOVE 'Y' TO LK-END-OF-FILE puis GOBACK.",
        "MAIN-ENTRY se termine strictement par END-EVALUATE, puis GOBACK, puis '.'."
      ],
      "working_storage_lines": [
        "EXEC SQL INCLUDE SQLCA END-EXEC.",
        "01  WS-CONNECTED-FLAG      PIC X VALUE 'N'.",
        "88  WS-CONNECTED           VALUE 'Y'.",
        "01  WS-CURSOR-OPEN-FLAG    PIC X VALUE 'N'.",
        "88  WS-CURSOR-OPEN         VALUE 'Y'.",
        "01  WS-PART-ID-ACTIVITE    PIC 9(9).",
        "01  WS-PART-ID-USER        PIC 9(9).",
        "01  WS-PART-MODE-TRANSPORT PIC S9(2).",
        "01  WS-DB-NAME.",
        "05  WS-DB-NAME-TEXT     PIC X(13) VALUE 'carbontrackdb'.",
        "05  WS-DB-NAME-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-USER.",
        "05  WS-DB-USER-TEXT     PIC X(10) VALUE 'carbonuser'.",
        "05  WS-DB-USER-TERM     PIC X VALUE X'00'.",
        "01  WS-DB-PASSWORD.",
        "05  WS-DB-PASSWORD-TEXT PIC X(9) VALUE 'CARBONPWD'.",
        "05  WS-DB-PASSWORD-TERM PIC X VALUE X'00'.",
        "01  WS-DB-NAME-LEN         PIC S9(4) COMP-5 VALUE 13.",
        "01  WS-DB-USER-LEN         PIC S9(4) COMP-5 VALUE 10.",
        "01  WS-DB-PASSWORD-LEN     PIC S9(4) COMP-5 VALUE 9.",
        "01  WS-PGHOST-NAME         PIC X(6) VALUE 'PGHOST'.",
        "01  WS-PGHOST-VALUE        PIC X(64) VALUE 'localhost'.",
        "01  WS-PGPORT-NAME         PIC X(6) VALUE 'PGPORT'.",
        "01  WS-PGPORT-VALUE        PIC X(5) VALUE '5432'.",
        "01  WS-PGUSER-NAME         PIC X(6) VALUE 'PGUSER'.",
        "01  WS-PGUSER-VALUE        PIC X(64) VALUE 'carbonuser'.",
        "01  WS-PGPASSWORD-NAME     PIC X(10) VALUE 'PGPASSWORD'.",
        "01  WS-PGPASSWORD-VALUE    PIC X(64) VALUE 'CARBONPWD'.",
        "01  WS-PGDATABASE-NAME     PIC X(10) VALUE 'PGDATABASE'.",
        "01  WS-PGDATABASE-VALUE    PIC X(64) VALUE 'carbontrackdb'."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": true,
      "allowed_sql": false,
      "cobol_sections": {
        "data_division": {
          "linkage": "none",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-PROCESS"
        }
      },
      "entities": [
        "PARTICIPATION"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION.",
        "CONFIGURATION SECTION.",
        "REPOSITORY.",
        "    FUNCTION ALL INTRINSIC."
      ],
      "flow": [
        "Afficher le bandeau de debut",
        "READ initial via DAL (OPERATION='READ')",
        "Boucle jusqu'a EOF: incrementer WS-COUNT-TOTAL, CALCULATE-TRANSPORT, SAVE, BUSINESS display, READ suivant",
        "Appeler DAL avec OPERATION='END '",
        "Afficher le bandeau de fin avec les compteurs",
        "STOP RUN"
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: PARTICIPATION-LOGIC                                *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les participations                         *",
        "      *       - Controle du mode transport                            *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************"
      ],
      "layer": "logic",
      "logging_lines": [
        "==========================================",
        "DEBUT TRAITEMENT BATCH PARTICIPATIONS",
        "==========================================",
        "==========================================",
        "FIN TRAITEMENT BATCH PARTICIPATIONS",
        "Nombre participations traitees: ",
        "Participations en erreur: ",
        "==========================================",
        "ANOMALIE: Mode transport invalide"
      ],
      "name": "PARTICIPATION-LOGIC",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: PARTICIPATION-LOGIC                                *",
        "      * Couche: LOGIC (Orchestration)                                 *",
        "      * Role: Traitement batch principal                              *",
        "      *       - Boucle sur les participations                         *",
        "      *       - Controle du mode transport                            *",
        "      *       - Sauvegarde en base                                    *",
        "      *       - Affichage des resultats                               *",
        "      *****************************************************************",
        "      *****************************************************************",
        "      * Regle metier F4: controle mode transport                      *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "STOP RUN",
        "CALL 'PARTICIPATION-DAL-DB' USING OPERATION, END-OF-FILE, PARTICIPATION",
        "CALL 'PARTICIPATION-BUSINESS' USING PARTICIPATION"
      ],
      "role": "Traitement batch principal : boucle sur les participations, controle du mode transport, sauvegarde, affichage.",
      "style_lines": [
        "Utiliser commentaires de bloc pour les sections majeures.",
        "Afficher les bandeaux debut et fin.",
        "Bloc commentaire CALCULATE-TRANSPORT (verbatim):",
        "      *****************************************************************",
        "      * Regle metier F4: controle mode transport                      *",
        "      *****************************************************************"
      ],
      "working_storage_lines": [
        "01  END-OF-FILE            PIC X VALUE 'N'.",
        "88  EOF-REACHED        VALUE 'Y'.",
        "88  NOT-EOF            VALUE 'N'.",
        "77  OPERATION              PIC X(4).",
        "77  WS-COUNT-TOTAL         PIC 9(6) VALUE 0.",
        "77  WS-COUNT-ERROR         PIC 9(6) VALUE 0.",
        "01  PARTICIPATION.",
        "    05 PARTICIPATION-ID-ACTIVITE     PIC 9(9).",
        "    05 PARTICIPATION-ID-USER         PIC 9(9).",
        "    05 PARTICIPATION-MODE-TRANSPORT  PIC S9(2)."
      ]
    },
    {
      "allow_display": true,
      "allow_procedure_sections": false,
      "allowed_business_logic": "lecture_seule",
      "allowed_sql": false,
      "call_interface": {
        "description": "CALL 'PARTICIPATION-BUSINESS' USING LK-PARTICIPATION.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-PARTICIPATION",
            "pic": "groupe PARTICIPATION"
          }
        ],
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "required",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "DISPLAY-PARTICIPATION",
          "using_clause": [
            "LK-PARTICIPATION"
          ]
        }
      },
      "entities": [
        "PARTICIPATION"
      ],
      "environment_lines": [
        "ENVIRONMENT DIVISION."
      ],
      "header_comment_lines": [
        "      *****************************************************************",
        "      * Programme: PARTICIPATION-BUSINESS                             *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations participation         *",
        "      *       - Activite, utilisateur, mode transport                 *",
        "      *****************************************************************"
      ],
      "layer": "business",
      "logging_lines": [
        "----------------------------------------",
        "PARTICIPATION: ",
        "ACTIVITE     : ",
        "UTILISATEUR  : ",
        "TRANSPORT    : "
      ],
      "name": "PARTICIPATION-BUSINESS",
      "require_working_storage_section": true,
      "required_lines": [
        "      *****************************************************************",
        "      * Programme: PARTICIPATION-BUSINESS                             *",
        "      * Couche: BUSINESS (Presentation)                               *",
        "      * Role: Affichage simple des informations participation         *",
        "      *       - Activite, utilisateur, mode transport                 *",
        "      *****************************************************************"
      ],
      "required_statements": [
        "GOBACK"
      ],
      "role": "Affichage simple des informations d une participation (activite, utilisateur, mode transport).",
      "style_lines": [
        "GOBACK en fin de paragraphe DISPLAY-PARTICIPATION."
      ],
      "working_storage_lines": [
        "WORKING-STORAGE SECTION."
      ]
    }
  ],
  "prompting": {
    "forbidden_items": [
      "GO TO",
      "*>"
    ],
    "formatting_guidelines": [
      "Format FIXED: instructions commencent en colonne 8 (prefixe de 7 espaces).",
      "Commentaires: '*' en colonne 7 (6 espaces + '*'), pas de commentaires '*>'.",
      "Ne pas utiliser '>>SOURCE FORMAT FREE'.",
      "PARAGRAPHES: Nom + point sur meme ligne. Format: MAIN-PROCESS. JAMAIS de point seul sur ligne.",
      "En DATA DIVISION, chaque ligne 01/05/77/88 avec PIC ou VALUE se termine par un point.",
      "Aucune ligne ne doit depasser 72 colonnes (format FIXED).",
      "Si une instruction depasse 72 colonnes, la scinder sur plusieurs lignes.",
      "Pour EXEC SQL FETCH/SELECT/UPDATE: mettre chaque variable hote sur sa propre ligne.",
      "Ne pas mettre de point en fin de DISPLAY/GOBACK/STOP RUN/CALL/MOVE/IF (sauf EXEC SQL INCLUDE SQLCA END-EXEC.).",
      "Utiliser des guillemets simples pour les messages DISPLAY.",
      "Respecter l'ordre: IDENTIFICATION -> ENVIRONMENT -> DATA -> PROCEDURE.",
      "Dans DATA: WORKING-STORAGE puis LINKAGE (si present)."
    ],
    "generation_strategy": [
      "1) Construis d'abord le squelette COBOL complet (DIVISION/SECTION) dans l'ordre.",
      "2) Insere les blocs WORKING-STORAGE/LINKAGE exacts fournis par la spec.",
      "3) Ecris la PROCEDURE DIVISION en suivant le flow et les fonctions.",
      "4) REGLE CRITIQUE FERMETURE: Pour toute fonction ouverte (OPEN cursor, EVALUATE, IF, PERFORM), tu DOIS la fermer (CLOSE, END-EVALUATE, END-IF, END-PERFORM).",
      "5) Verifie la coherence: aucune variable/paragraphes inventes."
    ],
    "global_constraints": [
      "Reponds uniquement avec du code COBOL compilable, sans Markdown ni texte autour.",
      "La premiere ligne doit etre IDENTIFICATION DIVISION.",
      "Un seul PROGRAM-ID, pas de sous-programmes."
    ],
    "global_directives": [
      "Utilise strictement les identifiants, messages, SQL et sequences definis dans la spec.",
      "N'invente aucune variable, paragraphe, message ou SQL.",
      "Respecte exactement les listes de WORKING-STORAGE, LINKAGE et USING.",
      "Toujours utiliser les terminateurs explicites END-IF / END-EVALUATE / END-PERFORM / END-EXEC.",
      "Pas de GO TO, pas de logique DAL dans LOGIC, pas de SQL hors DAL.",
      "Toute variable utilisee doit etre declaree (WORKING-STORAGE ou LINKAGE).",
      "REGLE ABSOLUE PARAGRAPHES: Le nom ET le point sur la MEME ligne. Format: CALCULATE-FEES. JAMAIS de ligne avec juste un point apres.",
      "REGLE ABSOLUE EXEC SQL INCLUDE: EXEC SQL INCLUDE SQLCA END-EXEC. (avec point final). Autres instructions COBOL sans point final.",
      "REGLE ABSOLUE QUALIFICATION: Sous-champs avec OF obligatoire. Format: AMOUNT-BRUT OF OPERATION-REC.",
      "Dans DATA DIVISION (WORKING-STORAGE/LINKAGE), toute ligne 01/05/77/88 avec PIC ou VALUE doit se terminer par un point. Regle non applicable en PROCEDURE DIVISION."
    ]
  },
  "sql": {
    "behavior": {
      "check_sqlcode": true,
      "check_sqlstate": true,
      "commit": {
        "mode": "end",
        "statement": "EXEC SQL COMMIT END-EXEC."
      },
      "cursor_commit_policy": "no_commit_while_open",
      "disconnect": {
        "statement": "EXEC SQL DISCONNECT ALL END-EXEC."
      },
      "null_indicators": false,
      "rollback_on_error": false,
      "sqlcode_eof": 100,
      "sqlcode_success": 0
    },
    "connection": {
      "dbname": "carbontrackdb",
      "engine": "postgres",
      "env_set_method": [
        "DISPLAY <ENV_NAME> UPON ENVIRONMENT-NAME",
        "DISPLAY <ENV_VALUE> UPON ENVIRONMENT-VALUE"
      ],
      "env_vars": {
        "PGDATABASE": "carbontrackdb",
        "PGHOST": "localhost",
        "PGPASSWORD": "CARBONPWD",
        "PGPORT": "5432",
        "PGUSER": "carbonuser"
      },
      "host": "localhost",
      "method": "ocesql",
      "ocesql": {
        "connect_args": [
          "SQLCA",
          "WS-DB-USER",
          "WS-DB-USER-LEN",
          "WS-DB-PASSWORD",
          "WS-DB-PASSWORD-LEN",
          "WS-DB-NAME",
          "WS-DB-NAME-LEN"
        ],
        "connect_args_order_note": "CRITIQUE: RESPECTE EXACTEMENT L'ORDRE des parametres ci-dessus dans le CALL. Ne les inverse JAMAIS. order: SQLCA, user, user_len, password, password_len, dbname, dbname_len",
        "connect_call": "OCESQLConnect",
        "end_call": "OCESQLEndSQL",
        "start_call": "OCESQLStartSQL"
      },
      "password": "CARBONPWD",
      "port": 5432,
      "user": "carbonuser"
    },
    "ddl": {
      "ACTIVITE": "CREATE TABLE ACTIVITE (\n    ACTIVITE_ID INT PRIMARY KEY,\n    ACTIVITE_NOM VARCHAR(50) NOT NULL,\n    ACTIVITE_TYPE VARCHAR(20) NOT NULL,\n    ACTIVITE_IDANTENNE INT NOT NULL REFERENCES ANTENNE(ANTENNE_ID),\n    ACTIVITE_ANIMATEUR INT NOT NULL REFERENCES UTILISATEUR(USER_ID),\n    ACTIVITE_NBPARTICIPANTS INT NOT NULL,\n    ACTIVITE_MODETRANSPORT INT NOT NULL,\n    ACTIVITE_LIEU VARCHAR(100) NOT NULL,\n    ACTIVITE_DISTANCE INT NOT NULL,\n    ACTIVITE_HEBERGEMENT INT NOT NULL,\n    ACTIVITE_REPASPREVU INT NOT NULL,\n    ACTIVITE_EMPREINTETOTALE DECIMAL(13,4)\n);\n",
      "ANTENNE": "CREATE TABLE ANTENNE (\n    ANTENNE_ID INT PRIMARY KEY,\n    ANTENNE_NOM VARCHAR(50) NOT NULL,\n    ANTENNE_REGION VARCHAR(50) NOT NULL\n);\n",
      "HEBERGEMENT": "CREATE TABLE HEBERGEMENT (\n    HEBERGEMENT_ID INT PRIMARY KEY,\n    HEBERGEMENT_ID_ACTIVITE INT NOT NULL REFERENCES ACTIVITE(ACTIVITE_ID),\n    HEBERGEMENT_TYPE INT NOT NULL,\n    HEBERGEMENT_NBNUIT INT NOT NULL\n);\n",
      "PARTICIPATION": "CREATE TABLE PARTICIPATION (\n    PARTICIPATION_ID_ACTIVITE INT NOT NULL REFERENCES ACTIVITE(ACTIVITE_ID),\n    PARTICIPATION_ID_USER INT NOT NULL REFERENCES UTILISATEUR(USER_ID),\n    PARTICIPATION_MODE_TRANSPORT INT NOT NULL,\n    PRIMARY KEY (PARTICIPATION_ID_ACTIVITE, PARTICIPATION_ID_USER)\n);\n",
      "REPAS": "CREATE TABLE REPAS (\n    REPAS_ID INT PRIMARY KEY,\n    REPAS_ID_ACTIVITE INT NOT NULL REFERENCES ACTIVITE(ACTIVITE_ID),\n    REPAS_TYPE INT NOT NULL,\n    REPAS_NBREPAS INT NOT NULL\n);\n",
      "UTILISATEUR": "CREATE TABLE UTILISATEUR (\n    USER_ID INT PRIMARY KEY,\n    USER_NOM VARCHAR(50) NOT NULL,\n    USER_MAIL VARCHAR(80) NOT NULL UNIQUE,\n    USER_PASS VARCHAR(256) NOT NULL,\n    USER_ROLE VARCHAR(15) NOT NULL,\n    USER_ID_ANTENNE INT NOT NULL REFERENCES ANTENNE(ANTENNE_ID),\n    USER_LAST_LOGIN BIGINT\n);\n"
    },
    "formatting": {
      "host_vars_one_per_line": true,
      "max_line_length": 72,
      "split_long_exec_sql": true
    },
    "indexes": [
      {
        "columns": [
          "USER_MAIL"
        ],
        "entity": "UTILISATEUR",
        "name": "UTILISATEUR_MAIL_UK"
      },
      {
        "columns": [
          "USER_ID_ANTENNE"
        ],
        "entity": "UTILISATEUR",
        "name": "UTILISATEUR_ANTENNE_IDX"
      },
      {
        "columns": [
          "ACTIVITE_IDANTENNE"
        ],
        "entity": "ACTIVITE",
        "name": "ACTIVITE_ANTENNE_IDX"
      },
      {
        "columns": [
          "ACTIVITE_ANIMATEUR"
        ],
        "entity": "ACTIVITE",
        "name": "ACTIVITE_ANIMATEUR_IDX"
      },
      {
        "columns": [
          "REPAS_ID_ACTIVITE"
        ],
        "entity": "REPAS",
        "name": "REPAS_ACTIVITE_IDX"
      },
      {
        "columns": [
          "HEBERGEMENT_ID_ACTIVITE"
        ],
        "entity": "HEBERGEMENT",
        "name": "HEBERGEMENT_ACTIVITE_IDX"
      },
      {
        "columns": [
          "PARTICIPATION_ID_USER"
        ],
        "entity": "PARTICIPATION",
        "name": "PARTICIPATION_USER_IDX"
      }
    ],
    "initial_data": {
      "ACTIVITE": [
        {
          "ACTIVITE_ANIMATEUR": 1001,
          "ACTIVITE_DISTANCE": 120,
          "ACTIVITE_EMPREINTETOTALE": 0.0,
          "ACTIVITE_HEBERGEMENT": 0,
          "ACTIVITE_ID": 2001,
          "ACTIVITE_IDANTENNE": 1,
          "ACTIVITE_LIEU": "PARIS",
          "ACTIVITE_MODETRANSPORT": 1,
          "ACTIVITE_NBPARTICIPANTS": 10,
          "ACTIVITE_NOM": "ATELIER MOBILITE",
          "ACTIVITE_REPASPREVU": 1,
          "ACTIVITE_TYPE": "TRANSPORT"
        },
        {
          "ACTIVITE_ANIMATEUR": 1002,
          "ACTIVITE_DISTANCE": 300,
          "ACTIVITE_EMPREINTETOTALE": 0.0,
          "ACTIVITE_HEBERGEMENT": 1,
          "ACTIVITE_ID": 2002,
          "ACTIVITE_IDANTENNE": 2,
          "ACTIVITE_LIEU": "LYON",
          "ACTIVITE_MODETRANSPORT": 2,
          "ACTIVITE_NBPARTICIPANTS": 5,
          "ACTIVITE_NOM": "SEMINAIRE CARBONE",
          "ACTIVITE_REPASPREVU": 1,
          "ACTIVITE_TYPE": "HEBERGEMENT"
        }
      ],
      "ANTENNE": [
        {
          "ANTENNE_ID": 1,
          "ANTENNE_NOM": "PARIS",
          "ANTENNE_REGION": "IDF"
        },
        {
          "ANTENNE_ID": 2,
          "ANTENNE_NOM": "LYON",
          "ANTENNE_REGION": "ARA"
        }
      ],
      "HEBERGEMENT": [
        {
          "HEBERGEMENT_ID": 4001,
          "HEBERGEMENT_ID_ACTIVITE": 2002,
          "HEBERGEMENT_NBNUIT": 2,
          "HEBERGEMENT_TYPE": 1
        }
      ],
      "PARTICIPATION": [
        {
          "PARTICIPATION_ID_ACTIVITE": 2001,
          "PARTICIPATION_ID_USER": 1001,
          "PARTICIPATION_MODE_TRANSPORT": 1
        },
        {
          "PARTICIPATION_ID_ACTIVITE": 2001,
          "PARTICIPATION_ID_USER": 1002,
          "PARTICIPATION_MODE_TRANSPORT": 2
        },
        {
          "PARTICIPATION_ID_ACTIVITE": 2002,
          "PARTICIPATION_ID_USER": 1002,
          "PARTICIPATION_MODE_TRANSPORT": 2
        }
      ],
      "REPAS": [
        {
          "REPAS_ID": 3001,
          "REPAS_ID_ACTIVITE": 2001,
          "REPAS_NBREPAS": 10,
          "REPAS_TYPE": 1
        },
        {
          "REPAS_ID": 3002,
          "REPAS_ID_ACTIVITE": 2002,
          "REPAS_NBREPAS": 5,
          "REPAS_TYPE": 2
        }
      ],
      "UTILISATEUR": [
        {
          "USER_ID": 1001,
          "USER_ID_ANTENNE": 1,
          "USER_LAST_LOGIN": 0,
          "USER_MAIL": "alice@carbontrack.fr",
          "USER_NOM": "ALICE MARTIN",
          "USER_PASS": "HASHEDPASS1",
          "USER_ROLE": "ADMIN"
        },
        {
          "USER_ID": 1002,
          "USER_ID_ANTENNE": 2,
          "USER_LAST_LOGIN": 0,
          "USER_MAIL": "bob@carbontrack.fr",
          "USER_NOM": "BOB DUPONT",
          "USER_PASS": "HASHEDPASS2",
          "USER_ROLE": "USER"
        }
      ]
    }
  },
  "sql_cible": "postgres",
  "technique": {
    "cursor_naming": {
      "pattern": "C_<ENTITY_UPPER3>"
    },
    "dal_call_pattern": {
      "description": "Programme DAL appele avec un code operation court (READ, SAVE, END).",
      "eof_param_name": "END-OF-FILE",
      "operation_param_name": "OPERATION",
      "operation_pic": "X(4)"
    },
    "eof_flag": {
      "false_value": "N",
      "initial_value": "N",
      "name": "END-OF-FILE",
      "pic": "X",
      "true_value": "Y"
    },
    "sqlca_required": true
  },
  "title": "APPLICATION-CARBONTRACK-BD-PART"
}