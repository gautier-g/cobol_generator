       IDENTIFICATION DIVISION.
       PROGRAM-ID. UTILISATEUR-DAL-DB.
       ENVIRONMENT DIVISION.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
OCESQL*    EXEC SQL INCLUDE SQLCA END-EXEC.
OCESQL     copy "sqlca.cbl".
       01  WS-CONNECTED-FLAG      PIC X.
       01  WS-CURSOR-OPEN-FLAG    PIC X.
       01  WS-USER-ID             PIC 9(9).
       01  WS-USER-NOM            PIC X(50).
       01  WS-USER-MAIL           PIC X(80).
       01  WS-USER-PASS           PIC X(256).
       01  WS-USER-ROLE           PIC X(15).
       01  WS-USER-ID-ANTENNE     PIC 9(9).
       01  WS-USER-LAST-LOGIN     PIC S9(11).
       01  WS-DB-NAME             PIC X(64).
       01  WS-DB-USER             PIC X(64).
       01  WS-DB-PASSWORD         PIC X(64).
OCESQL*
OCESQL 01  SQ0001.
OCESQL     02  FILLER PIC X(125) VALUE "SELECT USER_ID, USER_NOM, USER"
OCESQL  &  "_MAIL, USER_PASS, USER_ROLE, USER_ID_ANTENNE, USER_LAST_LO"
OCESQL  &  "GIN FROM UTILISATEUR ORDER BY USER_ID".
OCESQL     02  FILLER PIC X(1) VALUE X"00".
OCESQL*
OCESQL 01  SQ0002.
OCESQL     02  FILLER PIC X(062) VALUE "UPDATE UTILISATEUR SET USER_LA"
OCESQL  &  "ST_LOGIN = $1 WHERE USER_ID = $2".
OCESQL     02  FILLER PIC X(1) VALUE X"00".
OCESQL*
OCESQL 01  SQ0003.
OCESQL     02  FILLER PIC X(014) VALUE "DISCONNECT ALL".
OCESQL     02  FILLER PIC X(1) VALUE X"00".
OCESQL*
       LINKAGE SECTION.
       01  LK-OPERATION           PIC X(4).
       01  LK-END-OF-FILE         PIC X.
       01  LK-UTILISATEUR.
           05 LK-USER-ID           PIC 9(9).
           05 LK-USER-NOM          PIC X(50).
           05 LK-USER-MAIL         PIC X(80).
           05 LK-USER-PASS         PIC X(256).
           05 LK-USER-ROLE         PIC X(15).
           05 LK-USER-ID-ANTENNE   PIC 9(9).
           05 LK-USER-LAST-LOGIN   PIC S9(11).
       PROCEDURE DIVISION USING LK-OPERATION LK-END-OF-FILE 
       LK-UTILISATEUR.
       MAIN-ENTRY.
           EVALUATE LK-OPERATION
               WHEN 'READ'
                   PERFORM DAL-CONNECT
                   PERFORM DAL-READ
               WHEN 'SAVE'
                   PERFORM DAL-CONNECT
                   PERFORM DAL-SAVE
               WHEN 'END '
                   PERFORM DAL-END
               WHEN OTHER
                   DISPLAY 'ERREUR: Operation inconnue: ' LK-OPERATION
           END-EVALUATE
           GOBACK.
       
       DAL-CONNECT.
           IF WS-CONNECTED-FLAG = 'Y'
               CONTINUE
           ELSE
               PERFORM DAL-SET-ENV
OCESQL*        EXEC SQL
OCESQL*            CONNECT :WS-DB-USER IDENTIFIED BY :WS-DB-PASSWORD
OCESQL*            USING :WS-DB-NAME
OCESQL*        END-EXEC
OCESQL     CALL "OCESQLConnect" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE WS-DB-USER
OCESQL          BY VALUE 64
OCESQL          BY REFERENCE WS-DB-PASSWORD
OCESQL          BY VALUE 64
OCESQL          BY REFERENCE WS-DB-NAME
OCESQL          BY VALUE 64
OCESQL     END-CALL
               IF SQLCODE < 0
                   DISPLAY 'ERREUR CONNECT: SQLCODE=' SQLCODE
                   DISPLAY 'SQLSTATE=' SQLSTATE
                   DISPLAY 'SQLERRMC=' SQLERRMC
                   STOP RUN
               ELSE
                   MOVE 'Y' TO WS-CONNECTED-FLAG
                   DISPLAY 'Connexion DB reussie'
               END-IF
           END-IF.
       
       DAL-SET-ENV.
           MOVE SPACES TO WS-DB-NAME
           MOVE SPACES TO WS-DB-USER
           MOVE SPACES TO WS-DB-PASSWORD
           ACCEPT WS-DB-NAME FROM ENVIRONMENT 'PGDATABASE'
           ACCEPT WS-DB-USER FROM ENVIRONMENT 'PGUSER'
           ACCEPT WS-DB-PASSWORD FROM ENVIRONMENT 'PGPASSWORD'
           MOVE 'N' TO WS-CONNECTED-FLAG
           MOVE 'N' TO WS-CURSOR-OPEN-FLAG.
       
       DAL-READ.
           MOVE 'N' TO LK-END-OF-FILE
           IF WS-CURSOR-OPEN-FLAG NOT EQUAL 'Y'
OCESQL*        EXEC SQL
OCESQL*            DECLARE C_USER CURSOR FOR
OCESQL*            SELECT USER_ID, USER_NOM, USER_MAIL, USER_PASS, 
OCESQL*                   USER_ROLE,
OCESQL*                   USER_ID_ANTENNE, USER_LAST_LOGIN
OCESQL*            FROM UTILISATEUR
OCESQL*            ORDER BY USER_ID
OCESQL*        END-EXEC
OCESQL     CALL "OCESQLCursorDeclare" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "UTILISATEUR_DAL_DB_C_USER" & x"00"
OCESQL          BY REFERENCE SQ0001
OCESQL     END-CALL
OCESQL*        EXEC SQL OPEN C_USER END-EXEC
OCESQL     CALL "OCESQLCursorOpen" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "UTILISATEUR_DAL_DB_C_USER" & x"00"
OCESQL     END-CALL
               IF SQLCODE NOT EQUAL ZERO
                   DISPLAY 'ERREUR OPEN: SQLCODE=' SQLCODE
                   MOVE 'Y' TO LK-END-OF-FILE
                   GOBACK
               ELSE
                   MOVE 'Y' TO WS-CURSOR-OPEN-FLAG
                   DISPLAY 'Curseur C_USER ouvert'
               END-IF
           END-IF
           INITIALIZE LK-UTILISATEUR
OCESQL*    EXEC SQL
OCESQL*        FETCH C_USER INTO
OCESQL*            :WS-USER-ID,
OCESQL*            :WS-USER-NOM,
OCESQL*            :WS-USER-MAIL,
OCESQL*            :WS-USER-PASS,
OCESQL*            :WS-USER-ROLE,
OCESQL*            :WS-USER-ID-ANTENNE,
OCESQL*            :WS-USER-LAST-LOGIN
OCESQL*    END-EXEC
OCESQL     CALL "OCESQLStartSQL"
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 9
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-ID
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 50
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-NOM
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 80
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-MAIL
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 256
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-PASS
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 15
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-ROLE
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 9
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-ID-ANTENNE
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 3
OCESQL          BY VALUE 11
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-LAST-LOGIN
OCESQL     END-CALL
OCESQL     CALL "OCESQLCursorFetchOne" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "UTILISATEUR_DAL_DB_C_USER" & x"00"
OCESQL     END-CALL
OCESQL     CALL "OCESQLEndSQL"
OCESQL     END-CALL
           EVALUATE SQLCODE
               WHEN ZERO
                   MOVE WS-USER-ID TO LK-USER-ID OF LK-UTILISATEUR
                   MOVE WS-USER-NOM TO LK-USER-NOM OF LK-UTILISATEUR
                   MOVE WS-USER-MAIL TO LK-USER-MAIL OF LK-UTILISATEUR
                   MOVE WS-USER-PASS TO LK-USER-PASS OF LK-UTILISATEUR
                   MOVE WS-USER-ROLE TO LK-USER-ROLE OF LK-UTILISATEUR
                   MOVE WS-USER-ID-ANTENNE TO
                       LK-USER-ID-ANTENNE OF LK-UTILISATEUR
                   MOVE WS-USER-LAST-LOGIN TO
                       LK-USER-LAST-LOGIN OF LK-UTILISATEUR
               WHEN 100
                   MOVE 'Y' TO LK-END-OF-FILE
               WHEN OTHER
                   DISPLAY 'ERREUR FETCH: SQLCODE=' SQLCODE
                   MOVE 'Y' TO LK-END-OF-FILE
           END-EVALUATE.
       
       DAL-SAVE.
           MOVE LK-USER-ID OF LK-UTILISATEUR TO WS-USER-ID
           MOVE LK-USER-LAST-LOGIN OF LK-UTILISATEUR TO 
           WS-USER-LAST-LOGIN
OCESQL*    EXEC SQL
OCESQL*        UPDATE UTILISATEUR
OCESQL*        SET USER_LAST_LOGIN = :WS-USER-LAST-LOGIN
OCESQL*        WHERE USER_ID = :WS-USER-ID
OCESQL*    END-EXEC
OCESQL     CALL "OCESQLStartSQL"
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetSQLParams" USING
OCESQL          BY VALUE 3
OCESQL          BY VALUE 11
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-LAST-LOGIN
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetSQLParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 9
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-ID
OCESQL     END-CALL
OCESQL     CALL "OCESQLExecParams" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE SQ0002
OCESQL          BY VALUE 2
OCESQL     END-CALL
OCESQL     CALL "OCESQLEndSQL"
OCESQL     END-CALL
           IF SQLCODE NOT EQUAL ZERO
               DISPLAY 'ERREUR UPDATE: SQLCODE=' SQLCODE
OCESQL*        EXEC SQL ROLLBACK END-EXEC
OCESQL     CALL "OCESQLStartSQL"
OCESQL     END-CALL
OCESQL     CALL "OCESQLExec" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "ROLLBACK" & x"00"
OCESQL     END-CALL
OCESQL     CALL "OCESQLEndSQL"
OCESQL     END-CALL
           END-IF.
       
       DAL-END.
           IF WS-CURSOR-OPEN-FLAG EQUAL 'Y'
OCESQL*        EXEC SQL CLOSE C_USER END-EXEC
OCESQL     CALL "OCESQLCursorClose"  USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "UTILISATEUR_DAL_DB_C_USER" & x"00"
OCESQL     END-CALL
               IF SQLCODE NOT EQUAL ZERO
                   DISPLAY 'ERREUR CLOSE: SQLCODE=' SQLCODE
               END-IF
               MOVE 'N' TO WS-CURSOR-OPEN-FLAG
           END-IF
           IF WS-CONNECTED-FLAG EQUAL 'Y'
OCESQL*        EXEC SQL COMMIT END-EXEC
OCESQL     CALL "OCESQLStartSQL"
OCESQL     END-CALL
OCESQL     CALL "OCESQLExec" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "COMMIT" & x"00"
OCESQL     END-CALL
OCESQL     CALL "OCESQLEndSQL"
OCESQL     END-CALL
               IF SQLCODE NOT EQUAL ZERO
                   DISPLAY 'ERREUR COMMIT: SQLCODE=' SQLCODE
               END-IF
               DISPLAY 'Fermeture connexion'
OCESQL*        EXEC SQL DISCONNECT ALL END-EXEC
OCESQL     CALL "OCESQLDisconnect" USING
OCESQL          BY REFERENCE SQLCA
OCESQL     END-CALL
               IF SQLCODE NOT EQUAL ZERO
                   DISPLAY 'ERREUR DISCONNECT: SQLCODE=' SQLCODE
               END-IF
               MOVE 'N' TO WS-CONNECTED-FLAG
           END-IF
           GOBACK.