       IDENTIFICATION DIVISION.
       PROGRAM-ID. ACTIVITE-DAL-DB.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. GnuCOBOL.
       OBJECT-COMPUTER. GnuCOBOL.
       DATA DIVISION.
       WORKING-STORAGE SECTION.
OCESQL*    EXEC SQL INCLUDE SQLCA END-EXEC.
OCESQL     copy "sqlca.cbl".
       01  WS-CONNECTED-FLAG      PIC X.
       01  WS-CURSOR-OPEN-FLAG    PIC X.
       01  WS-ACTIVITE-ID         PIC 9(9).
       01  WS-ACTIVITE-NOM        PIC X(50).
       01  WS-ACTIVITE-TYPE       PIC X(20).
       01  WS-ACTIVITE-IDANTENNE  PIC 9(9).
       01  WS-ACTIVITE-ANIMATEUR  PIC 9(9).
       01  WS-ACTIVITE-NBPART     PIC 9(9).
       01  WS-ACTIVITE-TRANSPORT  PIC 9(2).
       01  WS-ACTIVITE-LIEU       PIC X(100).
       01  WS-ACTIVITE-DISTANCE   PIC 9(10).
       01  WS-ACTIVITE-HEBERG     PIC 9(1).
       01  WS-ACTIVITE-REPAS      PIC 9(1).
       01  WS-ACTIVITE-EMPREINTE  PIC S9(9)V9(4).
       01  WS-ANTENNE-NOM         PIC X(50).
       01  WS-ANTENNE-REGION      PIC X(50).
       01  WS-USER-NOM            PIC X(50).
       01  WS-USER-MAIL           PIC X(80).
       01  WS-DB-NAME             PIC X(64).
       01  WS-DB-USER             PIC X(64).
       01  WS-DB-PASSWORD         PIC X(64).
OCESQL*
OCESQL 01  SQ0001.
OCESQL     02  FILLER PIC X(256) VALUE "SELECT a.ACTIVITE_ID, a.ACTIVI"
OCESQL  &  "TE_NOM, a.ACTIVITE_TYPE, a.ACTIVITE_IDANTENNE, a.ACTIVITE_"
OCESQL  &  "ANIMATEUR, a.ACTIVITE_NBPARTICIPANTS, a.ACTIVITE_MODETRANS"
OCESQL  &  "PORT, a.ACTIVITE_LIEU, a.ACTIVITE_DISTANCE, a.ACTIVITE_HEB"
OCESQL  &  "ERGEMENT, a.ACTIVITE_REPASPREVU, a.ACTIVITE_EMPREINT".
OCESQL     02  FILLER PIC X(229) VALUE "ETOTALE, an.ANTENNE_NOM, an.AN"
OCESQL  &  "TENNE_REGION, u.USER_NOM, u.USER_MAIL FROM ACTIVITE a INNE"
OCESQL  &  "R JOIN ANTENNE an ON a.ACTIVITE_IDANTENNE = an.ANTENNE_ID "
OCESQL  &  "INNER JOIN UTILISATEUR u ON a.ACTIVITE_ANIMATEUR = u.USER_"
OCESQL  &  "ID ORDER BY a.ACTIVITE_ID".
OCESQL     02  FILLER PIC X(1) VALUE X"00".
OCESQL*
OCESQL 01  SQ0002.
OCESQL     02  FILLER PIC X(072) VALUE "UPDATE ACTIVITE SET ACTIVITE_E"
OCESQL  &  "MPREINTETOTALE = $1 WHERE ACTIVITE_ID = $2".
OCESQL     02  FILLER PIC X(1) VALUE X"00".
OCESQL*
OCESQL 01  SQ0003.
OCESQL     02  FILLER PIC X(014) VALUE "DISCONNECT ALL".
OCESQL     02  FILLER PIC X(1) VALUE X"00".
OCESQL*
       LINKAGE SECTION.
       01  LK-OPERATION           PIC X(4).
       01  LK-END-OF-FILE         PIC X.
       01  LK-ACTIVITE.
           05 LK-ACTIVITE-ID PIC 9(9).
           05 LK-ACTIVITE-NOM PIC X(50).
           05 LK-ACTIVITE-TYPE PIC X(20).
           05 LK-ACTIVITE-IDANTENNE PIC 9(9).
           05 LK-ACTIVITE-ANIMATEUR PIC 9(9).
           05 LK-ACTIVITE-NBPART PIC 9(9).
           05 LK-ACTIVITE-TRANSPORT PIC 9(2).
           05 LK-ACTIVITE-LIEU PIC X(100).
           05 LK-ACTIVITE-DISTANCE PIC 9(10).
           05 LK-ACTIVITE-HEBERG PIC 9(1).
           05 LK-ACTIVITE-REPAS PIC 9(1).
           05 LK-ACTIVITE-EMPREINTE PIC S9(9)V9(4).
           05 LK-ANTENNE-NOM PIC X(50).
           05 LK-ANTENNE-REGION PIC X(50).
           05 LK-USER-NOM PIC X(50).
           05 LK-USER-MAIL PIC X(80).
       PROCEDURE DIVISION USING LK-OPERATION LK-END-OF-FILE LK-ACTIVITE.
       MAIN-ENTRY.
           EVALUATE LK-OPERATION
               WHEN 'READ'
                   PERFORM DAL-CONNECT
                   PERFORM DAL-READ
               WHEN 'SAVE'
                   PERFORM DAL-CONNECT
                   PERFORM DAL-SAVE
               WHEN 'END '
                   PERFORM DAL-END
               WHEN OTHER
                   DISPLAY 'ERREUR: Operation inconnue: ' LK-OPERATION
           END-EVALUATE
           GOBACK.
       DAL-SET-ENV.
           MOVE 'N' TO WS-CONNECTED-FLAG
           MOVE 'N' TO WS-CURSOR-OPEN-FLAG
           ACCEPT WS-DB-USER FROM ENVIRONMENT 'PGUSER'
           ACCEPT WS-DB-PASSWORD FROM ENVIRONMENT 'PGPASSWORD'
           ACCEPT WS-DB-NAME FROM ENVIRONMENT 'PGDATABASE'.
       DAL-CONNECT.
           IF WS-CONNECTED-FLAG = 'Y'
               CONTINUE
           ELSE
               ACCEPT WS-DB-USER FROM ENVIRONMENT 'PGUSER'
               ACCEPT WS-DB-PASSWORD FROM ENVIRONMENT 'PGPASSWORD'
               ACCEPT WS-DB-NAME FROM ENVIRONMENT 'PGDATABASE'
OCESQL*        EXEC SQL
OCESQL*            CONNECT :WS-DB-USER IDENTIFIED BY :WS-DB-PASSWORD
OCESQL*                USING :WS-DB-NAME
OCESQL*        END-EXEC
OCESQL     CALL "OCESQLConnect" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE WS-DB-USER
OCESQL          BY VALUE 64
OCESQL          BY REFERENCE WS-DB-PASSWORD
OCESQL          BY VALUE 64
OCESQL          BY REFERENCE WS-DB-NAME
OCESQL          BY VALUE 64
OCESQL     END-CALL
               IF SQLCODE = ZERO
                   DISPLAY 'Connexion DB reussie'
                   MOVE 'Y' TO WS-CONNECTED-FLAG
               ELSE
                   DISPLAY 'ERREUR CONNECT: SQLCODE=' SQLCODE
                   DISPLAY 'SQLSTATE=' SQLSTATE
                   DISPLAY 'SQLERRMC=' SQLERRMC
                   GOBACK
               END-IF
           END-IF.
       DAL-READ.
           MOVE 'N' TO LK-END-OF-FILE
           IF WS-CURSOR-OPEN-FLAG NOT EQUAL 'Y'
OCESQL*        EXEC SQL
OCESQL*            DECLARE C_ACT CURSOR FOR
OCESQL*            SELECT a.ACTIVITE_ID, a.ACTIVITE_NOM, a.ACTIVITE_TYPE
OCESQL*                   ,
OCESQL*                   a.ACTIVITE_IDANTENNE, a.ACTIVITE_ANIMATEUR,
OCESQL*                   a.ACTIVITE_NBPARTICIPANTS,
OCESQL*                   a.ACTIVITE_MODETRANSPORT,
OCESQL*                   a.ACTIVITE_LIEU, a.ACTIVITE_DISTANCE,
OCESQL*                   a.ACTIVITE_HEBERGEMENT,
OCESQL*                   a.ACTIVITE_REPASPREVU,
OCESQL*                   a.ACTIVITE_EMPREINTETOTALE,
OCESQL*                   an.ANTENNE_NOM, an.ANTENNE_REGION,
OCESQL*                   u.USER_NOM, u.USER_MAIL
OCESQL*            FROM ACTIVITE a
OCESQL*            INNER JOIN ANTENNE an
OCESQL*                ON a.ACTIVITE_IDANTENNE = an.ANTENNE_ID
OCESQL*            INNER JOIN UTILISATEUR u
OCESQL*                ON a.ACTIVITE_ANIMATEUR = u.USER_ID
OCESQL*            ORDER BY a.ACTIVITE_ID
OCESQL*        END-EXEC
OCESQL     CALL "OCESQLCursorDeclare" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "ACTIVITE_DAL_DB_C_ACT" & x"00"
OCESQL          BY REFERENCE SQ0001
OCESQL     END-CALL
OCESQL*        EXEC SQL OPEN C_ACT END-EXEC
OCESQL     CALL "OCESQLCursorOpen" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "ACTIVITE_DAL_DB_C_ACT" & x"00"
OCESQL     END-CALL
               IF SQLCODE NOT EQUAL ZERO
                   DISPLAY 'ERREUR OPEN: SQLCODE=' SQLCODE
                   MOVE 'Y' TO LK-END-OF-FILE
                   GOBACK
               END-IF
               MOVE 'Y' TO WS-CURSOR-OPEN-FLAG
               DISPLAY 'Curseur C_ACT ouvert'
           END-IF
OCESQL*    EXEC SQL
OCESQL*        FETCH C_ACT INTO
OCESQL*            :WS-ACTIVITE-ID,
OCESQL*            :WS-ACTIVITE-NOM,
OCESQL*            :WS-ACTIVITE-TYPE,
OCESQL*            :WS-ACTIVITE-IDANTENNE,
OCESQL*            :WS-ACTIVITE-ANIMATEUR,
OCESQL*            :WS-ACTIVITE-NBPART,
OCESQL*            :WS-ACTIVITE-TRANSPORT,
OCESQL*            :WS-ACTIVITE-LIEU,
OCESQL*            :WS-ACTIVITE-DISTANCE,
OCESQL*            :WS-ACTIVITE-HEBERG,
OCESQL*            :WS-ACTIVITE-REPAS,
OCESQL*            :WS-ACTIVITE-EMPREINTE,
OCESQL*            :WS-ANTENNE-NOM,
OCESQL*            :WS-ANTENNE-REGION,
OCESQL*            :WS-USER-NOM,
OCESQL*            :WS-USER-MAIL
OCESQL*    END-EXEC
OCESQL     CALL "OCESQLStartSQL"
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 9
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-ID
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 50
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-NOM
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 20
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-TYPE
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 9
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-IDANTENNE
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 9
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-ANIMATEUR
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 9
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-NBPART
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 2
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-TRANSPORT
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 100
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-LIEU
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 10
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-DISTANCE
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 1
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-HEBERG
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 1
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-REPAS
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 3
OCESQL          BY VALUE 13
OCESQL          BY VALUE -4
OCESQL          BY REFERENCE WS-ACTIVITE-EMPREINTE
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 50
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ANTENNE-NOM
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 50
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ANTENNE-REGION
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 50
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-NOM
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetResultParams" USING
OCESQL          BY VALUE 16
OCESQL          BY VALUE 80
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-USER-MAIL
OCESQL     END-CALL
OCESQL     CALL "OCESQLCursorFetchOne" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "ACTIVITE_DAL_DB_C_ACT" & x"00"
OCESQL     END-CALL
OCESQL     CALL "OCESQLEndSQL"
OCESQL     END-CALL
           EVALUATE TRUE
               WHEN SQLCODE EQUAL ZERO
                   CONTINUE
               WHEN SQLCODE EQUAL 100
                   MOVE 'Y' TO LK-END-OF-FILE
               WHEN OTHER
                   DISPLAY 'ERREUR FETCH: SQLCODE=' SQLCODE
                   MOVE 'Y' TO LK-END-OF-FILE
           END-EVALUATE
           IF SQLCODE EQUAL ZERO
               MOVE WS-ACTIVITE-ID TO LK-ACTIVITE-ID OF LK-ACTIVITE
               MOVE WS-ACTIVITE-NOM TO LK-ACTIVITE-NOM OF LK-ACTIVITE
               MOVE WS-ACTIVITE-TYPE TO LK-ACTIVITE-TYPE OF LK-ACTIVITE
               MOVE WS-ACTIVITE-IDANTENNE TO LK-ACTIVITE-IDANTENNE OF
               LK-ACTIVITE
               MOVE WS-ACTIVITE-ANIMATEUR TO LK-ACTIVITE-ANIMATEUR OF
               LK-ACTIVITE
               MOVE WS-ACTIVITE-NBPART TO LK-ACTIVITE-NBPART OF 
               LK-ACTIVITE
               MOVE WS-ACTIVITE-TRANSPORT TO LK-ACTIVITE-TRANSPORT OF
               LK-ACTIVITE
               MOVE WS-ACTIVITE-LIEU TO LK-ACTIVITE-LIEU OF LK-ACTIVITE
               MOVE WS-ACTIVITE-DISTANCE TO LK-ACTIVITE-DISTANCE OF 
               LK-ACTIVITE
               MOVE WS-ACTIVITE-HEBERG TO LK-ACTIVITE-HEBERG OF 
               LK-ACTIVITE
               MOVE WS-ACTIVITE-REPAS TO LK-ACTIVITE-REPAS OF 
               LK-ACTIVITE
               MOVE WS-ACTIVITE-EMPREINTE TO LK-ACTIVITE-EMPREINTE OF
               LK-ACTIVITE
               MOVE WS-ANTENNE-NOM TO LK-ANTENNE-NOM OF LK-ACTIVITE
               MOVE WS-ANTENNE-REGION TO LK-ANTENNE-REGION OF 
               LK-ACTIVITE
               MOVE WS-USER-NOM TO LK-USER-NOM OF LK-ACTIVITE
               MOVE WS-USER-MAIL TO LK-USER-MAIL OF LK-ACTIVITE
           END-IF.
       DAL-SAVE.
           MOVE LK-ACTIVITE-ID OF LK-ACTIVITE TO WS-ACTIVITE-ID
           MOVE LK-ACTIVITE-EMPREINTE OF LK-ACTIVITE TO 
           WS-ACTIVITE-EMPREINTE
OCESQL*    EXEC SQL
OCESQL*        UPDATE ACTIVITE
OCESQL*        SET ACTIVITE_EMPREINTETOTALE = :WS-ACTIVITE-EMPREINTE
OCESQL*        WHERE ACTIVITE_ID = :WS-ACTIVITE-ID
OCESQL*    END-EXEC
OCESQL     CALL "OCESQLStartSQL"
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetSQLParams" USING
OCESQL          BY VALUE 3
OCESQL          BY VALUE 13
OCESQL          BY VALUE -4
OCESQL          BY REFERENCE WS-ACTIVITE-EMPREINTE
OCESQL     END-CALL
OCESQL     CALL "OCESQLSetSQLParams" USING
OCESQL          BY VALUE 1
OCESQL          BY VALUE 9
OCESQL          BY VALUE 0
OCESQL          BY REFERENCE WS-ACTIVITE-ID
OCESQL     END-CALL
OCESQL     CALL "OCESQLExecParams" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE SQ0002
OCESQL          BY VALUE 2
OCESQL     END-CALL
OCESQL     CALL "OCESQLEndSQL"
OCESQL     END-CALL
           IF SQLCODE NOT EQUAL ZERO
               DISPLAY 'ERREUR UPDATE: SQLCODE=' SQLCODE
OCESQL*        EXEC SQL ROLLBACK END-EXEC
OCESQL     CALL "OCESQLStartSQL"
OCESQL     END-CALL
OCESQL     CALL "OCESQLExec" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "ROLLBACK" & x"00"
OCESQL     END-CALL
OCESQL     CALL "OCESQLEndSQL"
OCESQL     END-CALL
               GOBACK
           END-IF.
       DAL-END.
           IF WS-CURSOR-OPEN-FLAG = 'Y'
OCESQL*        EXEC SQL CLOSE C_ACT END-EXEC
OCESQL     CALL "OCESQLCursorClose"  USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "ACTIVITE_DAL_DB_C_ACT" & x"00"
OCESQL     END-CALL
               IF SQLCODE NOT EQUAL ZERO
                   DISPLAY 'ERREUR CLOSE: SQLCODE=' SQLCODE
               END-IF
               MOVE 'N' TO WS-CURSOR-OPEN-FLAG
           END-IF
           IF WS-CONNECTED-FLAG = 'Y'
OCESQL*        EXEC SQL COMMIT END-EXEC
OCESQL     CALL "OCESQLStartSQL"
OCESQL     END-CALL
OCESQL     CALL "OCESQLExec" USING
OCESQL          BY REFERENCE SQLCA
OCESQL          BY REFERENCE "COMMIT" & x"00"
OCESQL     END-CALL
OCESQL     CALL "OCESQLEndSQL"
OCESQL     END-CALL
               IF SQLCODE NOT EQUAL ZERO
                   DISPLAY 'ERREUR COMMIT: SQLCODE=' SQLCODE
               END-IF
               DISPLAY 'Fermeture connexion'
OCESQL*        EXEC SQL DISCONNECT ALL END-EXEC
OCESQL     CALL "OCESQLDisconnect" USING
OCESQL          BY REFERENCE SQLCA
OCESQL     END-CALL
               IF SQLCODE NOT EQUAL ZERO
                   DISPLAY 'ERREUR DISCONNECT: SQLCODE=' SQLCODE
               END-IF
               MOVE 'N' TO WS-CONNECTED-FLAG
           END-IF
           GOBACK.