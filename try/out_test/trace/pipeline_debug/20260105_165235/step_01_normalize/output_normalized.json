{
  "diagramme": {
    "parsed": true,
    "source": "erDiagram\n  EMPLOYEE {\n    INT EMP_ID PK\n    VARCHAR EMP_NAME\n    DECIMAL SALARY_BRUT\n    DECIMAL SALARY_NET\n  }\n",
    "type": "mermaid"
  },
  "dialecte_cobol": "gnucobol",
  "exigences": [
    {
      "id": "R1",
      "normalized": {
        "affects_entities": [
          "ROUND",
          "SALARY_BRUT",
          "SALARY_NET"
        ],
        "layer": "logic",
        "priority": 5
      },
      "notes": "Salaire net = salaire brut − cotisations sociales (20%) − impôt (10%). Arrondi bancaire à 2 décimales. SALARY_NET ne doit pas être négatif.",
      "regle": "SALARY_NET = ROUND(SALARY_BRUT * 0.7, 2)",
      "type": "regle_metier"
    },
    {
      "id": "R2",
      "normalized": {
        "affects_entities": [],
        "layer": "logic",
        "priority": 5
      },
      "regle": "Traitement batch quotidien; journalisation des exécutions (messages simples sur la console).",
      "type": "technique"
    },
    {
      "id": "R3",
      "normalized": {
        "affects_entities": [
          "NULL",
          "SALARY_BRUT"
        ],
        "layer": "logic",
        "priority": 5
      },
      "regle": "Si SALARY_BRUT est NULL ou invalide, ignorer la ligne ou la signaler en anomalie.",
      "type": "validation"
    }
  ],
  "fonctionnalites": [
    {
      "id": "F1",
      "normalized": {
        "components": [],
        "scope": "module"
      },
      "resume": "Calculer le salaire net à partir du salaire brut pour chaque employé."
    }
  ],
  "fonctions": [
    {
      "cobol_location": {
        "division": "PROCEDURE DIVISION",
        "fichier": "employee_dal_db.cob",
        "paragraph": "DAL-READ",
        "programme": "EMPLOYEE-DAL-DB",
        "section": "couche_dal"
      },
      "description": "Connecte à la base si nécessaire, ouvre le curseur C_EMP si nécessaire, fait un FETCH et remplit la structure EMPLOYEE. Met END-OF-FILE à 'Y' en cas de fin de données ou d'erreur.\n",
      "entity": "EMPLOYEE",
      "eof_logic": {
        "eof_false_value": "N",
        "eof_flag_name": "LK-END-OF-FILE",
        "eof_true_value": "Y",
        "on_sqlcode_100_set_eof": true
      },
      "errors_flags": [
        "SQLCODE = 0 : succès, une ligne lue.",
        "SQLCODE = 100 : fin de curseur.",
        "SQLCODE != 0 et != 100 : erreur SQL, le batch s'arrête logiquement."
      ],
      "id": "FN-DAL-READ",
      "inputs": [
        "OPERATION = 'READ'",
        "Connexion non garantie à l'avance (connexion paresseuse).",
        "Curseur non garanti ouvert (ouverture paresseuse)."
      ],
      "layer": "dal",
      "modifies": [
        "EMPLOYEE.*",
        "END-OF-FILE",
        "WS-CONNECTED",
        "WS-CURSOR-OPEN",
        "SQLCODE"
      ],
      "name": "DAL-READ",
      "operation_code": "READ",
      "outputs": [
        "EMPLOYEE.EMP_ID",
        "EMPLOYEE.EMP_NAME",
        "EMPLOYEE.SALARY_BRUT",
        "EMPLOYEE.SALARY_NET",
        "END-OF-FILE",
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : EMPLOYEE contient un enregistrement valide et END-OF-FILE = 'N'.",
        "Si SQLCODE = 100 : fin de données, END-OF-FILE = 'Y'.",
        "Si SQLCODE != 0 et != 100 : message d'erreur affiché et END-OF-FILE = 'Y'."
      ],
      "preconditions": [],
      "programme": "EMPLOYEE-DAL-DB",
      "related_exigences": [
        "R2",
        "R3"
      ],
      "sql": {
        "connect_statement": "CONNECT TO 'dbname=EMPDB user=EMPUSER password=SECRETPWD'",
        "declare_cursor": "DECLARE C_EMP CURSOR FOR\nSELECT EMP_ID, EMP_NAME, SALARY_BRUT, SALARY_NET\nFROM EMPLOYEE\n",
        "fetch_into": "FETCH C_EMP INTO :LK-EMP-ID, :LK-EMP-NAME, :LK-SALARY-BRUT, :LK-SALARY-NET",
        "open_cursor": "OPEN C_EMP"
      }
    },
    {
      "cobol_location": {
        "division": "PROCEDURE DIVISION",
        "fichier": "employee_dal_db.cob",
        "paragraph": "DAL-SAVE",
        "programme": "EMPLOYEE-DAL-DB",
        "section": "couche_dal"
      },
      "description": "Met à jour en base la colonne SALARY_NET pour l'employé courant (EMP_ID) à partir de la valeur SALARY_NET de la structure EMPLOYEE.\n",
      "entity": "EMPLOYEE",
      "errors_flags": [
        "SQLCODE = 0 : succès.",
        "SQLCODE != 0 : erreur SQL, message affiché."
      ],
      "id": "FN-DAL-SAVE",
      "inputs": [
        "EMPLOYEE.EMP_ID",
        "EMPLOYEE.SALARY_NET"
      ],
      "layer": "dal",
      "modifies": [
        "SQLCODE"
      ],
      "name": "DAL-SAVE",
      "operation_code": "SAVE",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Si SQLCODE = 0 : la ligne EMPLOYEE correspondante en base a été mise à jour."
      ],
      "preconditions": [
        "EMPLOYEE.EMP_ID contient un identifiant existant en base."
      ],
      "programme": "EMPLOYEE-DAL-DB",
      "related_exigences": [
        "R1",
        "R2"
      ],
      "sql": {
        "update_statement": "UPDATE EMPLOYEE\nSET SALARY_NET = :LK-SALARY-NET\nWHERE EMP_ID = :LK-EMP-ID\n"
      }
    },
    {
      "cobol_location": {
        "division": "PROCEDURE DIVISION",
        "fichier": "employee_dal_db.cob",
        "paragraph": "DAL-END",
        "programme": "EMPLOYEE-DAL-DB",
        "section": "couche_dal"
      },
      "description": "Ferme le curseur s'il est ouvert, commit la transaction et ferme la connexion à la base. Appelée une fois en fin de traitement.\n",
      "entity": "EMPLOYEE",
      "errors_flags": [
        "Les erreurs de CLOSE/COMMIT/DISCONNECT sont simplement affichées."
      ],
      "id": "FN-DAL-END",
      "inputs": [],
      "layer": "dal",
      "modifies": [
        "WS-CURSOR-OPEN",
        "WS-CONNECTED",
        "SQLCODE"
      ],
      "name": "DAL-END",
      "operation_code": "END ",
      "outputs": [
        "SQLCODE"
      ],
      "postconditions": [
        "Curseur fermé si besoin.",
        "COMMIT effectué.",
        "Connexion base fermée."
      ],
      "preconditions": [],
      "programme": "EMPLOYEE-DAL-DB",
      "related_exigences": [
        "R2"
      ],
      "sql": {
        "close_cursor": "CLOSE C_EMP",
        "commit": "COMMIT",
        "disconnect": "DISCONNECT ALL"
      }
    },
    {
      "calls": [
        "EMPLOYEE-DAL-DB avec OPERATION='READ'",
        "CALCULATE-NET",
        "EMPLOYEE-DAL-DB avec OPERATION='SAVE'",
        "EMPLOYEE-BUSINESS.DISPLAY-EMPLOYEE",
        "EMPLOYEE-DAL-DB avec OPERATION='END '"
      ],
      "cobol_location": {
        "division": "PROCEDURE DIVISION",
        "fichier": "employee_logic.cob",
        "paragraph": "MAIN-PROCESS",
        "programme": "EMPLOYEE-LOGIC",
        "section": "couche_logique"
      },
      "description": "Boucle principale du batch: lit les employés via la DAL, calcule le salaire net, sauvegarde le résultat en base et affiche chaque employé.\n",
      "entity": "EMPLOYEE",
      "id": "FN-LOGIC-MAIN",
      "inputs": [],
      "layer": "logic",
      "loop_control": {
        "eof_false_value": "N",
        "eof_flag_name": "END-OF-FILE",
        "eof_true_value": "Y"
      },
      "modifies": [
        "EMPLOYEE.*",
        "END-OF-FILE"
      ],
      "name": "MAIN-PROCESS",
      "outputs": [],
      "postconditions": [
        "Tous les employés de la table EMPLOYEE ont un SALARY_NET calculé selon R1."
      ],
      "preconditions": [],
      "programme": "EMPLOYEE-LOGIC",
      "related_exigences": [
        "F1",
        "R1",
        "R2",
        "R3"
      ]
    },
    {
      "cobol_location": {
        "division": "PROCEDURE DIVISION",
        "fichier": "employee_logic.cob",
        "paragraph": "CALCULATE-NET",
        "programme": "EMPLOYEE-LOGIC",
        "section": "couche_logique"
      },
      "description": "Applique la règle métier SALARY_NET = ROUND(SALARY_BRUT * 0.7, 2) à l'employé courant. Aucun accès base, uniquement traitement en mémoire.\n",
      "entity": "EMPLOYEE",
      "errors_flags": [
        "Si SALARY_BRUT invalide, la logique appelante peut ignorer la ligne ou la journaliser (R3)."
      ],
      "expression": {
        "cobol_hint": "COMPUTE SALARY-NET ROUNDED = SALARY-BRUT * 0.7",
        "formula": "ROUND(EMPLOYEE.SALARY_BRUT * 0.7, 2)",
        "target": "EMPLOYEE.SALARY_NET"
      },
      "id": "FN-LOGIC-CALC",
      "inputs": [
        "EMPLOYEE.SALARY_BRUT"
      ],
      "layer": "logic",
      "modifies": [
        "EMPLOYEE.SALARY_NET"
      ],
      "name": "CALCULATE-NET",
      "outputs": [
        "EMPLOYEE.SALARY_NET"
      ],
      "postconditions": [
        "EMPLOYEE.SALARY_NET >= 0.",
        "EMPLOYEE.SALARY_NET correspond à SALARY_BRUT * 0.7 arrondi à 2 décimales."
      ],
      "preconditions": [
        "EMPLOYEE.SALARY_BRUT contient une valeur numérique valide."
      ],
      "programme": "EMPLOYEE-LOGIC",
      "related_exigences": [
        "R1",
        "R3"
      ]
    },
    {
      "cobol_location": {
        "division": "PROCEDURE DIVISION",
        "fichier": "employee_business.cob",
        "paragraph": "DISPLAY-EMPLOYEE",
        "programme": "EMPLOYEE-BUSINESS",
        "section": "couche_metier"
      },
      "description": "Affiche les informations principales de l'employé courant sur la console: nom, identifiant, salaire brut, salaire net.\n",
      "display_lines": [
        "DISPLAY \"EMPLOYE : \" EMP-NAME",
        "DISPLAY \"ID      : \" EMP-ID",
        "DISPLAY \"BRUT    : \" SALARY-BRUT",
        "DISPLAY \"NET     : \" SALARY-NET"
      ],
      "entity": "EMPLOYEE",
      "errors_flags": [],
      "id": "FN-BIZ-DISPLAY",
      "inputs": [
        "EMPLOYEE.EMP_NAME",
        "EMPLOYEE.EMP_ID",
        "EMPLOYEE.SALARY_BRUT",
        "EMPLOYEE.SALARY_NET"
      ],
      "layer": "business",
      "modifies": [],
      "name": "DISPLAY-EMPLOYEE",
      "outputs": [],
      "postconditions": [],
      "preconditions": [
        "EMPLOYEE contient des valeurs lues/calculées cohérentes."
      ],
      "programme": "EMPLOYEE-BUSINESS",
      "related_exigences": [
        "F1"
      ]
    }
  ],
  "mapping_types": [
    {
      "cobol_pic_default": "9(4)",
      "sql": "INT"
    },
    {
      "cobol_pic_default": "A(30)",
      "sql": "VARCHAR(30)"
    },
    {
      "cobol_pic_default": "9(6)V99",
      "sql": "DECIMAL(8,2)"
    }
  ],
  "mcd": {
    "entites": [
      {
        "attrs": [
          {
            "auto_generated": false,
            "cobol_pic": "9(4)",
            "default": null,
            "name": "EMP_ID",
            "normalized_name": "EMP_ID",
            "normalized_type": {
              "base": "INT"
            },
            "nullable": false,
            "pk": true,
            "sql_type": "INT",
            "type": "INT"
          },
          {
            "auto_generated": false,
            "cobol_pic": "A(30)",
            "default": null,
            "name": "EMP_NAME",
            "normalized_name": "EMP_NAME",
            "normalized_type": {
              "base": "VARCHAR",
              "length": 30
            },
            "nullable": false,
            "sql_type": "VARCHAR(30)",
            "type": "VARCHAR(30)"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(6)V99",
            "default": null,
            "name": "SALARY_BRUT",
            "normalized_name": "SALARY_BRUT",
            "normalized_type": {
              "base": "DECIMAL",
              "precision": 8,
              "scale": 2
            },
            "nullable": false,
            "sql_type": "DECIMAL(8,2)",
            "type": "DECIMAL(8,2)"
          },
          {
            "auto_generated": false,
            "cobol_pic": "9(6)V99",
            "default": null,
            "name": "SALARY_NET",
            "normalized_name": "SALARY_NET",
            "normalized_type": {
              "base": "DECIMAL",
              "precision": 8,
              "scale": 2
            },
            "nullable": true,
            "sql_type": "DECIMAL(8,2)",
            "type": "DECIMAL(8,2)"
          }
        ],
        "name": "EMPLOYEE",
        "normalized_name": "EMPLOYEE"
      }
    ],
    "relations": []
  },
  "metadata": {
    "hash": "73b34f26e7a82aed24926c85d2b352a586881fa44f2cd96ebca4704639d533c9",
    "normalized_at": "2026-01-05T15:52:35.088993Z",
    "source_file": "/home/mfabre/pi/cobol_generator/try/salaire_net.yaml",
    "version": "1.0.0"
  },
  "nommage": {
    "copybooks_case": "UPPER_SNAKE",
    "programmes_case": "UPPER-KEBAB",
    "tables_case": "UPPER_SNAKE",
    "variables_case": "UPPER_SNAKE"
  },
  "programmes": [
    {
      "allowed_business_logic": false,
      "allowed_sql": true,
      "call_interface": {
        "description": "CALL 'EMPLOYEE-DAL-DB' USING OPERATION, END-OF-FILE, EMPLOYEE.",
        "linkage_parameters": [
          {
            "direction": "in",
            "name": "LK-OPERATION",
            "pic": "X(4)"
          },
          {
            "direction": "inout",
            "name": "LK-END-OF-FILE",
            "pic": "X"
          },
          {
            "direction": "inout",
            "name": "LK-EMPLOYEE",
            "pic": "groupe EMPLOYEE"
          }
        ],
        "operations": {
          "end": "END ",
          "read": "READ",
          "save": "SAVE"
        },
        "type": "CALL USING"
      },
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "required"
        },
        "environment_division": "optional",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-ENTRY",
          "using_clause": [
            "LK-OPERATION",
            "LK-END-OF-FILE",
            "LK-EMPLOYEE"
          ]
        }
      },
      "entities": [
        "EMPLOYEE"
      ],
      "layer": "dal",
      "main_cursor": "C_EMP",
      "name": "EMPLOYEE-DAL-DB",
      "role": "Couche d'accès à la base pour EMPLOYEE (lecture via curseur et mise à jour de SALARY_NET)."
    },
    {
      "allowed_business_logic": true,
      "allowed_sql": false,
      "cobol_sections": {
        "data_division": {
          "linkage": "none",
          "working_storage": "required"
        },
        "environment_division": "optional",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "MAIN-PROCESS"
        }
      },
      "entities": [
        "EMPLOYEE"
      ],
      "layer": "logic",
      "name": "EMPLOYEE-LOGIC",
      "role": "Traitement batch principal : boucle sur les employés, calcul du net, sauvegarde, affichage."
    },
    {
      "allowed_business_logic": "lecture_seule",
      "allowed_sql": false,
      "cobol_sections": {
        "data_division": {
          "linkage": "required",
          "working_storage": "none"
        },
        "environment_division": "optional",
        "identification_division": "required",
        "procedure_division": {
          "entry_paragraph": "DISPLAY-EMPLOYEE",
          "using_clause": [
            "EMPLOYEE"
          ]
        }
      },
      "entities": [
        "EMPLOYEE"
      ],
      "layer": "business",
      "name": "EMPLOYEE-BUSINESS",
      "role": "Affichage simple des informations d'un employé (nom, ID, salaire brut/net)."
    }
  ],
  "sources": {
    "cobol": [
      {
        "fichier": "employee_dal_db.cob",
        "programme": "EMPLOYEE-DAL-DB"
      },
      {
        "fichier": "employee_logic.cob",
        "programme": "EMPLOYEE-LOGIC"
      },
      {
        "fichier": "employee_business.cob",
        "programme": "EMPLOYEE-BUSINESS"
      }
    ],
    "sql": [
      {
        "entity": "EMPLOYEE",
        "fichier": "employee_init.sql",
        "logical_name": "EMPLOYEE-INIT"
      }
    ]
  },
  "sql": {
    "ddl": {
      "EMPLOYEE": "CREATE TABLE EMPLOYEE (\n    EMP_ID INT PRIMARY KEY,\n    EMP_NAME VARCHAR(30),\n    SALARY_BRUT DECIMAL(8,2),\n    SALARY_NET DECIMAL(8,2)\n);\n"
    },
    "indexes": [
      {
        "columns": [
          "EMP_NAME"
        ],
        "entity": "EMPLOYEE",
        "name": "EMPLOYEE_EMP_NAME_IDX"
      }
    ],
    "initial_data": {
      "EMPLOYEE": [
        {
          "EMP_ID": 1,
          "EMP_NAME": "Dupont",
          "SALARY_BRUT": 3000.0,
          "SALARY_NET": 0.0
        },
        {
          "EMP_ID": 2,
          "EMP_NAME": "Durand",
          "SALARY_BRUT": 1500.0,
          "SALARY_NET": 0.0
        }
      ]
    }
  },
  "sql_cible": "postgres",
  "technique": {
    "cursor_naming": {
      "example": {
        "EMPLOYEE": "C_EMP"
      },
      "pattern": "C_<ENTITY_UPPER3>"
    },
    "dal_call_pattern": {
      "description": "Programme DAL appelé avec un code opération court (READ, SAVE, END).",
      "employee_param_name": "EMPLOYEE",
      "eof_param_name": "END-OF-FILE",
      "operation_param_name": "OPERATION",
      "operation_pic": "X(4)"
    },
    "eof_flag": {
      "false_value": "N",
      "initial_value": "N",
      "name": "END-OF-FILE",
      "pic": "X",
      "true_value": "Y"
    },
    "sqlca_required": true
  },
  "title": "CALCUL-SALAIRE"
}