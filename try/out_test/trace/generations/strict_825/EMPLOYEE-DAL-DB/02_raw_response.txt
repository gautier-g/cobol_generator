IDENTIFICATION DIVISION.
       PROGRAM-ID. EMPLOYEE-DAL-DB.
      *****************************************************************
      * Programme: EMPLOYEE-DAL-DB                                     *
      * Couche: DAL (Data Access Layer)                                *
      * Role: Acces a la base PostgreSQL pour EMPLOYEE                 *
      *       Operations: READ, SAVE, END                              *
      *****************************************************************
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       REPOSITORY.
           FUNCTION ALL INTRINSIC.

       DATA DIVISION.
       WORKING-STORAGE SECTION.
       EXEC SQL INCLUDE SQLCA END-EXEC.
       01  WS-CONNECTED-FLAG      PIC X VALUE 'N'.
           88  WS-CONNECTED           VALUE 'Y'.
       01  WS-CURSOR-OPEN-FLAG    PIC X VALUE 'N'.
           88  WS-CURSOR-OPEN         VALUE 'Y'.
       01  WS-EMP-ID              PIC 9(4).
       01  WS-EMP-NAME            PIC A(30).
       01  WS-SALARY-BRUT         PIC S9(6)V99.
       01  WS-SALARY-NET          PIC S9(6)V99.
       01  WS-DB-NAME.
           05  WS-DB-NAME-TEXT     PIC X(5) VALUE 'empdb'.
           05  WS-DB-NAME-TERM     PIC X VALUE X'00'.
       01  WS-DB-USER.
           05  WS-DB-USER-TEXT     PIC X(7) VALUE 'empuser'.
           05  WS-DB-USER-TERM     PIC X VALUE X'00'.
       01  WS-DB-PASSWORD.
           05  WS-DB-PASSWORD-TEXT PIC X(9) VALUE 'SECRETPWD'.
           05  WS-DB-PASSWORD-TERM PIC X VALUE X'00'.
       01  WS-DB-NAME-LEN         PIC S9(4) COMP-5 VALUE 5.
       01  WS-DB-USER-LEN         PIC S9(4) COMP-5 VALUE 7.
       01  WS-DB-PASSWORD-LEN     PIC S9(4) COMP-5 VALUE 9.
       01  WS-PGHOST-NAME         PIC X(6) VALUE 'PGHOST'.
       01  WS-PGHOST-VALUE        PIC X(64) VALUE 'localhost'.
       01  WS-PGPORT-NAME         PIC X(6) VALUE 'PGPORT'.
       01  WS-PGPORT-VALUE        PIC X(5) VALUE '5432'.
       01  WS-PGUSER-NAME         PIC X(6) VALUE 'PGUSER'.
       01  WS-PGUSER-VALUE        PIC X(64) VALUE 'empuser'.
       01  WS-PGPASSWORD-NAME     PIC X(10) VALUE 'PGPASSWORD'.
       01  WS-PGPASSWORD-VALUE    PIC X(64) VALUE 'SECRETPWD'.
       01  WS-PGDATABASE-NAME     PIC X(10) VALUE 'PGDATABASE'.
       01  WS-PGDATABASE-VALUE    PIC X(64) VALUE 'empdb'.

       LINKAGE SECTION.
       01 LK-OPERATION PIC X(4).
       01 LK-END-OF-FILE PIC X.
       01 LK-EMPLOYEE.
           05 LK-EMP-ID PIC 9(4).
           05 LK-EMP-NAME PIC A(30).
           05 LK-SALARY-BRUT PIC S9(6)V99.
           05 LK-SALARY-NET PIC S9(6)V99.

       PROCEDURE DIVISION USING LK-OPERATION LK-END-OF-FILE LK-EMPLOYEE.
       MAIN-ENTRY.
           IF LK-OPERATION NOT = 'END '
               PERFORM DAL-CONNECT
               IF NOT WS-CONNECTED
                   MOVE 'Y' TO LK-END-OF-FILE
                   GOBACK
               END-IF
           END-IF

           EVALUATE LK-OPERATION
               WHEN 'READ'
                   PERFORM DAL-READ
               WHEN 'SAVE'
                   PERFORM DAL-SAVE
               WHEN 'END '
                   PERFORM DAL-END
               WHEN OTHER
                   DISPLAY 'ERREUR: Operation inconnue: ' LK-OPERATION
           END-EVALUATE
           GOBACK
           .

       DAL-SET-ENV.
           DISPLAY WS-PGHOST-NAME UPON ENVIRONMENT-NAME
           DISPLAY WS-PGHOST-VALUE UPON ENVIRONMENT-VALUE
           DISPLAY WS-PGPORT-NAME UPON ENVIRONMENT-NAME
           DISPLAY WS-PGPORT-VALUE UPON ENVIRONMENT-VALUE
           DISPLAY WS-PGUSER-NAME UPON ENVIRONMENT-NAME
           DISPLAY WS-PGUSER-VALUE UPON ENVIRONMENT-VALUE
           DISPLAY WS-PGPASSWORD-NAME UPON ENVIRONMENT-NAME
           DISPLAY WS-PGPASSWORD-VALUE UPON ENVIRONMENT-VALUE
           DISPLAY WS-PGDATABASE-NAME UPON ENVIRONMENT-NAME
           DISPLAY WS-PGDATABASE-VALUE UPON ENVIRONMENT-VALUE
           .

       DAL-CONNECT.
           IF NOT WS-CONNECTED
               PERFORM DAL-SET-ENV
               CALL "OCESQLStartSQL" END-CALL
               CALL "OCESQLConnect" USING
                   BY REFERENCE SQLCA
                   BY REFERENCE WS-DB-USER
                   BY VALUE WS-DB-USER-LEN
                   BY REFERENCE WS-DB-PASSWORD
                   BY VALUE WS-DB-PASSWORD-LEN
                   BY REFERENCE WS-DB-NAME
                   BY VALUE WS-DB-NAME-LEN
               END-CALL
               CALL "OCESQLEndSQL" END-CALL

               IF SQLCODE = 0
                   SET WS-CONNECTED TO TRUE
                   DISPLAY 'Connexion DB reussie: empdb'
               ELSE
                   DISPLAY 'ERREUR CONNECT: SQLCODE=' SQLCODE
                   DISPLAY 'SQLSTATE=' SQLSTATE
                   DISPLAY 'SQLERRMC=' SQLERRMC
               END-IF
           END-IF
           .

       DAL-READ.
           IF NOT WS-CURSOR-OPEN
               EXEC SQL
                   DECLARE C_EMP CURSOR FOR
                   SELECT EMP_ID, EMP_NAME, SALARY_BRUT, SALARY_NET
                   FROM EMPLOYEE
                   ORDER BY EMP_ID
               END-EXEC

               EXEC SQL
                   OPEN C_EMP
               END-EXEC

               IF SQLCODE NOT = 0
                   DISPLAY 'ERREUR OPEN: SQLCODE=' SQLCODE
                   MOVE 'Y' TO LK-END-OF-FILE
                   EXIT PARAGRAPH
               END-IF

               SET WS-CURSOR-OPEN TO TRUE
               DISPLAY 'Curseur C_EMP ouvert'
           END-IF

           EXEC SQL
               FETCH C_EMP INTO
                   :WS-EMP-ID,
                   :WS-EMP-NAME,
                   :WS-SALARY-BRUT,
                   :WS-SALARY-NET
           END-EXEC

           EVALUATE SQLCODE
               WHEN 0
                   MOVE 'N' TO LK-END-OF-FILE
                   MOVE WS-EMP-ID TO LK-EMP-ID
                   MOVE WS-EMP-NAME TO LK-EMP-NAME
                   MOVE WS-SALARY-BRUT TO LK-SALARY-BRUT
                   MOVE WS-SALARY-NET TO LK-SALARY-NET
               WHEN 100
                   MOVE 'Y' TO LK-END-OF-FILE
               WHEN OTHER
                   DISPLAY 'ERREUR FETCH: SQLCODE=' SQLCODE
                   DISPLAY 'SQLSTATE=' SQLSTATE
                   MOVE 'Y' TO LK-END-OF-FILE
           END-EVALUATE
           .

       DAL-SAVE.
           MOVE LK-EMP-ID TO WS-EMP-ID
           MOVE LK-SALARY-NET TO WS-SALARY-NET

           EXEC SQL
               UPDATE EMPLOYEE
               SET SALARY_NET = :WS-SALARY-NET
               WHERE EMP_ID = :WS-EMP-ID
           END-EXEC

           IF SQLCODE NOT = 0
               DISPLAY 'ERREUR UPDATE: SQLCODE=' SQLCODE
               DISPLAY 'SQLSTATE=' SQLSTATE
               DISPLAY 'EMP_ID=' LK-EMP-ID
           END-IF
           .

       DAL-END.
           IF WS-CURSOR-OPEN
               EXEC SQL
                   CLOSE C_EMP
               END-EXEC

               IF SQLCODE NOT = 0
                   DISPLAY 'ERREUR CLOSE: SQLCODE=' SQLCODE
               END-IF

               MOVE 'N' TO WS-CURSOR-OPEN-FLAG
           END-IF

           IF WS-CONNECTED
               EXEC SQL
                   COMMIT
               END-EXEC

               IF SQLCODE NOT = 0
                   DISPLAY 'ERREUR COMMIT: SQLCODE=' SQLCODE
               END-IF

               EXEC SQL
                   DISCONNECT ALL
               END-EXEC

               IF SQLCODE NOT = 0
                   DISPLAY 'ERREUR DISCONNECT: SQLCODE=' SQLCODE
               END-IF

               MOVE 'N' TO WS-CONNECTED-FLAG
               DISPLAY 'Fermeture connexion'
           END-IF
           .